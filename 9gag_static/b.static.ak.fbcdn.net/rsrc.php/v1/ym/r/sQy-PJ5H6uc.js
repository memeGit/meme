/*1328632457,169775557*/

if (window.CavalryLogger) { CavalryLogger.start_js(["lLzkn"]); }

function AlbumScroller(){}AlbumScroller.prototype={init:function(a,b){this.photoGroups={};this.scrollListener={};if(a.length){var c=a.shift(),d=c,e=0,f=c.id;while(d){if(!this.photoGroups[f])this.photoGroups[f]=[];var g=DOM.scry(d,'a.uiScrollableThumb');if(g.length>0)this.photoGroups[f].push(g[0]);d=this.getNextPhotoCell(d);if(++e%b==0){this.scrollListener[f]=new OnVisible(c,this.showPage.bind(this,c));c=a.shift();if(c)f=c.id;}}if(c)this.scrollListener[f]=new OnVisible(c,this.showPage.bind(this,c));}},showPage:function(a){var b=this.photoGroups[a.id];if(b)for(var c=0,d=b.length;c<d;c++)DOM.find(b[c],'i').style.backgroundImage='url('+b[c].getAttribute('data-src')+')';},getNextPhotoCell:function(a){var b=null;if(a.nextSibling){b=a.nextSibling;}else if(a.parentNode.nextSibling)b=a.parentNode.nextSibling.firstChild;if(b&&b.childElementCount!==0)return b;return null;}};
function Token(a,b){this.info=a;this.paramName=b;}Token.prototype={getInfo:function(){return this.info;},getText:function(){return this.info.text;},getValue:function(){return this.info.uid;},isFreeform:function(){return !!this.info.freeform;},getElement:function(){if(!this.element)this.setElement(this.createElement());return this.element;},setElement:function(a){DataStore.set(a,'Token',this);this.element=a;return this;},isRemovable:function(){return CSS.hasClass(this.element,'removable');},createElement:function(){var a=this.paramName,b=this.getText(),c=this.getValue(),d=$N('a',{href:'#',title:tx._("\u5220\u9664{item}",{item:b}),className:'remove uiCloseButton uiCloseButtonSmall'}),e=$N('input',{type:'hidden',value:c,name:a+'[]',autocomplete:'off'}),f=$N('input',{type:'hidden',value:b,name:'text_'+a+'[]',autocomplete:'off'}),g=$N('span',{title:b,className:'removable uiToken'},[b,e,f,d]);return g;}};
function Tokenizer(a,b){this.element=a;this.typeahead=b;this.input=b.getCore().getElement();DataStore.set(this.element,'Tokenizer',this);}Tokenizer.getInstance=function(a){var b=Parent.byClass(a,'uiTokenizer');return b?DataStore.get(b,'Tokenizer'):null;};Class.mixin(Tokenizer,'Arbiter',{inline:false,maxTokens:null,excludeDuplicates:true,placeholder:'',init:function(a,b,c,d){this.init=bagofholding;this.tokenarea=a;this.paramName=b;this.placeholder=this.input.getAttribute('data-placeholder')||'';copy_properties(this,d||{});this.initEvents();this.initTypeahead();this.reset(c);this.initBehaviors();Arbiter.inform('Tokenizer/init',this,Arbiter.BEHAVIOR_PERSISTENT);},reset:function(a){this.tokens=[];this.unique={};if(a){this.populate(a);}else DOM.empty(this.tokenarea);this.updateTokenarea();},populate:function(a){var b=[];this.tokens=this.getTokenElements().map(function(c,d){var e=a[d];b.push(this._tokenKey(e));return this.createToken(e,c);},this);this.unique=Object.from(b,this.tokens);},getElement:function(){return this.element;},getTypeahead:function(){return this.typeahead;},getInput:function(){return this.input;},initBehaviors:function(){for(var a in (this.behaviors||{})){var b=window.TokenizerBehaviors&&TokenizerBehaviors[a];b.call(null,this,this.behaviors[a]);}},initTypeahead:function(){var a=this.typeahead.getCore();a.resetOnSelect=true;a.setValueOnSelect=false;a.preventFocusChangeOnTab=true;if(this.inline){var b=this.typeahead.getView();CSS.addClass(b.getElement(),'uiInlineTokenizerView');}this.typeahead.subscribe('select',function(c,d){var e=d.selected;if('uid' in e){this.updateInput();this.addToken(this.createToken(e));}}.bind(this));this.typeahead.subscribe('blur',this.handleBlur.bind(this));},handleBlur:function(event){this.inform('blur',{event:event});this.updatePlaceholder();},initEvents:function(){var a=this.handleEvents.bind(this),b=ua.firefox()<4?'keypress':'keydown';Event.listen(this.tokenarea,{click:a,keydown:a});Event.listen(this.input,'paste',this.paste.bind(this));Event.listen(this.input,b,this.keydown.bind(this));},handleEvents:function(event){var a=event.getTarget(),b=a&&this.getTokenElementFromTarget(a);if(!b)return;if(event.type!='keydown'||Event.getKeyCode(event)==KEYS.RETURN)this.processEvents(event,a,b);},processEvents:function(event,a,b){if(Parent.byClass(a,'remove')){var c=b.nextSibling;c=c&&DOM.scry(b.nextSibling,'.remove')[0];var d=this.getTokenFromElement(b);d=this.addTokenData(d,a);this.removeToken(d);this.focusOnTokenRemoval(event,c);event.kill();}},focusOnTokenRemoval:function(event,a){Input.focus(event.type=='keydown'&&a||this.input);},addTokenData:function(a,b){return a;},keydown:function(event){this.inform('keydown',{event:event});var a=Event.getKeyCode(event),b=this.input;if(this.inline&&a==KEYS.BACKSPACE&&Input.isEmpty(b)){var c=this.getLastToken();if(c&&c.isRemovable())this.removeToken(c);}this.updateInput();},paste:function(event){this.inform('paste',{event:event});this.updateInput(true);},focusInput:function(){Input.focus(this.input);},updateInput:function(a){if(!this.inline)return;var b=this.input;setTimeout(function(){b.size=b.value.length||1;if(a)b.value=b.value;},20);},updatePlaceholder:function(){if(!this.inline||this.stickyPlaceholder)return;var a=!this.tokens.length;this.input.size=a?this.placeholder.length*2||1:1;Input.setPlaceholder(this.input,a?this.placeholder:'');},getToken:function(a){return this.unique[a]||null;},getTokens:function(){return this.tokens;},getTokenElements:function(){return DOM.scry(this.tokenarea,'span.uiToken');},getTokenElementFromTarget:function(a){return Parent.byClass(a,'uiToken');},getTokenFromElement:function(a){return DataStore.get(a,'Token');},getTokenValues:function(){return this.tokens.map(function(a){return a.getValue();});},getFirstToken:function(){return this.tokens[0]||null;},getLastToken:function(){return this.tokens[this.tokens.length-1]||null;},hasMaxTokens:function(){return this.maxTokens&&this.maxTokens<=this.tokens.length;},createToken:function(a,b){var c=this.getToken(this._tokenKey(a));c=c||new Token(a,this.paramName);b&&c.setElement(b);return c;},addToken:function(a){if(this.hasMaxTokens())return;var b=this._tokenKey(a.getInfo());if(b in this.unique)return;this.unique[b]=a;this.tokens.push(a);this.insertToken(a);this.updateTokenarea();this.inform('addToken',a);Arbiter.inform('Form/change',{node:this.element});},insertToken:function(a){DOM.appendContent(this.tokenarea,a.getElement());},removeToken:function(a){if(!a)return;var b=this.tokens.indexOf(a);if(b<0)return;this.tokens.splice(this.tokens.indexOf(a),1);delete this.unique[this._tokenKey(a.getInfo())];DOM.remove(a.getElement());this.updateTokenarea();this.inform('removeToken',a);Arbiter.inform('Form/change',{node:this.element});},removeAllTokens:function(){this.reset();this.inform('removeAllTokens');},updateTokenarea:function(){var a=this.typeahead.getCore(),b=this.getTokenValues();if(this.excludeDuplicates){this._exclusions||(this._exclusions=a.getExclusions());a.setExclusions(b.concat(this._exclusions));}a.setEnabled(!this.hasMaxTokens());this.updateTokenareaVisibility();this.updatePlaceholder();},updateTokenareaVisibility:function(){CSS.conditionShow(this.tokenarea,this.tokens.length!==0);},_tokenKey:function(a){return a.uid+(a.freeform?':':'');}});
function TagTypeaheadView(a,b){this.parent.construct(this,a,b);this.hintText=b.hintText;this.origAutoSelect=b.autoSelect;this.setSuggestions(b.suggestions);}Class.extend(TagTypeaheadView,'TypeaheadView');TagTypeaheadView.prototype={buildResults:function(a){if(!this.value)a.unshift({subtext:this.hintText,type:'hintText'});var b=this.parent.buildResults(a);if(!this.value)a.shift();return b;},render:function(a,b,c){this.autoSelect=this.origAutoSelect&&a.length;this.disableAutoSelect=a.length===0;this.parent.render(a,b,c);},getItems:function(){var a=this.parent.getItems();if(!this.value)a.shift();return a;},getSuggestions:function(){return this.suggestions;},setSuggestions:function(a){this.suggestions=a||[];this.visible=!!this.suggestions;},addSuggestion:function(a){this.suggestions.unshift(a);}};
function PhotoBulkEditTokenizer(a,b){this.parent.construct(this,a,b);}Class.extend(PhotoBulkEditTokenizer,'Tokenizer');PhotoBulkEditTokenizer.INITIALIZED='initialized';PhotoBulkEditTokenizer.SWITCH_TARGET='switchTarget';PhotoBulkEditTokenizer.prototype={init:function(a,b,c,d){this._tokenareaListeners={};this.parent.init(a,b,c,d);this.inform(PhotoBulkEditTokenizer.INITIALIZED);},initEvents:function(){var a=ua.firefox()<4?'keypress':'keydown';Event.listen(this.input,'paste',this.paste.bind(this));Event.listen(this.input,a,this.keydown.bind(this));},setTokenarea:function(a){this.tokenarea=a;this.addTokenareaListener(a);this.reset();},addTokenareaListener:function(a){if(this._tokenareaListeners[a.id])return;var b=this.handleEvents.bind(this);this._tokenareaListeners[a.id]=values(Event.listen(a,{click:b,keydown:b}));},handleEvents:function(event){var a=Parent.byClass(event.getTarget(),'editablePhotoTagList');if(!a){return;}else if(this.tokenarea!==a){this.setTokenarea(a);this.inform(PhotoBulkEditTokenizer.SWITCH_TARGET,this.tokenarea.id);}return this.parent.handleEvents(event);},reset:function(){var a=this.getTokenElements().map(function(b){return {uid:DOM.scry(b,'input')[0].value,text:DOM.scry(b,'input')[1].value};});Input.reset(this.input);return this.parent.reset(a);},updateTokenareaVisibility:function(){return null;},insertToken:function(a){DOM.prependContent(this.tokenarea,a.getElement());}};
function PhotoBulkEditTagger(a){this.parent.construct(this,a);}Class.extend(PhotoBulkEditTagger,'PhotoTagger');PhotoBulkEditTagger.DATA_SOURCE_READY='PhotoBulkEditTagger/datasourceReady';PhotoBulkEditTagger.TAG_SAVED='PhotoBulkEditTagger/tagSaved';copy_properties(PhotoBulkEditTagger.prototype,{TAG_BOX_SIZE:60,elemNames:{},init:function(a,b,c,d,e){this._qn=e;this.photoOwner=a;this.tokenizer=d;this.editor=b;this.editor.registerTagger(this);this.root=this.editor.getRoot();this.tagger=c;this.hideNewTagTimer=null;this.photoKey=null;this._needTaggingData=true;this.setupHandlers();this._sendWaterfallLogSignal(PhotosTaggingWaterfall.BEGIN);return this;},setupUserActionLogging:function(){return null;},logUserActionEvent:function(a){return null;},saveTag:function(a,b){this.parent.saveTag(a,b);Arbiter.inform(PhotoBulkEditTagger.TAG_SAVED,{editor:this.root,fbid:this.photoData.fbid});},setNeedTaggingData:function(a){this._needTaggingData=a;return this;},needTaggingData:function(){return this._needTaggingData;},setupHandlers:function(){Event.listen(this.root,'click',this.clickHandler.bind(this));this.tokenizer.subscribe(['addToken','removeToken'],this.handleTokenAction.bind(this));this.tokenizer.subscribe(PhotoBulkEditTokenizer.SWITCH_TARGET,this.switchPhoto.bind(this));Arbiter.subscribe(PhotoBulkEditTagger.DATA_SOURCE_READY,this.useTaggingDataSource.bind(this));},done:function(){this._sendWaterfallLogSignal(PhotosTaggingWaterfall.FINISH);},handleTokenAction:function(a,b){var c=$(this.photoKey),d=DOM.find(c,'.peopleIcon'),e=DOM.find(c,'.editablePhotoTagList'),f=DOM.find(d,'.count'),g=this.tokenizer.getTokens().length;CSS.conditionClass(d,'hasPeople',!!g);CSS.conditionClass(e,'hasPeople',!!g);DOM.setContent(f,g);if(a=='addToken'){this.saveTag(a,b);}else this.removeTag(a,b);},updateWithSuggestions:function(){},useTaggingDataSource:function(a,b){if(!this._needTaggingData)return;var c=this.tokenizer.getTypeahead();c.swapData(b);this.setNeedTaggingData(false);},getTaggerPositioningOrigin:function(){return Vector2.getElementPosition(this.root);},clickHandler:function(event){var a=event.getTarget();if(Parent.byClass(a,'photoTagTypeahead'))return;if(Parent.byClass(a,'photoContextualSelector')||Parent.byClass(a,'removePhotoButton')){this.hideTagger();return;}var b=Parent.byClass(a,'editablePhotoImage');if(!b){var c=Parent.byClass(a,'peopleIcon');if(c){this.setupPhotoDataForTarget(c);this.hideTagger();return;}var d=Parent.byClass(a,'bulkEditTagger');if(d&&this.photoData.fbid&&this.getImageByID(this.photoData.fbid)){b=this.getImageByID(this.photoData.fbid);}else{this.hideTagger();return;}}this.setupPhotoDataForTarget(b);var e=DOM.find(b,'img'),f=Vector2.getEventPosition(event),g=this.calcTaggerPosition(e,f);if(!g)return;this.calcClickPoint(e,f);g.setElementPosition(this.tagger);var h=Parent.byClass(a,'recognitionBox');h&&CSS.hide(h);CSS.hide(DOM.find(b,'.clickToTagMessage'));this._sendWaterfallLogSignal(PhotosTaggingWaterfall.TAG_FACE);this.showTagger();},switchPhoto:function(a,b){var c=ge(b);c&&this.setupPhotoDataForTarget(c);this.hideTagger();},getImageByID:function(a){return ge('editablePhoto_'+a);},getTaggingSource:function(){if(this.version===PhotosConst.BULK_EDITOR){return 'bulk_editor';}else if(this.version===PhotosConst.FLASH_UPLOADER){return 'flash_uploader';}else return null;},setupPhotoDataForTarget:function(a){var b;if(a&&!CSS.hasClass(a,'editablePhoto')){b=Parent.byClass(a,'editablePhoto');}else b=a;if(!b){this.photoKey=null;this.photoData=null;return false;}var c=b.id;if(c===this.photoKey)return;this.photoKey=c;this.photoData=this.editor.getPhotoData(c);this.tokenizer.setTokenarea(DOM.find(b,'div.editablePhotoTagList'));},getPosition:function(){return this.photoData.fbid;},tagsChangeHandler:function(a){},removeTagByID:function(a,b,c){this.hideTagger();this.setupPhotoDataForTarget(this.getImageByID(a));this.parent.removeTagByID(a,b,c);}});
var PhotosBulkBackdateEditor=(function(){return {setup:function(a,b){b.setContext(a);Event.listen(a,'click',function(){b.show();});var c=DOM.find(b.getContent(),"^.photosBulkDatePicker .saveBackdatedTime");Event.listen(c,'click',function(){var d=Form.serialize(b.getContent()).backdated_date;Arbiter.inform(PhotosBulkBackdateEditor.SAVED,{context:a,backdatedDate:d});b.hide();});}};})();PhotosBulkBackdateEditor.SAVED="PhotosBulkBackdateEditor.SAVED";
function PhotosBulkEditablePhoto(){}PhotosBulkEditablePhoto.prototype={init:function(a,b,c,d){this._root=a;this._mentionsTypeahead=b;this._placesTypeahead=c;this._photoData=d;this._hasOwnPlaceValue=!!c.getCore().getHiddenValue();var e=DOM.find(a,'.placesInput'),f=DOM.find(a,'.captionTextarea');this._metadataInputs=DOM.find(a,'.metadataInputs');this._photoDataKey=this._root.id;this._listeners=[Event.listen(a,'click',this._handleClick.bind(this)),Event.listen(e,'focus',this._placesFocus.bind(this)),Event.listen(f,'focus',this._captionFocus.bind(this)),Event.listen(f,'blur',this._save.bind(this)),Event.listen(a,'submit',function(){return false;})];var g=DOM.scry(a,'.photoContextualSelector')[0];if(g){var h=DOM.scry(g,'.moveAlbum')[0];h&&this._listeners.push(Event.listen(h,'click',this._move.bind(this)));}else{var i=DOM.find(a,'.removePhotoButton');this._listeners.push(Event.listen(i,'click',this.remove.bind(this)));}this._placesDataListener=c.subscribe(['select','reset','render'],function(j,k){if(j=='render'){CSS.addClass(this._root,'focusedInput');return;}if(j=='reset'&&c.getCore().getHiddenValue())return;this._hasOwnPlaceValue=j=='select';CSS.conditionClass(DOM.find(a,'.placeIcon'),'hasPlace',this._hasOwnPlaceValue);CSS.removeClass(this._root,'focusedInput');this._save();}.bind(this));this._placesInputBlurListener=c.getCore().subscribe('blur',function(j,k){CSS.removeClass(this._root,'focusedInput');}.bind(this));Arbiter.inform(PhotosBulkEditablePhoto.INITIALIZED,this);},getPhotoDataKey:function(){return this._photoDataKey;},getPhotoData:function(){return this._photoData;},getRoot:function(){return this._root;},swapData:function(a,b){var c=this._mentionsTypeahead.getData(),d=this._placesTypeahead.getData();if(c!==a)this._mentionsTypeahead.swapData(a);if(d!==b){var e=this._placesTypeahead.getCore().getValue(),f=this._placesTypeahead.getCore().getHiddenValue();this._placesTypeahead.swapData(b);if(this.hasOwnPlaceValue())this._placesTypeahead.getCore().select({text:e,uid:f});}},hasOwnPlaceValue:function(){return this._hasOwnPlaceValue;},setAlbumPlace:function(a){this._hasOwnPlaceValue=false;var b=this._placesTypeahead.getCore();CSS.conditionClass(DOM.find(this._root,'.placeIcon'),'hasPlace',!!a);if(a){b.select(a);this._save();}else b.reset();},_doRemove:function(){this._listeners.each(function(a){a.remove();});this._listeners=[];this._placesTypeahead.unsubscribe(this._placesDataListener);this._placesTypeahead.getCore().unsubscribe(this._placesInputBlurListener);DOM.remove(this._root);Arbiter.inform(PhotosBulkEditablePhoto.REMOVED,this);},_handleClick:function(a){var b=a.getTarget();if(Parent.byClass(b,'confirmPhotoBackdate')){this._saveDate();return;}if(!Parent.byClass(b,'metaIcon'))return;CSS.addClass(this._root,'showControls');if(Parent.byClass(b,'placeIcon')){this._showMetadataInput('place');Input.focus(this._placesTypeahead.getCore().getElement());}else if(Parent.byClass(b,'dateIcon')){this._showMetadataInput('date');}else if(Parent.byClass(b,'peopleIcon')){this._showMetadataInput('people');}else CSS.removeClass(this._root,'showControls');},hideMetadataInputs:function(){this._showMetadataInput();},_showMetadataInput:function(a){['people','date','place'].each(function(b){CSS.conditionClass(this._metadataInputs,b,a==b);}.bind(this));},_captionFocus:function(a){this.hideMetadataInputs();CSS.addClass(this._root,'focusedInput');},remove:function(){var a={fbid:this._photoData.fbid,version:PhotosConst.BULK_EDITOR,confirmed:true};new Dialog().setTitle("\u5220\u9664\u7167\u7247").setBody("\u786e\u5b9a\u5220\u9664\u6b64\u7167\u7247\uff1f").setButtons(Dialog.OK_AND_CANCEL).setModal(true).setHandler(function(){CSS.addClass(this._root,'editablePhotoWillBeRemoved');new AsyncRequest().setURI('ajax/photos/photo/delete/dialog.php').setData(a).setHandler(function(b){if(b.getPayload().success){this._doRemove();}else CSS.removeClass(this._root,'editablePhotoWillBeRemoved');}.bind(this)).setErrorHandler(function(b){CSS.removeClass(this._root,'editablePhotoWillBeRemoved');AsyncResponse.defaultErrorHandler(b);}.bind(this)).send();}.bind(this)).show();},_move:function(){var a={aid:this._photoData.aid,datakey:this._photoDataKey,fbid:this._photoData.fbid,owner:this._photoData.owner,pid:this._photoData.pid};new AsyncRequest().setURI('ajax/photos/photo/move/dialog.php').setData(a).setAllowCrossPageTransition(false).send();},_placesFocus:function(a){CSS.addClass(this._root,'focusedInput');var b=DOM.scry(this._root,'input.latitude')[0],c=DOM.scry(this._root,'input.longitude')[0];if(b&&c)this._placesTypeahead.getData().setQueryData({latitude:Input.getValue(b),longitude:Input.getValue(c)},false);},_saveDate:function(){var a=DOM.find(this._root,'div.backdateInput'),b=Form.serialize(a);b.fbid=this._photoData.fbid;b.version=PhotosConst.BULK_EDITOR;CSS.addClass(a,'backdating');new AsyncRequest().setURI('ajax/photos/photo/backdate/default.htm').setData(b).setRelativeTo(this._root).send();},_save:function(){CSS.removeClass(this._root,'focusedInput');new AsyncRequest().setURI('ajax/photos/metadata/save/default.htm').setData(Form.serialize(this._root)).setAllowCrossPageTransition(true).send();}};copy_properties(PhotosBulkEditablePhoto,{INITIALIZED:'PhotosBulkEditablePhoto/initialized',REMOVED:'PhotosBulkEditablePhoto/removed',MOVED:'PhotosBulkEditablePhoto/moved'});
function BulkTagLoader(){}copy_properties(BulkTagLoader,{_requested:false,loadForSet:function(a){if(!BulkTagLoader._requested){BulkTagLoader._requested=true;new AsyncRequest('ajax/photos/sets/tags_fetch.php').setHandler(bagofholding).setData({set:a}).send();}},loadForAlbum:function(a){if(!BulkTagLoader._requested){BulkTagLoader._requested=true;new AsyncRequest('ajax/photos/album/tags_fetch.php').setHandler(bagofholding).setData({fbid:a}).send();}},reset:function(){BulkTagLoader._requested=false;}});
var MediaSetLikeButtonController={submit:function(){$('mediaSetUfiLikeLink').firstChild.click();CSS.hide($('mediaSetLikeButton'));}};
function PhotosUploadWaterfall(a){PhotosUploadWaterfall._queueName=a||PhotosUploadWaterfall._queueName;if(PhotosUploadWaterfall._inited)return;Arbiter.subscribe('fbplugin/log',function(b,c){c.qn=PhotosUploadWaterfall._queueName;PhotosUploadWaterfall.sendSignal(c);});PhotosUploadWaterfall._inited=true;}copy_properties(PhotosUploadWaterfall,{INSTALL_CANCEL:1,INSTALL_INSTALL:2,INSTALL_UPDATE:3,INSTALL_REINSTALL:4,INSTALL_PERMA_CANCEL:5,INSTALL_SILENT_SKIP:6,INSTALL_DOWNLOAD:7,BEGIN:1,INSTALL:2,READY:3,UPLOAD_START:4,ALL_UPLOADS_DONE:6,IMAGES_SELECTED:9,PROCESSING_DONE:10,UPGRADE_REQUIRED:11,UPGRADE_CLICK:12,PAGE_RENDERED:13,PRELOAD_CLICK:14,VERSION:15,COMPRESSOR_READY:17,CANCEL:22,MULLIGAN2_INSTALL_START:31,MULLIGAN2_INSTALL_SUCCESS:32,MULLIGAN2_INSTALL_FAIL:33,MULLIGAN2_UPLOAD_FAIL:35,MULLIGAN2_INSTALL_WAIT_TIMEOUT:36,MULLIGAN2_UPLOAD_RETRYING:37,MULLIGAN2_UPLOAD_CANCELED:38,UPLOAD_STARTED:43,PROGRESS_BAR_STOPPED:44,MISSED_BEAT:45,HEART_ATTACK:46,_inited:false,_queueName:null,sendSignal:function(a,b){new AsyncSignal('ajax/photos/waterfall.php',{data:JSON.stringify(a)}).setHandler(b).send();}});function photos_log_simple_upload_start(a,b){var c={qn:a,step:PhotosUploadWaterfall.UPLOAD_START,count:b,simple:true};PhotosUploadWaterfall.sendSignal(c);}function photos_log_composer_start(a){PhotosUploadWaterfall.sendSignal({qn:a,step:PhotosUploadWaterfall.UPLOAD_START,comp:true});}
var UploadEvent={DONE:'UploadEvent/DONE',ERROR:'UploadEvent/ERROR',FINISHED_UPLOADING:'UploadEvent/FINISHED_UPLOADING',LOADED:'UploadEvent/LOADED',READY:'UploadEvent/READY',UPLOAD_FAILED:'UploadEvent/UPLOAD_FAILED',UPLOAD_PROGRESS:'UploadEvent/UPLOAD_PROGRESS',COMPRESS_PROGRESS:'UploadEvent/COMPRESS_PROGRESS',HI_RES_ATTACH_START:'UploadEvent/HI_RES_ATTACH_START',IMAGE_COMPRESS_ERROR:'UploadEvent/IMAGE_COMPRESS_ERROR',IMAGE_COMPRESSED:'UploadEvent/IMAGE_COMPRESSED',IMAGE_UPLOAD_ERROR:'UploadEvent/IMAGE_UPLOAD_ERROR',IMAGE_UPLOADED:'UploadEvent/IMAGE_UPLOADED',IMAGES_SELECTED:'UploadEvent/IMAGES_SELECTED',SELECT_CANCELED:'UploadEvent/SELECT_CANCELED',SELECT_DOWN:'UploadEvent/SELECT_DOWN',SELECT_OUT:'UploadEvent/SELECT_OUT',SELECT_OVER:'UploadEvent/SELECT_OVER',SELECT_UP:'UploadEvent/SELECT_UP',HEARTBEAT:'UploadEvent/HEARTBEAT'};
function FlashUploadController(a,b,c,d,e){FlashUploadController.init();copy_properties(this,{_isRecognitionFinished:false,_flashIDs:[],_initialMaxSelectable:b.maxSelectable,_addedPostParams:[],_queue_name:b.qn,_on_flash_error:c,_albumLimitExceeded:0,_uploading:false,_heartbeats:{},_stopHeartbeat:false,_isReady:false,_errors:[],_subscriptions:[],_recognitionConfig:{pollAttempts:b.recognitionPollAttempts,pollPeriod:b.recognitionPollPeriod,url:b.recognitionUrl,aid:b.aid,owner:b.owner},_flashStats:{},_uploaderName:b.uploaderName});this.registerSwf(a);if(!this.checkMinimumFlash(b.flashVersionInfo.minimumVersion)){PhotosUploadWaterfall.sendSignal({qn:b.qn,step:PhotosUploadWaterfall.UPGRADE_REQUIRED,uploader:this._uploaderName});d&&d(FlashUploadController.ERROR_FLASH_UPGRADE_REQUIRED);return;}[Flash.READY,Flash.FAILED,UploadEvent.DONE,UploadEvent.ERROR,UploadEvent.FINISHED_UPLOADING,UploadEvent.IMAGES_SELECTED,UploadEvent.READY,UploadEvent.UPLOAD_FAILED,UploadEvent.UPLOAD_PROGRESS,UploadEvent.HEARTBEAT].each(this._subscribe.bind(this,Arbiter.SUBSCRIBE_ALL));var f=Arbiter.subscribe('page_transition',function(){this.destroy();Arbiter.unsubscribe(f);}.bind(this),Arbiter.SUBSCRIBE_NEW);if(!this.checkMinimumFlash([b.flashVersionInfo.latestVersion]))e&&e();window.setTimeout(function(){if(!this._isReady)c(FlashUploadController.ERROR_FLASH_LOAD_TIMEOUT);}.bind(this),b.flashLoadTimeout);}copy_properties(FlashUploadController,{ERROR_FLASH_LOAD_TIMEOUT:1,ERROR_FLASH_LOAD_FAILURE:2,ERROR_FLASH_UPGRADE_REQUIRED:3,_inited:false,init:function(){if(this._inited)return;this._inited=true;}});copy_properties(FlashUploadController.prototype,{destroy:function(){while(this._subscriptions.length)Arbiter.unsubscribe(this._subscriptions.pop());},_subscribe:function(a,b){this._subscriptions.push(Arbiter.subscribe(b,this.arbiterFilter.bind(this),a));},registerSwf:function(a){if(!this._flashIDs.contains(a)){this._flashIDs.push(a);this._flashStats[a]=null;}},_sumStat:function(a){var b=0;values(this._flashStats).each(function(c){if(c&&c[a])b+=c[a];});return b;},getMaxSelectable:function(){if(this._initialMaxSelectable===-1)return -1;var a=this._initialMaxSelectable-this.getImagesSelected()+this.getImagesFailed();return Math.max(a,0);},getImagesUploaded:function(){return this._sumStat('filesUploaded');},getImagesFailed:function(){return this._sumStat('filesFailed');},getImagesSelected:function(){return this._sumStat('totalFiles');},isAlbumLimitExceeded:function(){return this._albumLimitExceeded;},isReady:function(){return this._isReady;},isUploading:function(){return this._uploading;},getPercentComplete:function(){var a=this._sumStat('originalFileBytesUploaded'),b=this._sumStat('totalOriginalFileBytes');return a/b*100;},getErrors:function(){return this._errors;},checkMinimumFlash:function(a){var b=deconcept.SWFObjectUtil.getPlayerVersion();if(!(a instanceof Array))a=[a];var c,d;for(d=0;d<a.length;++d){c=new deconcept.PlayerVersion(a[d].toString().split('.'));if(b.versionIsValid(c))return true;}return false;},setAid:function(a){this._flash().setAid(a);this._recognitionConfig.aid=a;},handleImagesSelected:function(a){this._albumLimitExceeded=a.maxReached;this._flashStats[a.divID]=a.stats;this._callAllSWFs(true,'setMaxSelectable',this.getMaxSelectable());PhotosUploadWaterfall.sendSignal({qn:this._queue_name,step:PhotosUploadWaterfall.IMAGES_SELECTED,count:a.count,uploader:this._uploaderName});},addPostParam:function(a,b){this._addedPostParams.push({name:a,value:b});this._flashIDs.each(function(c,d){var e=this._flash(d);e.addPostParam&&e.addPostParam(a,b);}.bind(this));},markDeleted:function(a){this._callAllSWFs(false,'markDeleted',a);this.refreshStats();this._callAllSWFs(false,'setMaxSelectable',this.getMaxSelectable());},isEventIntendedForMe:function(a){return 'divID' in a&&this._flashIDs.contains(a.divID);},arbiterFilter:function(a,b){if(!this.isEventIntendedForMe(b))return;switch(a){case Flash.FAILED:this.handleFlashFailed();return;case Flash.READY:this.handleFlashReady.bind(this,b).defer();return;case UploadEvent.UPLOAD_FAILED:this._uploading=false;return;case UploadEvent.IMAGES_SELECTED:this.handleImagesSelected(b);return;case UploadEvent.FINISHED_UPLOADING:this.handleFinishedUploading(b);return;case UploadEvent.ERROR:this._errors.push(b.metrics);this._flashStats[b.divID]=b.stats;this._callAllSWFs(true,'setMaxSelectable',this.getMaxSelectable());return;case UploadEvent.UPLOAD_PROGRESS:this._flashStats[b.divID]=b.stats;return;case UploadEvent.HEARTBEAT:this._heartbeats[b.divID]={stamp:b.timestamp,timer:null};return;default:return;}},handleFinishedUploading:function(a){this._uploading=false;if(this.uploadImages())return;PhotosUploadWaterfall.sendSignal({qn:this._queue_name,step:PhotosUploadWaterfall.ALL_UPLOADS_DONE,uploader:this._uploaderName});if(this._frecId&&this._recognitionConfig.url&&!this._recognitionStarted){this._recognitionStarted=true;this.startRecognition();}else this.recognitionFinished();},recognitionFinished:function(){this._isRecognitionFinished=true;Arbiter.inform(UploadEvent.DONE,{divID:this._flashIDs[0]});},isRecognitionFinished:function(){return this._isRecognitionFinished;},handleFlashReady:function(a){if(!this._isReady)this._isReady=true;var b=this._flash(this._flashIDs.indexOf(a.divID));this._addedPostParams.each(function(c){b.addPostParam(c.name,c.value);});this._callAllSWFs(true,'setMaxSelectable',this.getMaxSelectable());Arbiter.inform(UploadEvent.READY,a);this._heartbeats[a.divID]={stamp:+new Date(),timer:null};this._heartbeat(a.divID);},_heartbeat:function(a){if(this._stopHeartbeat)return;var b=7500,c=+new Date();this._heartbeats[a].stamp<(c-b*2);this._heartbeats[a].timer&&clearTimeout(this._heartbeats[a].timer);this._heartbeats[a].timer=this._heartbeat.bind(this,a).defer(b,true);try{this._flash(this._flashIDs.indexOf(a)).heartbeat(c);}catch(d){}},handleFlashFailed:function(){if(this._on_flash_error)this._on_flash_error(FlashUploadController.ERROR_FLASH_LOAD_FAILURE);},_callAllSWFs:function(a,b){var c=$A(arguments).slice(2,arguments.length);for(var d=0;d<this._flashIDs.length;d++){var e=this._flash(d),f=e[b];if(typeof f!=='function')continue;if(a){(function(h,i){try{h.apply(i,c);}catch(j){}}).bind(this,f,e).defer();}else try{f.apply(e,c);}catch(g){}}},_flash:function(a){var b=this._flashIDs[a||0];return ge('swf_'+b)||$(b);},refreshStats:function(){for(var a=0;a<this._flashIDs.length;a++){var b=this._flash(a);if(b&&b.getStats)this._flashStats[this._flashIDs[a]]=b.getStats();}},getStats:function(a){var b={elapsedTime:0,estimatedTotalTime:null,estimatedTimeToComplete:null,percentCompleted:0,nextPercentTarget:0,estimatedTimeToNextTarget:null,filesUploaded:0,filesFailed:0,bytesUploaded:0,originalFileBytesUploaded:0,totalOriginalFileBytes:0,totalFiles:0,nextFileSize:0};if(a)this.refreshStats();values(this._flashStats).each(function(c){if(c){b.elapsedTime+=c.elapsedTime;b.filesUploaded+=c.filesUploaded;b.filesFailed+=c.filesFailed;b.bytesUploaded+=c.bytesUploaded;b.originalFileBytesUploaded+=c.originalFileBytesUploaded;b.totalOriginalFileBytes+=c.totalOriginalFileBytes;b.totalFiles+=c.totalFiles;b.nextFileSize+=c.nextFileSize;}});b.estimatedTotalTime=b.elapsedTime*b.totalOriginalFileBytes/b.originalFileBytesUploaded;b.estimatedTimeToComplete=b.estimatedTotalTime-b.elapsedTime;b.percentCompleted=b.originalFileBytesUploaded/b.totalOriginalFileBytes*100;b.nextPercentTarget=(b.originalFileBytesUploaded+b.nextFileSize)/b.totalOriginalFileBytes*100;b.estimatedTimeToNextTarget=b.elapsedTime*b.nextFileSize/b.originalFileBytesUploaded;if(b.originalFileBytesUploaded===0){b.estimatedTimeToNextTarget=null;b.estimatedTotalTime=null;b.estimatedTimeToComplete=null;}return b;},uploadImages:function(){if(!this.getImagesSelected())return false;if(this._uploading)return true;for(var a=0;a<this._flashIDs.length;a++){var b=this._flashStats[this._flashIDs[a]];if(b&&b.totalFiles>(b.filesUploaded+b.filesFailed)){var c=this._flash(a);if(typeof c.uploadClick!=='function')continue;(function(d,e){this._flashStats[e]=d.uploadClick();}).bind(this,c,this._flashIDs[a]).defer();PhotosUploadWaterfall.sendSignal({qn:this._queue_name,step:PhotosUploadWaterfall.UPLOAD_START,count:this.getImagesSelected(),uploader:this._uploaderName});this._uploading=true;return true;}}return false;},getRoot:function(){return $(this._flashIDs[0]);},copyWidth:function(a,b){b=b||this._flashIDs[0];var c=$(b).style;c.width=a.offsetWidth+'px';c.height=a.offsetHeight+'px';},setHiRes:function(a){this._flashIDs.each(function(b,c){var d=this._flash(c);if(typeof d.setHiResUpload!=='function')return;var e=d.setHiResUpload(a);this._flashStats[b]=e;if(e&&e.filesUploaded<e.totalFiles)this._uploading=true;}.bind(this));},testFlashUpload:function(){this._flash().testUploader();},testSelectFilesByUrl:function(a,b,c){return this._flash(c).testSelectFilesByUrl(a,b);},setFrecId:function(a){this._frecId=a;this.addPostParam('frecId',a);},getFrecId:function(){return this._frecId;},getRecognitionTimeEstimate:function(){return 250*Math.pow(2,this._recognitionConfig.pollAttempts-1);},startRecognition:function(){new AsyncRequest().setURI(this._recognitionConfig.url).setData({uid:this._recognitionConfig.owner,aid:this._recognitionConfig.aid,frecId:this._frecId,phase:1}).send();this._recognitionPolls=0;this._recognitionTimeout=window.setTimeout(this.checkRecognitionProgress.bind(this),this._recognitionConfig.pollPeriod);},cancelUpload:function(){this._uploading=false;this._stopHeartbeat=true;this._flashIDs.each(function(a,b){(a in this._heartbeats)&&this._heartbeats[a].timer&&clearInterval(this._heartbeats[a].timer);}.bind(this));this._callAllSWFs(true,'cancelUpload');},checkRecognitionProgress:function(){var a=this._recognitionConfig.pollPeriod+500*Math.pow(2,this._recognitionPolls);if(++this._recognitionPolls>=this._recognitionConfig.pollAttempts){this.recognitionFinished();return;}new AsyncRequest().setURI(this._recognitionConfig.url).setData({uid:this._recognitionConfig.owner,aid:this._recognitionConfig.aid,frecId:this._frecId,phase:2}).setHandler(function(b){var c=b.getPayload();if(!c||c.done){this.recognitionFinished();}else this._recognitionTimeout=window.setTimeout(this.checkRecognitionProgress.bind(this),a);}.bind(this)).setErrorHandler(function(b){this._recognitionTimeout=window.setTimeout(this.checkRecognitionProgress.bind(this),a);}.bind(this)).send();}});
var FlashUploader=window.FlashUploader||function(){};FlashUploader.instances=window.FlashUploader.instances||{};FlashUploader.prototype={init:function(a,b,c){this.copyConfig(c);this._flashID=b;this._selectButton=a;this._instanceId=a.id;FlashUploader.instances[this._instanceId]=this;this._controller=new FlashUploadController(b,c,this.onFlashLoadError.bind(this),this.onFlashUpgradeRequired.bind(this),this.onFlashUpgradeSuggested.bind(this));var d=Arbiter.subscribe('page_transition',function(){FlashUploader.instances={};Arbiter.unsubscribe(d);this.destroy();}.bind(this),Arbiter.SUBSCRIBE_NEW);onbeforeunloadRegister(this.handleBeforeUnload.bind(this));onunloadRegister(this.handleUnload.bind(this));this.initArbiter();this.parsePhotoSetToken();},onFlashLoadError:function(a){},onFlashUpgradeRequired:function(a){},onFlashUpgradeSuggested:function(){},initArbiter:function(){[UploadEvent.DONE,UploadEvent.ERROR,UploadEvent.FINISHED_UPLOADING,UploadEvent.LOADED,UploadEvent.READY,UploadEvent.UPLOAD_FAILED,UploadEvent.UPLOAD_PROGRESS,UploadEvent.HI_RES_ATTACH_START,UploadEvent.IMAGE_UPLOAD_ERROR,UploadEvent.IMAGE_UPLOADED,UploadEvent.IMAGES_SELECTED,UploadEvent.SELECT_CANCELED,UploadEvent.SELECT_DOWN,UploadEvent.SELECT_OUT,UploadEvent.SELECT_OVER,UploadEvent.SELECT_UP].each(this._subscribe.bind(this));},handleUpgradeHintClick:function(){PhotosUploadWaterfall.sendSignal({qn:this._qn,step:PhotosUploadWaterfall.UPGRADE_CLICK,uploader:this._uploaderName});},copyConfig:function(a){this.checkConfig(a);for(var b in a)this['_'+b]=a[b];copy_properties(this,{_closeOnComplete:true,_dialog:null,_fbx:false,_frecId:false,_hiResDone:false,_isBound:false,_locationSessionID:0,_locationTypeahead:null,_recognitionStarted:false,_showDoneOnComplete:false,_standardDone:false,_subscriptions:[]});},checkConfig:function(a){},destroy:function(){while(this._subscriptions.length)Arbiter.unsubscribe(this._subscriptions.pop());this._controller.destroy();},_subscribe:function(a){this._subscriptions.push(Arbiter.subscribe(a,this.arbiterFilter.bind(this)));},setAid:function(a){this._aid=a;this._controller.setAid(a);},getAid:function(a){return this._aid;},logDeadProgressBar:function(){PhotosUploadWaterfall.sendSignal({qn:this._qn,uploader:this._uploaderName,step:PhotosUploadWaterfall.PROGRESS_BAR_STOPPED,meta:this._controller.getStats(true)});},setUseSpecialAlbum:function(a){this.setAid('0');this._controller.addPostParam('album_type',a);if(this._targetId)this._controller.addPostParam('target_id',this._targetId);return this;},setPhotoSetToken:function(a){this._photoSetToken=a;this._controller.addPostParam('set_token',a);return this;},getPhotoSetToken:function(){return this._photoSetToken;},parsePhotoSetToken:function(){if(!this._photoSetToken)return;var a=this._photoSetToken.split('.');if(this._created||(a[0]&&!a[1])){this._createNewSet=true;this._closeOnComplete=false;}},setFrecId:function(a){this._controller.setFrecId(a);},getUploadQueryData:function(a){query_data={instance_id:this._instanceId,id:this._owner,'new':a};if(this._aid)query_data.aid=this._aid;if(this._targetId)query_data.target=this._targetId;if(this._photoSetToken)query_data.set=this._photoSetToken;return query_data;},arbiterFilter:function(a,b){},cancelUpload:function(){this._controller.cancelUpload();this._canceled=true;PhotosUploadWaterfall.sendSignal({qn:this._qn,uploader:this._uploaderName,step:PhotosUploadWaterfall.CANCEL,meta:{method:'add-more-cancel'}});},cancelNewAlbumOrSet:function(){this._canceled=true;DOM.remove($(this._flashID));PhotosUploadWaterfall.sendSignal({qn:this._qn,uploader:this._uploaderName,step:PhotosUploadWaterfall.CANCEL,meta:{method:'new-album-cancel'}});var a;if(this._createNewSet){a=new AsyncRequest().setURI('ajax/photos/sets/delete/default.htm').setData({set:this._photoSetToken,id:this._owner});}else a=new AsyncRequest().setURI('ajax/photos/album/delete/default.htm').setData({aid:this._aid,id:this._owner});var b=curry(goURI,window.location.href,true);if(this._surveyVisible){new AsyncRequest('photos/upload/survey_flag/default.htm').setMethod('POST').send();b=function(){new Dialog().setAsync(new AsyncRequest('survey/surveyDialog').setData({survey_id:'216629141722067'})).setCancelHandler(curry(goURI,window.location.href,true)).show();};}a.setHandler(b).send();},getErrorMessage:function(a){switch(a.failureCode){case 0:return tx._("\u4e0a\u4f20{filename}\u65f6\u51fa\u73b0\u95ee\u9898\u3002\u8bf7\u786e\u4fdd\u4f60\u7684\u7f51\u7edc\u8fde\u63a5\u6b63\u5e38\u3002",{filename:a.filename});case 1:return null;case 2:return tx._("{filename}\u6253\u4e0d\u5f00\u3002\u8bf7\u786e\u4fdd\u6587\u4ef6\u6ca1\u88ab\u5220\u9664\u3002",{filename:a.filename});case 3:return tx._("\u6211\u4eec\u65e0\u6cd5\u8bfb\u53d6{filename}\u4e2d\u7684\u5185\u5bb9\u3002\u8bf7\u786e\u8ba4\u5176\u4e3a .jpg\uff0c .gif \u6216 .png \u683c\u5f0f\u7684\u56fe\u7247\u3002",{filename:a.filename});case 4:return tx._("{filename}\u5c3a\u5bf8\u8fc7\u5927\u3002\u8bf7\u5c06\u4f60\u7684\u7167\u7247\u5927\u5c0f\u8c03\u81f38000x8000\u50cf\u7d20\u4ee5\u4e0b\u5e76\u91cd\u8bd5\u3002",{filename:a.filename});}return null;},handleUnload:function(){if(this._controller.isUploading()&&!this._canceled)PhotosUploadWaterfall.sendSignal({qn:this._qn,uploader:this._uploaderName,step:PhotosUploadWaterfall.CANCEL,meta:{method:'nav-away'}});},handleBeforeUnload:function(){if(this._controller.isUploading()&&!this._canceled)return "\u73b0\u5728\u5982\u679c\u4f60\u79bb\u5f00\u8fd9\u4e2a\u9875\u9762\uff0c\u4f60\u7684\u7167\u7247\u5c06\u4e0d\u4f1a\u88ab\u4e0a\u4f20\u3002";},allDone:function(){},getUploadURI:function(){return this._photoSetToken?URI('ajax/photos/upload/flash/set/default.htm'):URI('ajax/photos/upload/flash/');},setHiRes:function(a){this._fbx=a;this._controller.setHiRes(this._fbx);},getHiRes:function(){return this._fbx;}};
function FlashUploaderOverlay(){this.parent.construct(this);this._photos={};}Class.extend(FlashUploaderOverlay,'FlashUploader');FlashUploaderOverlay.bootstrap=function(a,b,c,d){var e=$(b);if(!(a in FlashUploader.instances)){(new FlashUploaderOverlay()).init(e,c,JSON.parse($(c).getAttribute('data-config')));}else FlashUploader.instances[a].registerSwf(c,e);if(d)AsyncRequest.bootstrap(e.getAttribute('ajaxify'),e);};FlashUploaderOverlay.prototype={init:function(a,b,c){this._originalDocumentTitle=DocumentTitle.get();this._selectButtons={};this._selectButtons[b]=a;this._fallbackHref=c.fallbackHref;this._pendingAid=null;this._backdatedTime=null;this.parent.init(a,b,c);},onFlashLoadError:function(a){if(!this._fallbackHref)return;for(var b in this._selectButtons){var c=this._selectButtons[b],d=URI(this._fallbackHref).addQueryData({error:a}).toString();c.removeAttribute('rel');c.removeAttribute('ajaxify');c.setAttribute('href',d);this.enableButton(c);}},onFlashUpgradeRequired:function(a){this.onFlashLoadError(a);},onFlashUpgradeSuggested:function(){},registerSwf:function(a,b){this._selectButtons[a]=b;this._controller.registerSwf(a);},arbiterFilter:function(a,b){if(!this._controller.isEventIntendedForMe(b))return;switch(a){case UploadEvent.READY:return this.handleReady(b);case UploadEvent.SELECT_OVER:return CSS.addClass(this._selectButton,'selectOver');case UploadEvent.SELECT_OUT:return CSS.removeClass(this._selectButton,'selectOver');case UploadEvent.IMAGES_SELECTED:return this.handleImagesSelected(b);case UploadEvent.ERROR:return this.handleError(b.response);case UploadEvent.HI_RES_ATTACH_START:return this.handleHiResAttachStart(b);case UploadEvent.UPLOAD_PROGRESS:return this.handleImageUploaded(b);case UploadEvent.DONE:return this.done();}},handleReady:function(a){var b=this._selectButtons[a.divID];this.enableButton(b);this._controller.copyWidth(b,a.divID);if(this._pendingAid)this.parent.setAid(this._pendingAid);},setAid:function(a){if(this._controller.isReady()){this.parent.setAid(a);}else this._pendingAid=a;},enableButton:function(a){var b=Parent.byClass(a,'addPhotosDisabled');if(b){CSS.removeClass(b,'addPhotosDisabled');CSS.addClass(b,'addPhotosEnabled');}},showAlbumLimitExceededDialog:function(){var a=new Dialog().setModal(false).setTitle("\u4e0a\u4f20\u9519\u8bef").setBody("\u6b64\u76f8\u518c\u5df2\u6ee1\u3002\u5982\u679c\u4f60\u60f3\u8981\u4e0a\u4f20\u66f4\u591a\u7167\u7247\uff0c\u8bf7\u521b\u5efa\u4e00\u4e2a\u65b0\u76f8\u518c\u3002").setButtons(Dialog.CLOSE).setModal(true).show();},handleImagesSelected:function(a){if(this._editor){if(a.maxReached)this.showAlbumLimitExceededDialog();if(a.count===0)return;this.addPlaceholders(a.count);this.updateOverallProgress();this.startUpload();return;}var b=deconcept.SWFObjectUtil.getPlayerVersion();PhotosUploadWaterfall.sendSignal({qn:this._qn,step:PhotosUploadWaterfall.VERSION,uploader:'flash',version:b.major+'.'+b.minor+'.'+b.rev});},bindToOverlay:function(a,b,c,d,e,f){this.setAid(d);this._fbid=e;this._controller.setFrecId(f);this._editor=a;this._overallProgressBar=b;this._progressWrap=DOM.find(c,'div.progressWrap');this._overlayRoot=c;this._faceRequests={};this._photosWithUntaggedFaces={};this._footer=DOM.find(c,'div.footerBox');this._header=DOM.find(c,'div.headerBox');this._overlayPage=DOM.find(c,'div.uiOverlayPage');this._doneButton=DOM.find(c,'.doneButton');var g=this.repositionFixedElements.bind(this),h=[Event.listen(DOM.find(c,'.cancel'),'click',this.showCancelDialog.bind(this)),Event.listen(this._doneButton,'click',this.updateForm.bind(this)),Event.listen(document.documentElement,'keydown',function(k){if(Event.getKeyCode(k)!==KEYS.ESC)return;this.showCancelDialog();k.stop();}.bind(this),Event.Priority.URGENT),Event.listen(c,'scroll',g),Event.listen(window,'resize',g)],i=[Arbiter.subscribe(PhotosBulkEditablePhoto.REMOVED,this.handlePhotoDeleted.bind(this)),Arbiter.subscribe(PhotoBulkEditTagger.TAG_SAVED,function(k,l){this._photosWithUntaggedFaces[l.fbid]=false;if(this._faceRequests[l.fbid]){window.clearTimeout(this._faceRequests[l.fbid]);delete this._faceRequests[l.fbid];}}.bind(this),Arbiter.SUBSCRIBE_NEW),Arbiter.subscribe('Overlay/hide',function(k,l){if(Overlay.getInstance(this._overlayPage)!==l.overlay)return;DocumentTitle.set(this._originalDocumentTitle);h.each(function(m){m.remove();});h=[];i.each(function(m){Arbiter.unsubscribe(m);});i=[];}.bind(this),Arbiter.SUBSCRIBE_NEW),Arbiter.subscribe(PhotosBulkBackdateEditor.SAVED,function(k,l){if(!DOM.contains(this._overlayPage,l.context))return;this._backdatedTime=l.backdatedDate;}.bind(this))],j=DOM.find(this._overlayRoot,'input.fluploader_enable_fbx');this._fbx=j.checked;Event.listen(j,'click',function(){this.setHiRes(j.checked);new AsyncRequest().setURI('ajax/photos/upload/settings/default.htm').setData({resolution:j.checked?'high':'standard'}).send();}.bind(this));this.addPlaceholders(this._controller.getImagesSelected());this.startUpload();if(this._controller.isAlbumLimitExceeded())this.showAlbumLimitExceededDialog();},addPlaceholders:function(a){if(a)CSS.removeClass(this._overlayRoot,'showEmptyState');if(!this._controller.isUploading())a--;var b=[],c=this._editor.getWaitingTemplate().getRoot();for(var d=0;d<a;d++){var e=c.cloneNode(true);CSS.show(e);b.push(e);}DOM.insertAfter(this._editor.getPlaceholder().getRoot(),b);},startUpload:function(){var a=this._editor.getPlaceholder();a.show();this.repositionFixedElements();var b=this._controller.isUploading();if(this._controller.uploadImages()){if(!b)this._editor.getPlaceholder().getProgressBar().setPosition(0).setTarget(95,20000);var c=this._controller.getStats(),d=c.nextPercentTarget,e=c.estimatedTimeToNextTarget;if(e===null)e=20000;this._overallProgressBar.setPosition(this._controller.getPercentComplete()).setCompleteHandler(this.logDeadProgressBar.bind(this)).setTarget(d,e);this.updateStatusText();this.updateButtonState();}},repositionFixedElements:function(){var a=Vector2.getElementPosition(this._overlayPage).y<0;if(a!=CSS.hasClass(this._header,'headerFixed'))this.adjustElementPosition(this._header,a,'headerFixed');var b=Vector2.getViewportDimensions(),c=this._editor.getRoot();if(ua.firefox()){CSS.setStyle(c,'min-height',b.y+'px');if(!CSS.hasClass(this._footer,'footerFixed'))this.adjustElementPosition(this._footer,true,'footerFixed');return;}var d=Vector2.getElementPosition(c).y+Vector2.getElementDimensions(c).y+Vector2.getElementDimensions(this._footer).y,e=d>b.y;if(e!=CSS.hasClass(this._footer,'footerFixed'))this.adjustElementPosition(this._footer,e,'footerFixed');},adjustElementPosition:function(a,b,c){CSS.conditionClass(a,c,b);if(!b){CSS.setStyle(a,'marginLeft','');return;}var d=DOMScroll.getScrollbarSize(),e=Vector2.getElementDimensions(a).x;CSS.setStyle(a,'marginLeft',(-Math.round((e+d)/2))+'px');},handleError:function(a){if(!a)return;var b=a.errorSummary,c=a.errorDescription,d=this._editor.getPlaceholder().getRoot(),e=this._editor.getWaitingTemplate().getRoot(),f=e.cloneNode(true);DOM.insertBefore(f,d);DOM.appendContent(DOM.find(f,'.error .title'),b);DOM.setContent(DOM.find(f,'.error .description'),c);CSS.addClass(f,'editablePhotoErrorPlaceholder');CSS.show(DOM.find(f,'.error'));CSS.show(f);var g=d.nextSibling;if(g&&CSS.hasClass(g,'editablePhoto'))DOM.remove(g);this.updatePlaceholder();this.updateOverallProgress();},done:function(){this.updateOverallProgress();this.updateButtonState();},updateHiResStatus:function(a){if(!this.getHiRes()){CSS.removeClass(a.editablePhoto,'editablePhotoNeedsHiRes');return;}var b=DOM.find(a.editablePhoto,'.statusBar');if(!a.hiRes){CSS.addClass(a.editablePhoto,'editablePhotoNeedsHiRes');DOM.setContent(b,"\u7b49\u5f85\u9ad8\u6e05\u50cf\u7d20");return;}window.clearTimeout(a.hiResTimeout);var c=500/(100-a.hiResPercent);a.hiResTimeout=window.setTimeout(this.updateHiResPercent.bind(this,a,100,c,function(){DOM.setContent(b,"\u9ad8\u6e05"+' \u2714');CSS.removeClass.curry(a.editablePhoto,'editablePhotoNeedsHiRes').defer(2000);}),c);},handleHiResAttachStart:function(a){var b=this._photos[a.response.fbid],c=a.stats.estimatedTimeToNextTarget||20000,d=c/95;b.hiResPercent=1;b.hiResTimeout=window.setTimeout(this.updateHiResPercent.bind(this,b,95,d),d);},updateHiResPercent:function(a,b,c,d){var e=DOM.find(a.editablePhoto,'.statusBar');DOM.setContent(e,tx._("\u9ad8\u901f\u8fa8\u7387\uff1a{percent}\u0025",{percent:a.hiResPercent}));if(a.hiResPercent<b){a.hiResPercent++;a.hiResTimeout=window.setTimeout(this.updateHiResPercent.bind(this,a,b,c,d),c);}else if(d)d();},handleImageUploaded:function(a){var b=a.response.fbid,c=this._photos[b];if(c){c.hiRes=a.hiRes;if(c.hiRes)this.updateHiResStatus(c);this.updateOverallProgress();return;}c={fbid:b,hiRes:a.hiRes};this.fetchEditablePhoto(c,{});},fetchEditablePhoto:function(a,b){copy_properties(b,this._editor.needTaggingData()?{need_tagging:true}:{});this._waitingForEditablePhoto=true;var c=new AsyncRequest().setURI(URI('ajax/photos/photo/edit/'+a.fbid+'default.htm')).setData(b).setHandler(this.handleEditablePhotoReceived.bind(this,a)).setErrorHandler(function(d){this._waitingForEditablePhoto=false;delete this._photos[a.fbid];this.handleError(d);}.bind(this)).send();},handleEditablePhotoReceived:function(a,b){var c=b.getPayload();if(c.retryIn)return this.fetchEditablePhoto.bind(this,a,c).defer(c.retryIn*1000);this._waitingForEditablePhoto=false;var d=this._editor.getPlaceholder(),e=d.getProgressBar(),f=c,g=DOM.insertBefore(f,d.getRoot());f=g[0];a.editablePhoto=f;this._photos[a.fbid]=a;this.updateHiResStatus(a);CSS.hide(f);e.setCompleteHandler(this.showNextEditablePhoto.bind(this,f)).setTarget(100,500);this.updateOverallProgress();this._faceRequests[a.fbid]=window.setTimeout(this.requestFaces.bind(this,a),4000);},requestFaces:function(a){var b=DOM.find(a.editablePhoto,'div.scaledImage'),c=Vector2.getElementDimensions(b);new AsyncRequest('ajax/photos/photo/faceboxes/default.htm').setData({fbid:a.fbid,width:c.x,height:c.y}).setMethod('GET').setReadOnly(true).setHandler(function(d){if(!d.getPayload()||!this._faceRequests[a.fbid]){this._photosWithUntaggedFaces[a.fbid]=false;return;}var e=DOM.find(a.editablePhoto,'div.border');DOM.appendContent(e,d.getPayload().html);CSS.addClass.curry(a.editablePhoto,'showRecognitionBoxes').defer();delete this._faceRequests[a.fbid];this._photosWithUntaggedFaces[a.fbid]=true;}.bind(this)).send();},updateStatusText:function(){var a=this._controller.getStats(),b=this._controller.isUploading(),c='';if(a&&a.estimatedTimeToComplete){var d=Math.ceil(a.estimatedTimeToComplete/60000);c=d==1?"\u5269\u4e0b 1 \u5206\u949f":tx._("\u5269 {time} \u5206\u949f",{time:d});}else if(b)c="\u6b63\u5728\u4f30\u8ba1\u5269\u4f59\u65f6\u95f4";var e='';if(b){e=tx._("{uploaded}\u5f20\u5df2\u4e0a\u4f20\/\u5171{total}\u5f20",{total:this._controller.getImagesSelected(),uploaded:this._controller.getImagesUploaded()});}else e="\u4e0a\u4f20\u5b8c\u6bd5";var f=c?e+' \u00b7 '+c:e;Tooltip.set(this._progressWrap,f);DocumentTitle.set(e);},setHiRes:function(a){if(a==this.getHiRes())return;this.parent.setHiRes(a);if(a){this._overallProgressBar.setPosition(this._controller.getPercentComplete());this.updateButtonState();}this.updateOverallProgress();for(var b in this._photos){var c=this._photos[b];this.updateHiResStatus(c);}},updateButtonState:function(){Button.setEnabled(this._doneButton,(!this._controller.isUploading()&&!this.inEmptyState()&&this._controller.isRecognitionFinished()));},showNextEditablePhoto:function(a){var b=this._editor.getPlaceholder().getRoot().nextSibling;if(b&&CSS.hasClass(b,'editablePhoto'))DOM.remove(b);CSS.show(a);this.updatePlaceholder();this.repositionFixedElements();this.updateOverallProgress();},updatePlaceholder:function(){var a=this._editor.getPlaceholder(),b=a.getProgressBar().setCompleteHandler(null).setPosition(0),c=this._controller,d=c.getImagesFailed()+c.getImagesUploaded();if(d>=c.getImagesSelected()){a.hide();return;}var e=count(this._photos)+c.getImagesFailed();if(e==c.getImagesSelected()){a.hide();return;}var f=c.getStats().estimatedTimeToNextTarget;if(f===null)f=20000;b.setTarget(95,f);},updateOverallProgress:function(){var a=this._controller.getStats(),b=this._controller.isUploading();if(b){var c=a.estimatedTimeToNextTarget;if(c===null)c=20000;if(c>0)this._overallProgressBar.setTarget(a.nextPercentTarget,c).setCompleteHandler(this.logDeadProgressBar.bind(this));this.updateStatusText();}else if(!this._waitingForEditablePhoto)this._overallProgressBar.setCompleteHandler(function(){this._overallProgressBar.setCompleteHandler(null);this.updateStatusText();}.bind(this)).setTarget(100,500);},updateForm:function(){var a=true;for(var b in this._photosWithUntaggedFaces)if(this._photosWithUntaggedFaces[b]){a=false;break;}var c={id:this._owner,tid:this._targetId,frecId:this._frecId,skipClustering:a,qn:this._qn,success:this._controller.getImagesUploaded(),failure:0};if(this._photoSetToken){c.set=this._photoSetToken;}else c.aid=this._aid;if(this._backdatedTime)c.backdated_date=this._backdatedTime;Form.createHiddenInputs(c,Parent.byTag(this._doneButton,'form'));if(this._createNewSet)new AsyncRequest().setURI('ajax/photos/upload/flash/set/finish/default.htm').setData({set:this._photoSetToken,target:this._targetId}).setAllowCrossPageTransition(true).send();},handlePhotoDeleted:function(a,b){this.repositionFixedElements();var c=b.getPhotoData().fbid;this._controller.markDeleted(c);delete this._photos[c];if(this.inEmptyState()){this.updateButtonState();CSS.addClass(this._overlayRoot,'showEmptyState');}},inEmptyState:function(){return (is_empty(this._photos)&&!this._controller.isUploading()&&!this._waitingForEditablePhoto);},cancelAddPhotosToAlbumOrSet:function(){var a=this._photoSetToken;if(!a)a=['a',this._fbid,this._aid,this._owner].join('.');var b=[];for(var c in this._photos)b.push(c);new AsyncRequest().setURI('ajax/photos/multi_delete').setData({set:a,photo_ids:b}).setHandler(curry(goURI,window.location.href,true)).send();},showCancelDialog:function(){var a=this.inEmptyState()?"\u4fdd\u5b58\u76f8\u518c":"\u4fdd\u5b58\u56fe\u7247",b=[Dialog.newButton('keep_photos',a,'',function(){this.cancelUpload();this.updateForm();Parent.byTag(this._doneButton,'form').submit();}.bind(this)),Dialog.newButton('continue',"\u7ee7\u7eed",'inputaux',bagofholding)],c=(this.inEmptyState()&&this._created)?"\u53d6\u6d88\u4e0a\u4f20\u5e76\u5220\u9664\u76f8\u518c":"\u53d6\u6d88\u4e0a\u4f20\u5e76\u5220\u9664\u6240\u6709\u5df2\u4e0a\u4f20\u7167\u7247",d=$N('a',{href:'#'},c),e=this.inEmptyState()?"\u4f60\u786e\u5b9a\u8981\u53d6\u6d88\u4f60\u7684\u4e0a\u4f20\uff1f\u4f60\u53ef\u4ee5\u4fdd\u5b58\u65b0\u521b\u5efa\u76f8\u518c\u5e76\u538b\u540e\u518d\u6dfb\u52a0\u4f60\u7684\u7167\u7247\u3002":"\u60a8\u786e\u5b9a\u8981\u53d6\u6d88\u4e0a\u4f20\u5417\uff1f\u60a8\u53ef\u5220\u9664\u5df2\u4e0a\u4f20\u7684\u7167\u7247\uff0c\u6216\u5c06\u5176\u4fdd\u7559\u5e76\u5728\u4ee5\u540e\u53d1\u5e03\u3002",f=new Dialog().setBody(e).setTitle("\u53d6\u6d88\u4e0a\u4f20").setButtons(b).setButtonsMessage(d).setModal(true).show();Event.listen(d,'click',function(){f.hide();Overlay.getInstance(this._overlayPage).hide();this.cancelUpload();if(this._created){this.cancelNewAlbumOrSet();}else this.cancelAddPhotosToAlbumOrSet();}.bind(this));}};