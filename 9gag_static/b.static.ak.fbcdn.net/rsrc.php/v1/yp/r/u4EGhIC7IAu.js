/*1329173840,169776066*/

if (window.CavalryLogger) { CavalryLogger.start_js(["tT0c+"]); }

/**
 * @provides md5
 * @option preserve-header
 *
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2 Copyright (C) Paul Johnston 1999 - 2009
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */(function(){window.md5=function(o){return c(b(d(o)));};var a=0;function b(o){return f(g(e(o),o.length*8));}function c(o){try{a;}catch(p){a=0;}var q=a?"0123456789ABCDEF":"0123456789abcdef",r="",s;for(var t=0;t<o.length;t++){s=o.charCodeAt(t);r+=q.charAt((s>>>4)&15)+q.charAt(s&15);}return r;}function d(o){var p="",q=-1,r,s;while(++q<o.length){r=o.charCodeAt(q);s=q+1<o.length?o.charCodeAt(q+1):0;if(55296<=r&&r<=56319&&56320<=s&&s<=57343){r=65536+((r&1023)<<10)+(s&1023);q++;}if(r<=127){p+=String.fromCharCode(r);}else if(r<=2047){p+=String.fromCharCode(192|((r>>>6)&31),128|(r&63));}else if(r<=65535){p+=String.fromCharCode(224|((r>>>12)&15),128|((r>>>6)&63),128|(r&63));}else if(r<=2097151)p+=String.fromCharCode(240|((r>>>18)&7),128|((r>>>12)&63),128|((r>>>6)&63),128|(r&63));}return p;}function e(o){var p=Array(o.length>>2);for(var q=0;q<p.length;q++)p[q]=0;for(var q=0;q<o.length*8;q+=8)p[q>>5]|=(o.charCodeAt(q/8)&255)<<(q%32);return p;}function f(o){var p="";for(var q=0;q<o.length*32;q+=8)p+=String.fromCharCode((o[q>>5]>>>(q%32))&255);return p;}function g(o,p){o[p>>5]|=128<<((p)%32);o[(((p+64)>>>9)<<4)+14]=p;var q=1732584193,r=-271733879,s=-1732584194,t=271733878;for(var u=0;u<o.length;u+=16){var v=q,w=r,x=s,y=t;q=i(q,r,s,t,o[u+0],7,-680876936);t=i(t,q,r,s,o[u+1],12,-389564586);s=i(s,t,q,r,o[u+2],17,606105819);r=i(r,s,t,q,o[u+3],22,-1044525330);q=i(q,r,s,t,o[u+4],7,-176418897);t=i(t,q,r,s,o[u+5],12,1200080426);s=i(s,t,q,r,o[u+6],17,-1473231341);r=i(r,s,t,q,o[u+7],22,-45705983);q=i(q,r,s,t,o[u+8],7,1770035416);t=i(t,q,r,s,o[u+9],12,-1958414417);s=i(s,t,q,r,o[u+10],17,-42063);r=i(r,s,t,q,o[u+11],22,-1990404162);q=i(q,r,s,t,o[u+12],7,1804603682);t=i(t,q,r,s,o[u+13],12,-40341101);s=i(s,t,q,r,o[u+14],17,-1502002290);r=i(r,s,t,q,o[u+15],22,1236535329);q=j(q,r,s,t,o[u+1],5,-165796510);t=j(t,q,r,s,o[u+6],9,-1069501632);s=j(s,t,q,r,o[u+11],14,643717713);r=j(r,s,t,q,o[u+0],20,-373897302);q=j(q,r,s,t,o[u+5],5,-701558691);t=j(t,q,r,s,o[u+10],9,38016083);s=j(s,t,q,r,o[u+15],14,-660478335);r=j(r,s,t,q,o[u+4],20,-405537848);q=j(q,r,s,t,o[u+9],5,568446438);t=j(t,q,r,s,o[u+14],9,-1019803690);s=j(s,t,q,r,o[u+3],14,-187363961);r=j(r,s,t,q,o[u+8],20,1163531501);q=j(q,r,s,t,o[u+13],5,-1444681467);t=j(t,q,r,s,o[u+2],9,-51403784);s=j(s,t,q,r,o[u+7],14,1735328473);r=j(r,s,t,q,o[u+12],20,-1926607734);q=k(q,r,s,t,o[u+5],4,-378558);t=k(t,q,r,s,o[u+8],11,-2022574463);s=k(s,t,q,r,o[u+11],16,1839030562);r=k(r,s,t,q,o[u+14],23,-35309556);q=k(q,r,s,t,o[u+1],4,-1530992060);t=k(t,q,r,s,o[u+4],11,1272893353);s=k(s,t,q,r,o[u+7],16,-155497632);r=k(r,s,t,q,o[u+10],23,-1094730640);q=k(q,r,s,t,o[u+13],4,681279174);t=k(t,q,r,s,o[u+0],11,-358537222);s=k(s,t,q,r,o[u+3],16,-722521979);r=k(r,s,t,q,o[u+6],23,76029189);q=k(q,r,s,t,o[u+9],4,-640364487);t=k(t,q,r,s,o[u+12],11,-421815835);s=k(s,t,q,r,o[u+15],16,530742520);r=k(r,s,t,q,o[u+2],23,-995338651);q=l(q,r,s,t,o[u+0],6,-198630844);t=l(t,q,r,s,o[u+7],10,1126891415);s=l(s,t,q,r,o[u+14],15,-1416354905);r=l(r,s,t,q,o[u+5],21,-57434055);q=l(q,r,s,t,o[u+12],6,1700485571);t=l(t,q,r,s,o[u+3],10,-1894986606);s=l(s,t,q,r,o[u+10],15,-1051523);r=l(r,s,t,q,o[u+1],21,-2054922799);q=l(q,r,s,t,o[u+8],6,1873313359);t=l(t,q,r,s,o[u+15],10,-30611744);s=l(s,t,q,r,o[u+6],15,-1560198380);r=l(r,s,t,q,o[u+13],21,1309151649);q=l(q,r,s,t,o[u+4],6,-145523070);t=l(t,q,r,s,o[u+11],10,-1120210379);s=l(s,t,q,r,o[u+2],15,718787259);r=l(r,s,t,q,o[u+9],21,-343485551);q=m(q,v);r=m(r,w);s=m(s,x);t=m(t,y);}return Array(q,r,s,t);}function h(o,p,q,r,s,t){return m(n(m(m(p,o),m(r,t)),s),q);}function i(o,p,q,r,s,t,u){return h((p&q)|((~p)&r),o,p,s,t,u);}function j(o,p,q,r,s,t,u){return h((p&r)|(q&(~r)),o,p,s,t,u);}function k(o,p,q,r,s,t,u){return h(p^q^r,o,p,s,t,u);}function l(o,p,q,r,s,t,u){return h(q^(p|(~r)),o,p,s,t,u);}function m(o,p){var q=(o&65535)+(p&65535),r=(o>>16)+(p>>16)+(q>>16);return (r<<16)|(q&65535);}function n(o,p){return (o<<p)|(o>>>(32-p));}})();
PageletCache=window.PageletCache||{libraryHash:'48c1e150e2f733fcc1fac1b62d944806',init:function(a){PageletCache._password=a;try{PageletCache._cache=window.localStorage;}catch(b){}PageletCache.loadCryptoLib();Arbiter.subscribe('pre_page_transition',PageletCache.cleanup);},loadCryptoLib:function(){var a=PageletCache._cache.getItem('crypto-lib');if(!a){Bootloader.loadComponents('async',function(){new AsyncRequest(PageletCache._crypto_url).setHandler(function(b){PageletCache.evalJS(b.payload);onafterloadRegister_DEPRECATED(function(){PageletCache._cache.setItem('crypto-lib',b.payload);});}).send();});}else{if(Math.random()<.1&&PageletCache.libraryHash!=md5(a)){PageletCache._cache.removeItem('crypto-lib');PageletCache.loadCryptoLib();return;}PageletCache.evalJS(a);}},evalJS:function(a){eval_global(a);Arbiter.inform('pagelet_cache_loaded',true,Arbiter.BEHAVIOR_STATE);},_processBeforeWrite:function(a){Bootloader.setResourceMap(a.resource_map);var b=(a.css||[]).concat(a.js||[]);for(var c in (a.bootloadable||{}))b.concat(a.bootloadable[c]);a.resource_map=a.resource_map||{};for(var d=0;d<b.length;d++){var e=b[d];if(!a.resource_map[e])a.resource_map[e]=Bootloader.resolveResources([e])[0];}if(a.cache_type=='overwrite'){delete a.onload;delete a.onafterload;delete a.jscc;delete a.jscc_map;delete a.jscalls;}},write:function(a){if(!PageletCache._cache||a.cache_type=='base')return;Arbiter.registerCallback(function(){var b={},c={};copy_properties(c,a);try{PageletCache._processBeforeWrite(c);b[a.key]=c;var e=sjcl.encrypt(PageletCache._password,JSON.stringify(b));PageletCache._cache.setItem(a.id,e);PageletCache._pagelets[a.id]=c;}catch(d){window.Util&&false;}},['pagelet_cache_loaded']);},loadFromCache:function(a){var b={};copy_properties(b,PageletCache.read(a.id,a.key));if(is_empty(b))PageletCache.bustcache();b.id=a.id;b.cache_hit=true;b.display_dependency=a.display_dependency;b.phase=a.phase;b.is_last=a.is_last;return b;},read:function(a,b){if(!PageletCache._cache)return null;if(a.substr(0,6)=='cached')a=a.substr(7);var c=PageletCache._cache.getItem(a);if(c){var d;try{var f=sjcl.decrypt(PageletCache._password,c);d=JSON.parse(f);}catch(e){window.Util&&false;}if(d&&d[b]){PageletCache._pagelets[a]=d[b];PageletCache._cache_hits[a]=true;return d[b];}}},bustcache:function(){Bootloader.loadComponents(['uri','cookie'],function(){setCookie('bustcache',1,1000);URI.getNextURI().go();});},isCacheHit:function(a){return !!PageletCache._cache_hits[a];},cleanup:function(){PageletCache._cache_hits={};},clearCache:function(){if(PageletCache._cache){var a=[];for(var b=0;b<PageletCache._cache.length;b++){var c=PageletCache._cache.key(b);if(c.substr(0,7)=='pagelet')a.push(c);}for(b=0;b<a.length;b++)PageletCache._cache.removeItem(a[b]);}},_cache:null,_crypto_url:'ajax/pagelet_cache/crypto.php',_pagelets:{},_cache_hits:{}};
function PageletCacheController(a,b,c){if(!PageletCache)return;if(!a)return;this._cacheKey=a;this._cacheType=b;this._subscriptions=[];this._controller=null;this._registerSnapshot(c);PageletCacheController._instances[a]=this;}copy_properties(PageletCacheController,{registerController:function(a,b){if(!a||!b)return null;var c=PageletCacheController._instances[a];if(c){c.setController(b);if(c._cacheType=='update'&&PageletCache.isCacheHit(a))onafterloadRegister_DEPRECATED(c.updateAfterload.bind(c,b));}return c;},_instances:{}});copy_properties(PageletCacheController.prototype,{registerCleanup:function(a){Arbiter.subscribe(a,this._cleanup.bind(this));},setController:function(a){this._controller=a;return this;},loadData:function(){return PageletCache.fetchData(this._cacheKey);},populateControllerDataOnSnapshot:bagofholding,handlePageletDOMOnSnapshot:bagofholding,updateAfterload:bagofholding,_registerSnapshot:function(a){for(var b=0;b<a.length;b++)this._subscriptions.push(Arbiter.subscribe(a[b],this._update.bind(this)));},_update:function(){if(!$(this._cacheKey)){this._cleanup();return;}var a=this._controller?this.populateControllerDataOnSnapshot.bind(this,this._controller):bagofholding;PageletCache.takeSnapshot(this._cacheKey,a,this.handlePageletDOMOnSnapshot.bind(this));},_cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions.length=0;delete PageletCacheController._instances[this._cacheKey];}});copy_properties(PageletCache,{takeSnapshot:function(a,b,c){var d=PageletCache._pagelets[a];if(d){var e=$(a);if(e){var f=e.cloneNode(true);if(c)c(f);d.content[a]=f.innerHTML;if(b){if(!d.data)d.data={};b(d.data);}PageletCache.write(d);}}},fetchData:function(a,b){var c=PageletCache._pagelets[a];if(c&&c.data)if(b){return c.data[b];}else return c.data;}});
function HomeNavigationCache(a,b,c){this.parent.construct(this,a,b,c);}Class.extend(HomeNavigationCache,'PageletCacheController');copy_properties(HomeNavigationCache.prototype,{handlePageletDOMOnSnapshot:function(a){var b=DOM.scry(a,'li.sideNavItem');if(b.length===0)return;for(var c=0;c<b.length;c++){var d=b[c];if(d.id=='navItem_app_4748854339'){CSS.addClass(d,'selectedItem');}else if(CSS.hasClass(d,'selectedItem')){CSS.removeClass(d,'selectedItem');CSS.removeClass(d,'open');}CSS.removeClass(d,'loading');}}});
var NewHigh={reset:function(){this.initialized=false;},ensureInitialized:function(){if(this.initialized)return;this.button=DOM.scry(document.body,'a.stream_header_button')[0];this.composer=DOM.scry(document.body,'div.UIComposer')[0];this.buttonArea=DOM.scry(this.composer,'div.UIComposer_ButtonArea')[0];this.initialized=true;},showComposer:function(a){this.ensureInitialized();if(this.composer){CSS.show(this.composer);UIComposer.focusInstance(this.composer.id);var b=UIComposer.getInstance(this.composer.id);b&&b.loadAttachment(parseInt(a,10));}this.button&&CSS.hide(this.button);},hideComposer:function(a){this.ensureInitialized();if(this.composer){var b=UIComposer.getInstance(this.composer.id);if(!a){b&&b.initialized&&b.blur();CSS.hide(this.composer);this.button&&CSS.show(this.button);}else{b&&b.initialized&&b.loadAttachment(0);CSS.show(this.composer);this.buttonArea&&CSS.hide(this.buttonArea);}}}};
function FutureHomeSideNav(){this.parent.construct(this);}Class.extend(FutureHomeSideNav,'FutureSideNav');FutureHomeSideNav.prototype={init:function(){this.parent.init.apply(this,arguments);this.ajaxPipe=true;this.seeAllEndpoint="ajax/home/generic.php";this.typeSections={favorites:'pinnedNav',profiles:'pinnedNav',apps:'appsNav',groups:'groupsNav',pages:'pagesNav',lists:'listsNav',interests:'interestsNav',connect_apps:'connectNav'};this.switchingFromTitanFixedFrame=false;this._arbiterSubscriptions.push(Arbiter.subscribe('titan_fixed_frame_changed',this.handleFixedFrameChanged.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,this.updateFavorite.bind(this)),Arbiter.subscribe(NavigationMessage.NAVIGATION_FIRST_RESPONSE,this.navigationFirstResponse.bind(this)));this._ensureHover('homeSideNav');this._initPageletCache();},_initPageletCache:function(a){if(window.PageletCacheController){this._cache=PageletCacheController.registerController('pagelet_navigation',this);if(this._cache){this._cache.registerCleanup('HomeNav/cleanup');onleaveRegister(function(){Arbiter.inform('HomeNav/cleanup');});}}},initMoreLink:function(a){this._eventHandlers.push(Event.listen(a,'click',this._showMoreSections.bind(this,a)));},_showMoreSections:function(a){var b=DOM.scry(this.root,'div.belowThreshold');CSS.hide(a);b.forEach(function(c){CSS.removeClass(c,'belowThreshold');});},handleFixedFrameChanged:function(a,b,c){if(b){var d=function(e,f){UIPagelet.loadFromEndpoint(e,f,{fixed_frame:b,selected_key:c});};d('PinnedNavigationPagelet','pagelet_pinned_nav');d('BookmarkNavigationPagelet','pagelet_bookmark_nav');if(ge('chatFriendsOnline'))CSS.hide(ge('chatFriendsOnline'));}else this.switchingFromTitanFixedFrame=true;},handlePageTransition:function(a){if(this.switchingFromTitanFixedFrame){this.switchingFromTitanFixedFrame=false;return false;}else return this.parent.handlePageTransition(a);},_initSection:function(a){var b=this.parent._initSection(a);for(var c in this.typeSections){var d=this.typeSections[c];if(b.id==d){var e=DOM.scry(b.node,'div.navHeader')[0];if(e){var f='\/bookmarks\/('+c+')(\/)?';b.seeall=this._initItem({node:e,id:b.id,endpoint:this.seeAllEndpoint,key:['bookmarks'],path:[{regex:f}]});}}}return b;},_constructItem:function(a,b){return new FutureHomeSideNavItem(a,b);},_constructSection:function(a){return new FutureHomeSideNavSection(a);},getSection:function(a){return this.typeSections[a]&&this.sections[this.typeSections[a]];},_getItemForKey:function(a){var b=this.parent._getItemForKey("nf");if(b&&b.matchKey(a)){return b;}else return this.parent._getItemForKey(a);},_isCurrentPath:function(a){return ((a.getDomain()===this.uri.getDomain())&&(a.getPath()==='default.htm'||a.getPath()==='home.php'));},_handleMenuClick:function(a,b,c,event){if(CSS.hasClass(c,'favorite')){Arbiter.inform(NavigationMessage.NAVIGATION_FAVORITE_UPDATE,{key:b.numericKey,favorite:!a.equals(this.getSection("favorites"))});}else this.parent._handleMenuClick(a,b,c,event);},removeItemByKey:function(a){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_REMOVED,a);this.parent.removeItemByKey(a);},toggleItemByKey:function(a,b){var c=this.getNodeForKey(a);if(!b){Arbiter.inform(NavigationMessage.NAVIGATION_ITEM_HIDDEN,a);c&&CSS.hide(c);}else c&&CSS.show(c);var d=this._getItemForKey(a);this.getSection(d.type).refresh();},removeItem:function(a){var b=this.getSection(a.type);this.parent.removeItem(a);b.refresh();},updateFavorite:function(a,b){var c=this._findItem(function(h){return h.matchKey(b.key)&&h.canFavorite();}),d=this.getSection("favorites"),e=bagofholding,f=b.favorite?d.addEndpoint:d.removeEndpoint;if(!c){if(b.favorite){e=function(){UIPagelet.loadFromEndpoint('PinnedNavigationPagelet','pagelet_pinned_nav');};}else e=function(){UIPagelet.loadFromEndpoint('BookmarkNavigationPagelet','pagelet_bookmark_nav');};}else{var g=this.getSection(c.type);if(b.favorite){CSS.show(c.node);this.moveItem(d,c);c.showFavorite();}else if(!g.equals(d)){this.moveItem(g,c);c.hideFavorite();}else this.removeItem(c);g.refresh();d.refresh();b.key=c.numericKey;Arbiter.inform('NavigationMessage.FAVORITES_UPDATED');}new AsyncRequest().setURI(f).setData({id:b.key}).setHandler(e).send();},_doPageTransition:function(a,b){this._unloadStreams();var c=this.parent._doPageTransition(a,b);if(c&&(a.type=='groups'||a.type=='lists'||a.type=='interests')){a.setCount(0);a.hideUnreadDot();}return c;},_unloadStreams:function(){var a=UIIntentionalStream&&UIIntentionalStream.instances,b=['nile','global','friends','blade'];a&&b.forEach(function(c){a[c]&&a[c].unload();});},navigationFirstResponse:function(){this.setSelected(this.loading);}};function FutureHomeSideNavSection(a){this.parent.construct(this,a);this.editEndpoint='ajax/bookmark/edit/default.htm';this.addEndpoint='ajax/bookmark/add/default.htm';this.removeEndpoint='ajax/bookmark/delete/default.htm';}Class.extend(FutureHomeSideNavSection,'FutureSideNavSection');FutureHomeSideNavSection.prototype={refresh:function(){var a=DOM.scry(this.node,'li.sideNavItem'),b=DOM.scry(this.node,'div.actionLinks'),c=a.some(CSS.shown);CSS.conditionShow(DOM.find(this.node,'div.navHeader'),c);b.length&&CSS.conditionShow(b[0],c);}};function FutureHomeSideNavItem(a,b){this.parent.construct(this,a,b);}Class.extend(FutureHomeSideNavItem,'FutureSideNavItem');FutureHomeSideNavItem.prototype={canFavorite:function(){return !!this._getFavoriteLabel();},showFavorite:function(){DOM.setContent(this._getFavoriteLabel(),"\u4ece\u6700\u559c\u6b22\u7684\u4e2d\u79fb\u9664");},hideFavorite:function(){DOM.setContent(this._getFavoriteLabel(),"\u6dfb\u52a0\u4e3a\u6700\u559c\u6b22\u7684");},hideUnreadDot:function(){var a=DOM.scry(this.node,'img.unreadDot')[0];a&&CSS.hide(a);},_getFavoriteLabel:function(){return DOM.scry(this.node,'li.favorite span.itemLabel')[0];}};
__e("UIIntentionalStreamMessage",[],function(a,b,c,d,e,f){var g={SET_AUTO_INSERT:'UIIntentionalStream/setAutoInsert',UPDATE_STREAM:'UIIntentionalStreamRefresh/updateStream',REFRESH_STREAM:'UIIntentionalStreamRefresh/refreshStream',UPDATE_AUTOREFRESH_CONFIG:'UIIntentionalStream/updateAutoRefreshConfig',UPDATE_HTML_CONTENT:'UIIntentionalStream/updateHtmlContent',UPDATE_LAST_REFRESH_TIME:'UIIntentionalStream/updateLastRefreshTime',INSERT_STORIES:'UIIntentionalStream/updateLastRefreshTime'};e.exports=g;});
__e("legacy:UIIntentionalStream-message",["UIIntentionalStreamMessage"],function(a,b,c,d){a.UIIntentionalStreamMessage=b('UIIntentionalStreamMessage');},3);
function HomeAdFirstRightColumnController(){}HomeAdFirstRightColumnController.prototype={init:function(a){copy_properties(this,{_enableSidebar:a.enableSidebar,_tickerHeightOffset:200,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||500),_listeners:[],_subscriptions:[]});this._topOffset=0;this.PADDING_TICKER_TO_TOP=5;this.PADDING_RHC_TO_BOTTOM=60;this._sidebarIsHidden=true;this._listeners.push(Event.listen(window,'resize',this.handleResize.bind(this)));this._blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onunloadRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',this._handleScroll.bind(this)));if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this.handleResize();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},_onNavHandler:function(a,b){var c=b.params.key;if(c!='lf'&&c!='h')this.cleanup();},reloadRightCol:function(){this.fixedScrollingContainer=ge('fixed_scrolling_container');this.fixedScrollingWrapper=DOM.scry(this.fixedScrollingContainer,'.fixed_scrolling_wrapper')[0];this.tickerPagelet=ge('pagelet_rhc_ticker');if(!this.tickerPagelet)return false;this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.each(function(a){a.remove();});this._listeners=[];},_handleScroll:function(){if(!this._sidebarIsHidden||!this.tickerStream)return;this._topOffset=this.PADDING_TICKER_TO_TOP+this._blueBarHeight;var a=CSS.hasClass(document.documentElement,'tinyViewport'),b=Vector2.getElementPosition(this.fixedScrollingContainer,'viewport').y,c=!a&&b<this._topOffset;if(c!==CSS.hasClass(this.fixedScrollingWrapper,'fixed_elem'))this._setFixedRightCol(c);},_setFixedRightCol:function(a){var b=a?this._topOffset+'px':'';CSS.setStyle(this.fixedScrollingWrapper,'top',b);CSS.conditionClass(this.fixedScrollingWrapper,'fixed_elem',a);var c=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(c);},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport'))return;this._handleScroll();var a=Vector2.getViewportDimensions().y,b=Vector2.getElementDimensions(this.fixedScrollingWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y,c=a-this._topOffset-b-this.PADDING_RHC_TO_BOTTOM,d=Vector2.getElementDimensions(this.tickerStream).y,e=Math.min(c,d,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',e+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;this.reloadRightCol();var a=function(){if(this.reloadRightCol())this.handleResize();};this.tickerPagelet&&TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this.reloadRightCol();this._setFixedRightCol(false);this.tickerPagelet&&TickerController.hide(this.tickerPagelet);}};
function HomeTickerFirstRightColumnController(){}HomeTickerFirstRightColumnController.prototype={_isFixed:false,_forcedStatic:false,_PADDING_RHC_TO_BOTTOM:75,_PADDING_RHC_TO_BOTTOM_SHORT:50,_refreshOn:false,_fixAdsOnScroll:false,init:function(a){copy_properties(this,{_adsRefreshInterval:a.adsRefreshInterval,_adsRefreshDelay:a.adsRefreshDelay,_adsRefreshOnmove:a.adsRefreshOnmove,_enableSidebar:a.enableSidebar,_fixAdsOnScroll:a.fixAdsOnScroll,contentCol:$('contentCol'),blueBar:$('blueBar'),_tickerMaxHeight:(a.tickerMaxHeight||425),_tickerMinHeight:(a.tickerMinHeight||225),_tickerAbsMinHeight:(a.tickerAbsMinHeight||120),_listeners:[],_subscriptions:[]});this._listeners.push(Event.listen(window,'resize',throttle(this.handleResize.bind(this))));this.blueBarHeight=Vector2.getElementDimensions(this.blueBar).y;this.reloadRightCol();this._initSubscriptions();onunloadRegister(this.cleanup.bind(this));this._listeners.push(Event.listen(window,'scroll',throttle(this._handleScroll.bind(this))));if(this._adsRefreshOnmove)this._listeners.push(Event.listen(window,'mousemove',throttle(this._handleMove.bind(this))));this._lastAdLoadTime=Date.now();this._debounceReloadAdsIfNeeded=debounce(this._reloadAdsIfNeeded.bind(this),this._adsRefreshDelay,true);if(!CSS.hasClass(document.documentElement,'sidebarMode')){this._onSidebarHide();}else if(this._enableSidebar)this._onSidebarShow();this._handleAdsLoad();},_handleAdsLoad:function(){var a=this.handleResize.bind(this);function b(){a.defer();}var c=DOM.scry(this.egoPagelet,'img.img');c.each(function(d){if(!d.complete)Event.listen(d,{load:b,error:b,abort:b});});b();},_initSubscriptions:function(){this._subscriptions=[Arbiter.subscribe('page_transition',this.cleanup.bind(this)),Arbiter.subscribe('Ticker/storiesInserted',this.handleResize.bind(this)),Arbiter.subscribe('concierge/load',this.handleResize.bind(this)),Arbiter.subscribe(UIIntentionalStreamMessage.INSERT_STORIES,this.handleResize.bind(this))];if(this._enableSidebar){this._subscriptions.push(Arbiter.subscribe('sidebar/hide',this._onSidebarHide.bind(this)));this._subscriptions.push(Arbiter.subscribe('sidebar/show',this._onSidebarShow.bind(this)));}},reloadRightCol:function(){this.rightColumn=DOM.scry(ge('rightCol'),'div.home_right_column')[0];this.rightColumnWrapper=DOM.find(this.rightColumn,'div.rightColumnWrapper');this.egoPagelet=ge('pagelet_ego_pane_w');if(!this.egoPagelet)this.egoPagelet=ge('pagelet_ego_pane_m');this._refreshOn=!this.containsPremium();this.tickerPagelet=ge('pagelet_rhc_ticker');if(!this.tickerPagelet)return false;this.tickerContainer=DOM.scry(this.tickerPagelet,'.ticker_container')[0];this.tickerStream=DOM.scry(this.tickerPagelet,'.ticker_stream')[0];return this.tickerContainer&&this.tickerStream;},containsPremium:function(){if(this.egoPagelet){var a=DOM.scry(this.egoPagelet,'.fbAdUnit');for(var b=0;b<a.length;b++){var c=JSON.parse(a[b].getAttribute('data-ad')).segment;if(c==='premium')return true;}}return false;},cleanup:function(){this._subscriptions.each(Arbiter.unsubscribe);this._subscriptions=[];this._listeners.each(function(a){a.remove();});this._listeners=[];this._debounceReloadAdsIfNeeded.reset();},_calculateDistanceFromTopOfRHCToTopOfAds:function(){if(this.forceFixingEvaluation||!this._isFixed)this.distanceFromTopOfRHCToTopOfAds=Vector2.getElementPosition(this.egoPagelet,'viewport').y-Vector2.getElementPosition(this.rightColumnWrapper,'viewport').y;},_handleScroll:function(){this._debounceReloadAdsIfNeeded();this._calculateDistanceFromTopOfRHCToTopOfAds();this._topOffset=this.blueBarHeight+Vector2.getElementPosition(this.blueBar,'viewport').y;var a=this._topOffset,b=Vector2.getElementPosition(this.rightColumn,'viewport').y;if(this._forcedStatic||!this.tickerStream){if(this._fixAdsOnScroll&&this.adsStickPoint!==null){var c=b+this.distanceFromTopOfRHCToTopOfAds,d=c<=a-this.adsStickPoint;if(this.forceFixingEvaluation||d!==this._isFixed){this.forceFixingEvaluation=false;var e=a-this.adsStickPoint-this.distanceFromTopOfRHCToTopOfAds;this._setFixed(d,e);}}return;}var f=b<=a;if(f!==this._isFixed)this._setFixed(f);},_handleMove:function(){this._debounceReloadAdsIfNeeded();},_reloadAdsIfNeeded:function(){var a=Date.now();if(this._refreshOn&&this._adsRefreshInterval>0&&a-this._lastAdLoadTime>=this._adsRefreshInterval)this._reloadAds();},_reloadAds:function(){this._lastAdLoadTime=Date.now();UIPagelet.loadFromEndpoint('WebEgoPane',this.egoPagelet,{pid:27,data:{organic_only:false,ads_only:false,is_refresh:true}},{crossPage:false,handler:this._handleAdsLoad.bind(this)});},_recalculateAndReposition:function(){this.forceFixingEvaluation=true;this._calculateDistanceFromTopOfRHCToTopOfAds();this._recalculateFixingPosition();this._handleScroll();},_recalculateFixingPosition:function(){if(!this._fixAdsOnScroll)return;var a=Vector2.getViewportDimensions().y-this.blueBarHeight-this._PADDING_RHC_TO_BOTTOM_SHORT,b=Vector2.getElementDimensions(this.rightColumnWrapper).y;if(b<=a){this.adsStickPoint=0-this.distanceFromTopOfRHCToTopOfAds;return;}var c=b-this.distanceFromTopOfRHCToTopOfAds;if(c<=a){this.adsStickPoint=0;}else{var d=DOM.scry(this.egoPagelet,'div.ego_unit').reverse(),e=null;for(var f=0;f<d.length;f++){var g=d[f],h=Vector2.getElementPosition(g,'viewport').y-Vector2.getElementPosition(this.rightColumnWrapper,'viewport').y,i=Vector2.getElementDimensions(this.rightColumnWrapper).y-h;if(i>a){if(f>0)e=d[f-1];break;}}if(e==null){this.adsStickPoint=null;}else this.adsStickPoint=Vector2.getElementPosition(e,'viewport').y-Vector2.getElementPosition(this.egoPagelet,'viewport').y;}},_setFixed:function(a,b){this._isFixed=a;b=b||this._topOffset;var c=a?b+'px':'';CSS.setStyle(this.rightColumnWrapper,'top',c);CSS.conditionClass(this.rightColumnWrapper,'fixed_elem',a);var d=DOM.scry(this.rightColumnWrapper,'div.displayedTickerToggleWrapper')[0];d&&CSS.conditionClass(d,'toggleWrapperWithoutMargin',this._fixAdsOnScroll&&a&&!this.tickerStream);var e=a?'Ticker/fixed':'Ticker/unfixed';Arbiter.inform(e);},handleResize:function(){if(!this._sidebarIsHidden||!this.tickerStream||CSS.hasClass(document.documentElement,'tinyViewport')){this._recalculateAndReposition();return;}this._handleScroll();var a=Vector2.getViewportDimensions().y,b=61,c=Vector2.getElementDimensions(this.rightColumnWrapper).y-Vector2.getElementDimensions(this.tickerContainer).y,d=Vector2.getElementDimensions(this.tickerStream).y,e=a-c-this._PADDING_RHC_TO_BOTTOM-this._topOffset-b,f=this._tickerAbsMinHeight,g=this._tickerMinHeight;this._forcedStatic=false;if(e<f){this._forcedStatic=true;this._setFixed(false);e=f;}else if(e<g)if(e>(g-b)){e=g;}else e+=b;var h=Math.min(e,d,this._tickerMaxHeight);CSS.setStyle(this.tickerContainer,'height',h+'px');},_onSidebarHide:function(){this._sidebarIsHidden=true;this.reloadRightCol();var a=function(){if(this.reloadRightCol()){this._forcedStatic=false;this._handleScroll();this.handleResize();}};this.tickerPagelet&&TickerController.show(this.tickerPagelet,a.bind(this));},_onSidebarShow:function(){this._sidebarIsHidden=false;this.reloadRightCol();if(this._fixAdsOnScroll){this._recalculateAndReposition();}else{this._forcedStatic=true;this._setFixed(false);}this.tickerPagelet&&TickerController.hide(this.tickerPagelet);}};
function startMessagingNavCountUpdater(a,b){var c=FutureSideNav.getInstance().getNodeForKey('inbox');if(!c)return;if(!b)var d=DOM.scry(c,'span.count')[0],e=DOM.scry(d,'span.countValue')[0],f=new CounterDisplay('messages_unread',e,d,null,null,true);var g=FutureSideNav.getInstance().getNodeForKey('other'),h=DOM.scry(g,'span.count')[0],i=DOM.scry(h,'span.countValue')[0],j=DOM.scry(h,'span.maxCountIndicator')[0];new CounterMaxDisplay('other_unseen',i,h,null,null,true).setMaxCounter(a,j);}function CounterMaxDisplay(){this._maxValue=null;this._maxIndicatorNode=null;var a=[this].concat($A(arguments));return this.parent.construct.apply(this.parent,a);}Class.extend(CounterMaxDisplay,'CounterDisplay');copy_properties(CounterMaxDisplay.prototype,{setMaxCounter:function(a,b){this._maxValue=a;this._maxIndicatorNode=b;},paint:function(){var a=this._maxValue&&this._count>this._maxValue,b=a?this._maxValue:this._count;if(this._maxIndicatorNode){DOM.setContent(this._maxIndicatorNode,a?'+':'');}else if(a)b=b+'+';DOM.setContent(this._valueNode,b);this._toggleNodes();}});
__e("legacy:contextual-thing",["ContextualThing"],function(a,b,c,d){a.ContextualThing=a.ContextualThing||b('ContextualThing');},3);
function VideoRotate(a,b){this.videoFbid=a;this.container=null;if(b){this.container=b;this.rotateButton=DOM.scry(this.container,'span.rotateButtonActions')[0];this.rotateMessage=DOM.scry(this.container,'span.rotateWait')[0];}}copy_properties(VideoRotate.prototype,{motionRotate:function(a){new AsyncRequest().setURI('ajax/motion.php').setData({v:this.videoFbid,rotate:a}).setFinallyHandler(function(b){if(this.rotateMessage&&this.rotateButton){this.rotateMessage.style.display='none';this.rotateButton.style.display='';}}.bind(this)).send();if(this.container&&this.rotateMessage&&this.rotateButton){this.rotateButton.style.display='none';this.rotateMessage.style.display='';}}});
var PhotoSnowliftAds=window.PhotoSnowliftAds||{HEIGHT_PARAM:'data-height',ADS_REFRESH_RATE:30000,ADS_REGISTER_DELAY:1000,root:null,availableDimensions:null,loadQuery:null,lastLoadTime:0,ads:null,isLogAdData:null,showSmallerAd:false,adsStatus:'null',adsEvents:{},resetEvents:function(){this.adsStatus='reset';this.adsEvents={};},addEvent:function(a,b){if(b)this.adsStatus=a;var c=Date.now();this.adsEvents[a+'_'+c]=c;},init:function(a,b,c){this.reset();this.root=a;this.snowlift=b;this.showSmallerAd=c.showsmallerad;this.addEvent('init',true);},reset:function(){this.lastLoadTime=0;this.ads=[];this.resetEvents();this.addEvent('reset',true);},resize:function(a){this.availableDimensions=a;this.loadQuery=this.snowlift.getLoadQuery();this.processResize();},updateAdsStatus:function(){var a=this.availableDimensions.x,b=this.availableDimensions.y;this.sections.forEach(function(c){var d=c.root.firstChild.offsetHeight,e=false;c.units.forEach(function(f){if(!CSS.hasClass(f,'hidden')){var g=this.getHeight(f.firstChild,a);d-=g;}}.bind(this));c.units.forEach(function(f){var g=this.getHeight(f.firstChild,a),h=b-d-g,i=h>=0;if(i||!this.showSmallerAd)d+=g;CSS.conditionClass(f,'hidden',!i);e=e||i;var j=this.getAdId(f);this.calcAdStats(j,i,h);}.bind(this));if(e)b-=d;CSS.conditionClass(c.root,'hidden',!e);}.bind(this));},calcAdStats:function(a,b,c){var d=this.ads[a],e=Date.now();if(d.visible)d.totalTime+=e-d.lastShowTime;if(d.trackingCode!==null&&d.totalTime>=this.ADS_REGISTER_DELAY){var f=d.trackingCode;d.trackingCode=null;this.registerImpression(f);}d.visible=b;d.heightBelow=c;d.lastShowTime=e;},prepareResize:function(){var a=function(b){var c=$N('div',{className:'inner'}),d=$N('div',{className:'wrapper'},c);DOM.replace(b,d);DOM.setContent(c,b);return d;};this.sections=DOM.scry(this.root,'div.ego_section').map(function(b){return {root:a(b),units:DOM.scry(b,'div.ego_unit').map(a)};});},processResize:function(){if(this.isLoading||this.lastLoadTime===0||this.availableDimensions===null){this.setLogData();return;}this.updateAdsStatus();this.setLogData();var a=this.nextRegisterTime();if(a!==Infinity)this.processResize.bind(this).defer(a,true);},setIsLogAdData:function(a){this.isLogAdData=a;this.addEvent('setIsLogAdData',false);this.setLogData();},setLogData:function(){var a=PhotoSnowlift.getImageId();if(this.isLogAdData&&a){var b=Vector2.getElementDimensions(PhotoSnowlift.getImage()),c=Vector2.getElementDimensions(PhotoSnowlift.getRHCHeader()),d=Vector2.getElementDimensions(PhotoSnowlift.getRHCBody()),e=Vector2.getElementDimensions(PhotoSnowlift.getRHCFooter());log_data={query_set:PhotoSnowlift.getLoadQuery().set,window_x:window.innerWidth,window_y:window.innerHeight,image_x:b.x,image_y:b.y,header_x:c.x,header_y:c.y,body_x:d.x,body_y:d.y,footer_x:e.x,footer_y:e.y,ads_below_space:this.getAdsBelowSpace(),time:Date.now(),adsStatus:this.adsStatus,adsEvents:this.adsEvents};PhotoSessionLog.updateAdData(a,log_data);}},getAdsBelowSpace:function(){var a=[];for(var b in this.ads)if(this.ads.hasOwnProperty(b))a.push(this.ads[b].heightBelow);return a;},getAdId:function(a){var b=DOM.find(a,'div.fbAdUnit'),c=b.getAttribute('data-ad'),d=JSON.parse(c).adid;return d;},nextRegisterTime:function(){var a=Infinity;for(var b in this.ads)if(this.ads.hasOwnProperty(b)){var c=this.ads[b];if(c.trackingCode!==null&&c.visible)a=Math.min(a,this.ADS_REGISTER_DELAY-c.totalTime);}return a;},getHeight:function(a,b){var c=a.getAttribute(this.HEIGHT_PARAM);if(c)c=JSON.parse(c);if(c&&c.x===b)return c.y;return this.cacheHeight(a,b);},cacheHeight:function(a,b){var c={x:b,y:a.offsetHeight};a.setAttribute(this.HEIGHT_PARAM,JSON.stringify(c));return c.y;},loadAds:function(){this.resetEvents();this.addEvent('adsRequested',true);UIPagelet.loadFromEndpoint('WebEgoPane',this.root.id,{pid:34,data:[this.loadQuery.set,true]},{crossPage:true});},adsLoaded:function(a){this.addEvent('adsLoaded',true);this.trackingCodes=a;var b={};for(var c in a)if(a.hasOwnProperty(c))b[c]={trackingCode:a[c],totalTime:0,lastShowTime:0,heightBelow:-10000,visible:false};this.ads=b;this.waitForImages(this.imagesLoaded.bind(this));},imagesLoaded:function(){this.prepareResize();this.addEvent('imagesLoaded',true);this.lastLoadTime=Date.now();this.isLoading=false;this.processResize();CSS.removeClass(this.root,'loading');},loadAdsFromUserActivity:function(){var a=Date.now();if(!this.isLoading&&a-this.lastLoadTime>this.ADS_REFRESH_RATE){CSS.addClass(this.root,'loading');this.isLoading=true;this.loadAds();}},registerImpression:function(a){var b=$N('iframe',{src:URI('ai.php').addQueryData({aed:a}),width:0,height:0,frameborder:0,scrolling:'no',className:'fbEmuTracking'});b.setAttribute('aria-hidden','true');DOM.appendContent(this.root,b);},waitForImages:function(a){var b=DOM.scry(this.root,'img.img'),c=b.length,d=c;if(d===0)a();var e=function(){d--;if(d===0)a.defer();};for(var f=0;f<c;f++){var g=b[f];if(g.complete){e();}else Event.listen(g,{load:e,error:e,abort:e});}}};
var PhotoSnowlift=window.PhotoSnowlift||{STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_PIXELS:'image_pixels',STATE_IMAGE_DATA:'image',CLOSE:'PhotoSnowlift.CLOSE',DATA_CHANGE:'PhotoSnowlift.DATA_CHANGE',GO:'PhotoSnowlift.GO',OPEN:'PhotoSnowlift.OPEN',PAGE:'PhotoSnowlift.PAGE',RESET_HELP:'PhotoSnowlift.RESET_HELP',LOADING_TIMEOUT:2000,PAGER_FADE:3000,COVER_RHC:500,STAGE_MAX:{x:960,y:960},STAGE_MIN:{x:520,y:520},SIDEBAR_SIZE_MAX:340,SIDEBAR_SIZE_MIN:285,STAGE_CHROME:{x:102,y:42},GOPREV_AREA:120,TIMELINE_STRETCH_WIDTH:843,TIMELINE_STRETCH_MIN:480,MIN_TAG_DISTANCE:83,ADS_REFRESH_RATE:30000,switchTimer:null,imageRefreshTimer:null,imageLoadingTimer:null,lastPage:0,currentMinSize:null,extraClass:null,currentImageSize:null,resetUriStack:true,thumbSrc:null,shouldStretch:false,stagePagerPrev:null,ua:null,isUpToViewport:false,neverShrink:false,neverShrinkHeight:false,preventRHCClick:true,fixedRHC:false,bootstrap:function(a,b){PhotoSnowliftAds.reset();this.resetUriStack=true;if(this.isOpen)if(this.openExplicitly){this.closeCleanup();this.resetUriStack=false;}else return;this.ua=user_action('snowlift',b,null).set_namespace('snowlift').set_ua_id('open');this.returningToStart=false;this.loading&&CSS.removeClass(this.loading,'loading');if(b){CSS.addClass((this.loading=b),'loading');this.getThumbAndSize(b);}else this.loading=null;Arbiter.inform(PhotoSnowlift.GO,a,Arbiter.BEHAVIOR_STATE);this.loadFrameIfUninitialized();},getRoot:function(){return this.root;},getImage:function(){return this.image;},getImageId:function(){return this.stream.getCursor();},getRHCHeader:function(){return this.rhcHeader;},getRHCBody:function(){return this.ufiForm;},getRHCFooter:function(){return this.rhcFooter;},getLoadQuery:function(){return this.loadQuery;},getThumbAndSize:function(a){this.currentImageSize=null;this.thumbSrc=null;var b=URI(a.getAttribute('ajaxify')).getQueryData();if(!b.size)return;var c=Vector2.deserialize(b.size);if(!c.x||!c.y)return;this.currentImageSize=c;if(!CSS.hasClass(a,'uiMediaThumb')&&!CSS.hasClass(a,'uiPhotoThumb')&&!CSS.hasClass(a,'uiScaledThumb'))return;var d=DOM.scry(a,'img')[0],e=DOM.scry(a,'i')[0],f=Parent.byAttribute(a,'data-size');this.shouldStretch=f&&this.currentImageSize&&d&&f.getAttribute('data-size')==="2"&&this.currentImageSize.x>this.currentImageSize.y&&this.currentImageSize.x<=PhotoSnowlift.TIMELINE_STRETCH_WIDTH&&d.offsetWidth===PhotoSnowlift.TIMELINE_STRETCH_WIDTH;if(d){thumbSrc=d.src;}else if(e){thumbSrc=CSS.getStyle(e,'backgroundImage').replace(/.*url\("?([^"]*)"?\).*/,'$1');}else return;this.thumbSrc=thumbSrc;},loadFrameIfUninitialized:function(){if(this.root)return;new AsyncRequest('/ajax/photos/snowlift/init.php').setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();},init:function(a,b){this.isUpToViewport=b.uptoviewport;this.neverShrink=b.nevershrink;this.neverShrinkHeight=b.nevershrinkheight;this.preventRHCClick=b.delayclick;this.fixedRHC=b.fixedrhc;var c=ge('fbPhotoSnowlift');if(!c){c=DOM.appendContent(DOM.getDocumentBodyElement(),a)[0];this.initialLoad=false;}if(this.root==c)return;this.initializeNodes(c);PhotoSnowliftAds.init(this.sideAdUnit,this,b);if(!this.subscription){LinkController.registerHandler(this.handleNavigateAway.bind(this));this.subscription=Arbiter.subscribe(PhotoSnowlift.GO,function(d,e){this.openExplicitly=true;this.loading&&CSS.removeClass(this.loading,'loading');this.open(e);}.bind(this));}this.transitionHandlerRegistered=false;this.returningToStart=false;PageTransitions.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;Bootloader.loadComponents(['Hovercard','live-js','photo-tag-approval','PhotoTagger','PhotoTags','TagTokenizer','ui-ufi-css']);Arbiter.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));Arbiter.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));},initializeNodes:function(a){this.root=a;this.container=DOM.find(a,'div.fbPhotoSnowliftContainer');this.popup=DOM.find(this.container,'div.fbPhotoSnowliftPopup');this.rhc=DOM.find(this.popup,'div.rhc');this.rhcHeader=DOM.find(this.rhc,'div.rhcHeader');this.rhcFooter=DOM.find(this.rhc,'div.rhcFooter');this.ufiForm=DOM.find(this.rhc,'form.fbPhotosSnowliftFeedbackForm');this.ufiInputContainer=$('fbPhotoSnowliftFeedbackInput');this.scroller=DOM.find(this.ufiForm,'div.rhcScroller');this.scrollerBody=DOM.find(this.scroller,'div.uiScrollableAreaBody');this.stageWrapper=DOM.find(this.popup,'div.stageWrapper');this.errorBox=DOM.find(this.stageWrapper,'div.stageError');this.image=DOM.find(this.stageWrapper,'img.spotlight');this.stage=DOM.find(this.stageWrapper,'div.stage');this.videoStage=DOM.find(this.stageWrapper,'div.videoStage');this.prevPager=DOM.find(this.root,'a.snowliftPager.prev');this.nextPager=DOM.find(this.root,'a.snowliftPager.next');this.stageActions=DOM.find(a,'div.stageActions');this.buttonActions=DOM.find(this.stageActions,'div.fbPhotosPhotoButtons');this.sideAdUnit=$('fbPhotoSnowliftAdsSide');},initializeScroller:function(){this.initializeScroller=bagofholding;this.scrollableArea=ScrollableArea.fromNative(this.scroller,{fade:true,persistent:true});var a=function(event){var b=$E(event).getTarget();if(DOM.contains(this.ufiInputContainer,b)){var c=TextAreaControl.getInstance(b);if(c){this.scrollableArea.scrollToBottom();var d=c.subscribe('resize',function(){var f=this.scrollableArea.isScrolledToBottom();this.adjustScroller();f&&this.scrollableArea.scrollToBottom();}.bind(this)),e=Event.listen(b,'blur',function(){c.unsubscribe(d);e.remove();});}}}.bind(this);Arbiter.subscribe(UFIOptimistic.COMMENT_SEND_EVENT,function(b,c){if(this.ufiForm===c.form){this.adjustScroller();this.scrollableArea.scrollToBottom();}}.bind(this));if(this.ufiForm.attachEvent){this.ufiForm.attachEvent('onfocusin',a);}else this.ufiForm.addEventListener('focus',a,true);},openHandler:function(a){if(this.isOpen||a.getPath()!='/photo.php'||this.returningToStart||a.getQueryData().closeTheater||a.getQueryData().permPage||a.getQueryData().makeprofile){this.openHandlerRegistered=false;return false;}this.open(a);this._uriStack.push(URI(a).getQualifiedURI().toString());PageTransitions.transitionComplete();return true;},open:function(a){var b=URI(a).getQueryData(),c=b.src;if(c)delete b.src;if(this.resetUriStack)this._uriStack=[];if(!this.initialLoad){b.firstLoad=true;this.initialLoad=true;}this.loadQuery=b;this.isOpen=true;this.pagersShown=false;this.refreshOnClose=false;this.hilitedTag=null;this.loadingStates={image:false,html:false};this.replaceUrl=false;this.stream=new PhotoStreamCache();this.stream.init(PhotosConst.VIEWER_SNOWLIFT);this.fetchInitialData();this.setLoadingState(PhotoSnowlift.STATE_HTML,true);KeyEventController.registerKey('ESCAPE',this.closeListener.bind(this));Bootloader.loadComponents(['fb-photos-photo-css','fb-photos-snowlift-css'],function(){this._open(a,c);}.bind(this));},_open:function(a,b){this.createLoader(b);CSS.show(this.root);(function(){var e=Vector2.getScrollPosition();if(!CSS.hasClass(document.documentElement,'wrapped')){CSS.addClass(document.documentElement,'theaterMode');var f=DOMScroll.getScrollbarSize();if(f===0){this.extraClass='zeroScrollbar';}else if(f===20){this.extraClass='scrollbar20';}else this.extraClass='defaultScrollbar';CSS.addClass(document.body,this.extraClass);}DOMScroll.scrollTo(e,0);}).defer();this.ua&&this.ua.add_event('frame');Arbiter.inform('layer_shown',{type:'PhotoSnowlift'});Arbiter.inform(PhotoSnowlift.OPEN);this.stageHandlers=[Event.listen(window,'resize',this.adjustForResize.bind(this)),Event.listen(this.root,'click',this.closeListener.bind(this)),Event.listen(this.stageWrapper,'click',this.buttonListener.bind(this)),Event.listen(this.stageWrapper,'mouseleave',this.hidePagers.bind(this)),Event.listen(this.stageWrapper,'mousemove',this.hilitePagerOnMouseMove.bind(this)),Event.listen(this.stageWrapper,'mousemove',this.hiliteTagsOnMouseMove.bind(this))];var c=ge('fbPhotoSnowliftFeedback');if(c)this.stageHandlers.push(Event.listen(c,'click',function(event){if(Parent.byClass(event.getTarget(),'like_link')){var e=DOM.scry(this.buttonActions,'a.fbPhotosPhotoLike')[0];if(e){CSS.toggleClass(e,'viewerLikesThis');CSS.removeClass(e,'viewerAlreadyLikedThis');}}}.bind(this)));var d=ge('fbPhotoSnowliftOnProfile');if(d)this.stageHandlers.push(Event.listen(d,'click',function(event){if(Parent.byClass(event.getTarget(),'fbPhotoRemoveFromProfileLink'))this.refreshOnClose=true;}.bind(this)));if(this.resetUriStack)this.startingURI=URI.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI();if(!b)this.setLoadingState(PhotoSnowlift.STATE_IMAGE_DATA,true);if(!this.transitionHandlerRegistered){PageTransitions.registerHandler(this.transitionHandler.bind(this));this.transitionHandlerRegistered=true;}PhotoSessionLog.initLogging(PhotoSessionLog.SNOWLIFT);if(ua.firefox()&&!CSS.hasClass(document.documentElement,'wrapped'))this.turnFlashAutoplayOff.defer();(function(){this.root.focus();}).bind(this).defer();},getStream:function(){return this.stream;},fetchInitialData:function(){this.ua&&this.ua.add_event('init_data');UIPagelet.loadFromEndpoint('PhotoViewerInitPagelet',null,this.loadQuery,{usePipe:true,jsNonblock:true,crossPage:true});},turnFlashAutoplayOff:function(){DOM.scry(document,'div.swfObject').each(function(a){var b=a.getAttribute('data-swfid');if(b&&window[b]){var c=window[b];c.addParam('autostart','false');c.addParam('autoplay','false');c.addParam('play','false');c.addVariable('video_autoplay','0');c.addVariable('autoplay','0');c.addVariable('play','0');var d=URI(c.getAttribute('swf'));d.addQueryData({autoplay:'0'});d.setPath(d.getPath().replace('autoplay=1','autoplay=0'));c.setAttribute('swf',d.toString());c.write(a);}});},closeHandler:function(){if(!this.isOpen)return;if(URI.getMostRecentURI().addQueryData({closeTheater:1}).getUnqualifiedURI().toString()==this.startingURI.toString()){this.close();return;}this.close();this.returnToStartingURI(this.refreshOnClose);},returnToStartingURI:function(a,b){if(!a)if(b){this.squashNextTransition(goURI.curry(b));}else this.squashNextTransition();this.returningToStart=true;var c=Arbiter.subscribe('page_transition',function(){this.returningToStart=false;Arbiter.unsubscribe(c);}),d=a||isNaN(ua.opera()),e=this._uriStack.length;if(d&&e<window.history.length){window.history.go(-e);}else{var f=PhotoSnowlift.startingURI,g=new URI(f).removeQueryData('closeTheater');if(f.getQueryData().sk=='approve'&&f.getPath()=='/profile.php'){g.removeQueryData('highlight');g.removeQueryData('notif_t');}goURI(g);}},squashNextTransition:function(a){PhotoSnowlift.squashNext=true;PageTransitions.registerHandler(function _squash(){if(PhotoSnowlift.squashNext){PhotoSnowlift.squashNext=false;if(a)a.defer();PageTransitions.transitionComplete();return true;}return false;});},handleNavigateAway:function(a){var b=computeRelativeURI(window.PageTransitions._most_recent_uri.getQualifiedURI(),a.getAttribute('href'));if(this.isOpen&&(b instanceof URI)&&b.getUnqualifiedURI().toString()!=this.startingURI.toString()&&b.getPath()!='/photo.php'){if(!this.closingAction)this.closingAction=PhotoSessionLog.NAVIGATE;this.close();this.returnToStartingURI(false,b);return false;}return true;},closeListener:function(event){if(this.isOpen&&!(window.Dialog&&Dialog.getCurrent())){var a=event.getTarget(),b=Parent.byClass(a,'closeTheater'),c=b||(!Parent.byClass(a,'snowliftPager')&&!ContextualThing.containsIncludingLayers(this.container,a));if(c){if(b){this.closingAction=PhotoSessionLog.X;}else this.closingAction=PhotoSessionLog.OUTSIDE;Event.kill(event);this.closeHandler();}else if(Event.getKeyCode(event)==KEYS.ESC){this.closingAction=PhotoSessionLog.ESC;Event.kill(event);this.closeHandler();}}},close:function(){if(!this.isOpen)return;CSS.hide(this.root);this.openExplicitly=false;this.closeCleanup.bind(this).defer();},closeCleanup:function(){var a=Vector2.getScrollPosition();if(!CSS.hasClass(document.documentElement,'wrapped')){CSS.removeClass(document.documentElement,'theaterMode');CSS.removeClass(document.body,this.extraClass);}CSS.removeClass(this.root,'dataLoaded');DOMScroll.scrollTo(a,0);KeyEventController.getInstance().resetHandlers();PhotoSessionLog.logPhotoViews(this.closingAction);this.destroy();CSS.hide(this.errorBox);CSS.hide(this.image);this.currentImageSize=null;this.thumbSrc=null;this.shouldStretch=false;this.resetUriStack=true;CSS.removeClass(this.stageWrapper,'showVideo');DOM.empty(this.videoStage);this.currentMinSize=null;this.setStagePagersState('reset');this.recacheData();DOM.empty(this.sideAdUnit);this.stream.destroy();var b=this.closingAction===PhotoSessionLog.NAVIGATE;this.closingAction=null;if(!this.openHandlerRegistered){PageTransitions.registerHandler(this.openHandler.bind(this));this.openHandlerRegistered=true;}Arbiter.inform('layer_hidden',{type:'PhotoSnowlift'});Arbiter.inform(PhotoSnowlift.CLOSE,b);this.root.setAttribute('aria-busy','true');this.isOpen=false;},createLoader:function(a){if(this.thumbSrc!==null&&this.currentImageSize!==null){var b=this.getStageSize(this.currentImageSize),c=this.getImageSizeInStage(this.currentImageSize,b);this.useImage($N('img',{className:'spotlight',alt:'',src:this.thumbSrc,style:{width:c.x+'px',height:c.y+'px'}}),c,false);}else if(this.currentImageSize===null)this.adjustStageSize(PhotoSnowlift.STAGE_MIN);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);if(a)(function(){var d=new Image();d.onload=async_callback(function(){if(this.isOpen)if(!this.stream||!this.stream.errorInCurrent()){this.switchImage(a,this.currentImageSize);this.ua&&this.ua.add_event('image');this.setLoadingState(PhotoSnowlift.STATE_IMAGE_DATA,false);}}.bind(this),'photo_theater');d.src=a;}).bind(this).defer();CSS.hide(this.stageActions);this.setStagePagersState('disabled');},initDataFetched:function(a){PhotoSessionLog.setPhotoSet(this.stream.getPhotoSet());PhotoSessionLog.setLogFbids(a.logids);PhotoSessionLog.addPhotoView(this.stream.getCurrentImageData().info);this.position=this.stream.getCursor();if(!this.pageHandlers){this.pageHandlers=values(Event.listen(this.root,{click:this.pageListener.bind(this),mouseleave:this.mouseLeaveListener.bind(this)}));KeyEventController.registerKey('LEFT',this.pageListener.bind(this));KeyEventController.registerKey('RIGHT',this.pageListener.bind(this));}CSS.show(this.stageActions);this.root.setAttribute('aria-busy','false');this.isLoggedInViewer=a.loggedin;this.disableAds=!this.isLoggedInViewer||a.fromad;this.loadAds();},adjustScrollerIfNecessary:function(){clearTimeout(this.scrollerTimeout);this.scrollerTimeout=this.adjustScroller.bind(this).defer();},adjustScroller:function(){clearTimeout(this.scrollerTimeout);this.initializeScroller();this.scrollableArea.resize();var a=Vector2.getElementDimensions(this.rhc),b=a.y;b-=Vector2.getElementDimensions(this.rhcHeader).y;b-=Vector2.getElementDimensions(this.ufiInputContainer).y;var c=Vector2.getElementDimensions(this.scrollerBody).y;if(c>=b){CSS.setStyle(this.scroller,'height',b+'px');CSS.addClass(this.rhc,'pinnedUfi');b=0;}else{CSS.setStyle(this.scroller,'height','auto');CSS.removeClass(this.rhc,'pinnedUfi');b-=c;}var d=Vector2.getElementDimensions(this.ufiInputContainer).y;CSS.setStyle(this.ufiForm,'padding-bottom',d+'px');PhotoSnowliftAds.resize(new Vector2(a.x,b));this.scrollableArea.adjustGripper();},adjustForResize:function(){this.currentMinSize=null;this.adjustStageSize();this.adjustForNewData();},getStageSize:function(a,b){var c=Vector2.getViewportDimensions(),d=new Vector2(a.x,a.y);if(b){if(this.neverShrink&&d.x<b.x)d.x=b.x;if(this.neverShrinkHeight&&d.y<b.y)d.y=b.y;}var e=this.fixedRHC?PhotoSnowlift.SIDEBAR_SIZE_MAX:PhotoSnowlift.SIDEBAR_SIZE_MIN,f=Math.min(d.x,PhotoSnowlift.STAGE_MAX.x,c.x-e-PhotoSnowlift.STAGE_CHROME.x),g=Math.min(d.y,PhotoSnowlift.STAGE_MAX.y,c.y-PhotoSnowlift.STAGE_CHROME.y);if(f===0&&g===0)return new Vector2(0,0);var h=f/g,i=d.x/d.y;if(h<i)return new Vector2(f,Math.ceil(f/i));return new Vector2(Math.ceil(g*i),g);},getImageSizeInStage:function(a,b){var c=a.x,d=a.y;if(a.x>=b.x||a.y>=b.y){var e=b.x/b.y,f=a.x/a.y;if(e<f){c=b.x;d=Math.ceil(c/f);}else if(e>f){d=b.y;c=Math.ceil(d*f);}else{c=b.x;d=b.y;}}return new Vector2(c,d);},getSidebarWidth:function(a){if(this.fixedRHC)return PhotoSnowlift.SIDEBAR_SIZE_MAX;var b=Vector2.getViewportDimensions(),c=b.x-PhotoSnowlift.STAGE_CHROME.x-a.x;return Math.max(PhotoSnowlift.SIDEBAR_SIZE_MIN,Math.min(PhotoSnowlift.SIDEBAR_SIZE_MAX,c));},adjustStageSize:function(a){var b=this.currentImageSize;if(a){b=a;}else{var c=this.stream&&this.stream.getCurrentImageData();if(c&&c.dimensions)b=c.dimensions;}this.currentImageSize=b;if(this.shouldStretch&&!this.getVideoOnStage()&&b.x>b.y&&b.x<=PhotoSnowlift.TIMELINE_STRETCH_WIDTH&&b.x>=PhotoSnowlift.TIMELINE_STRETCH_MIN){b.y=Math.round(b.y*PhotoSnowlift.TIMELINE_STRETCH_WIDTH/b.x);b.x=PhotoSnowlift.TIMELINE_STRETCH_WIDTH;}var d=this.getStageSize(b,this.currentMinSize),e=0,f=0;if(this.currentMinSize){if(this.neverShrink)e=this.currentMinSize.x;if(this.neverShrinkHeight)f=this.currentMinSize.y;}this.currentMinSize=new Vector2(Math.max(d.x,PhotoSnowlift.STAGE_MIN.x,e),Math.max(d.y,PhotoSnowlift.STAGE_MIN.y,f));if(this.isUpToViewport){var g=Vector2.getViewportDimensions(),h=this.STAGE_CHROME.y;this.currentMinSize.y=Math.max(this.currentMinSize.y,Math.min(720,g.y-h));}var i=this.getSidebarWidth(this.currentMinSize);this.popup.style.cssText='width:'+(this.currentMinSize.x+i)+'px;'+'height:'+this.currentMinSize.y+'px;';var j=this.currentMinSize.y+'px';if(ua.firefox()||ua.ie()<8){var k=CSS.getStyle(this.stageWrapper,'font-size');if(ua.ie()&&k.indexOf('px')<0){var l=$N('div');l.style.fontSize=k;l.style.height='1em';k=l.style.pixelHeight;}j=(this.currentMinSize.y/parseFloat(k))+'em';}this.stageWrapper.style.cssText='width:'+this.currentMinSize.x+'px;'+'line-height:'+j+';';if(ua.ie()<8)CSS.setStyle(this.container,'min-height',(this.currentMinSize.y+PhotoSnowlift.STAGE_CHROME.y)+'px');var m=this.getImageSizeInStage(b,this.currentMinSize);this.image.style.cssText='width:'+m.x+'px;'+'height:'+m.y+'px;';this.adjustScrollerIfNecessary();},adjustForNewData:function(){if(!this.image)return;var a=DOM.scry(this.stage,'div.tagsWrapper')[0],b=Vector2.getElementDimensions(this.image);if(a){CSS.setStyle(a,'width',b.x+'px');CSS.setStyle(a,'height',b.y+'px');if(ua.ie()<=7){var c=DOM.scry(this.root,'div.tagContainer')[0];if(c)CSS.conditionClass(a,'ie7VerticalFix',Vector2.getElementDimensions(c).y>b.y);}}},setLoadingState:function(a,b){switch(a){case PhotoSnowlift.STATE_IMAGE_PIXELS:CSS.conditionClass(this.root,'imagePixelsLoading',b);break;case PhotoSnowlift.STATE_IMAGE_DATA:this.loadingStates[a]=b;CSS.conditionClass(this.root,'imageLoading',b);break;case PhotoSnowlift.STATE_HTML:this.loadingStates[a]=b;CSS.conditionClass(this.root,'dataLoading',b);this.rhc.setAttribute('aria-busy',b?'true':'false');break;}},destroy:function(){this.stageHandlers.each(function(a){a.remove();});if(this.pageHandlers){this.pageHandlers.each(function(a){a.remove();});this.pageHandlers=null;}},checkState:function(a){if(a!=PhotoSnowlift.STATE_ERROR&&!this.loadingStates[a])return;switch(a){case PhotoSnowlift.STATE_IMAGE_DATA:var b=this.stream.getCurrentImageData();if(b){if(b.url){this.switchImage(b.url,null,true);}else if(b.video)this.switchVideo(b.video,true);this.setLoadingState(a,false);}break;case PhotoSnowlift.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(a,false);}break;default:if(this.stream.errorInCurrent()){CSS.hide(this.image);CSS.show(this.errorBox);}break;}},buttonListener:function(event){var a=event.getTarget(),b=Date.now();if(Parent.byClass(a,'fbPhotoTagApprovalBox'))return;if(b-this.lastPage<350)return;if(Parent.byClass(a,'fbPhotosPhotoLike')){PhotoSessionLog.addButtonLike();DOM.find($('fbPhotoSnowliftFeedback'),'button.like_link').click();}else if(Parent.byClass(a,'tagApproveIgnore'))this.updateTagBox(event,a);},rotateListener:function(event){var a=event.getTarget();if(Parent.byClass(a,'rotateRight')){this.rotate('right');}else if(Parent.byClass(a,'rotateLeft'))this.rotate('left');},updateTagBox:function(a,b){this.unhiliteAllTags();var c=ge(a);if(!c)return;CSS.addClass(c,'tagBox');CSS.addClass(c,'tagBoxPendingResponse');CSS.removeClass(c,'tagBoxPending');CSS.hide(DOM.find(c,'span.tagForm'));if(b){CSS.show(DOM.find(c,'span.tagApproved'));}else CSS.show(DOM.find(c,'span.tagIgnored'));},rotate:function(a){var b=this.stream.getCursor();if(this.getVideoOnStage()){var c=(a=='left')?270:90;Bootloader.loadComponents(['video-rotate-viewer'],new VideoRotate(b).motionRotate(c));return;}var d={fbid:b,cs_ver:PhotosConst.VIEWER_SNOWLIFT};d[a]=1;this.setLoadingState(PhotoSnowlift.STATE_IMAGE_DATA,true);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);CSS.hide(this.image);new AsyncRequest('/ajax/photos/photo/rotate/').setAllowCrossPageTransition(true).setData(d).setErrorHandler(this.rotationError.bind(this,b)).setHandler(this.rotationComplete.bind(this,b)).setMethod('POST').setReadOnly(false).send();},rotationComplete:function(a,b){this.storeResponseForRotate(a,b);if(a==this.stream.getCursor()){this.setLoadingState(PhotoSnowlift.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);this.swapData();}},storeResponseForRotate:function(a,b){this.storeFromResponse(b);var c=this.stream.getImageData(a);c.url=b.getPayload().new_urls[PhotosConst.SIZE_NORMAL];c.dimensions=Vector2.deserialize(b.getPayload().dimensions);},rotationError:function(a,b){if(a==this.stream.getCursor()){this.setLoadingState(PhotoSnowlift.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);AsyncResponse.defaultErrorHandler(b);}},saveTagComplete:function(a){this.saveTagsFromPayload(a.getPayload());},saveTagsFromPayload:function(a){this.storeFromData(a);if('data' in a&&this.stream.getCursor() in a.data)this.swapData();},saveEdit:function(){if(!CSS.hasClass(this.root,'fbPhotoSnowliftEditMode'))return;Bootloader.loadComponents(['PhotoInlineEditor','Form'],function(){var a=PhotoInlineEditor.getInstance(PhotosConst.VIEWER_SNOWLIFT);a&&Form.bootstrap(a.getForm().controller);});},mouseLeaveListener:function(event){this.unhiliteAllTags();this.reHilitePendingTag();},hilitePagerOnMouseMove:function(event){var a=Vector2.getEventPosition(event),b=Vector2.getElementPosition(this.stage);if(intl_locale_is_rtl()){var c=Vector2.getElementDimensions(this.stage);this.stagePagerPrev=c.x-(a.x-b.x)<PhotoSnowlift.GOPREV_AREA;}else this.stagePagerPrev=a.x-b.x<PhotoSnowlift.GOPREV_AREA;CSS.conditionClass(this.prevPager,'hilightPager',this.stagePagerPrev);CSS.conditionClass(this.nextPager,'hilightPager',!this.stagePagerPrev);var d,e=event.getTarget();if(!Parent.byClass(e,'snowliftOverlayBar')&&!Parent.byClass(e,'snowliftPager'))d=PhotoSnowlift.PAGER_FADE;this.showPagers(d);},showPagers:function(a){clearTimeout(this.fadePagerTimer);this.setStagePagersState('active');if(typeof a!=='undefined')this.fadePagerTimer=this.hidePagers.bind(this).defer(a);},hidePagers:function(){clearTimeout(this.fadePagerTimer);this.setStagePagersState('inactive');},unhiliteAllTags:function(){DOM.scry(this.stage,'div.tagsWrapper div.hover').each(function(a){CSS.removeClass(a,'hover');});this.hilitedTag=null;},switchHilitedTags:function(a,b){if(this.switchTimer!==null){clearTimeout(this.switchTimer);this.switchTimer=null;}this.unhiliteAllTags();var c=ge(a);if(c){this.hilitedTag=a;CSS.addClass(c,'hover');if(CSS.hasClass(c,'tagBoxPending')&&!CSS.hasClass(c,'showPendingTagName')&&b===true){DOM.scry(this.stage,'div.tagsWrapper div.showPendingTagName').each(function(d){CSS.removeClass(d,'showPendingTagName');});CSS.addClass(c,'showPendingTagName');}}},reHilitePendingTag:function(){var a=ge(this.hilitedTag);if(a&&CSS.hasClass(a,'showPendingTagName'))return;var b=DOM.scry(this.stage,'div.tagsWrapper div.showPendingTagName')[0];if(b)this.switchHilitedTags(b.id);},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.switchTimer!==null)return;var a=event.getTarget();if(Parent.byClass(a,'fbPhotoSnowliftTagApproval'))return;var b=Parent.byClass(a,'tagBoxPending'),c=(this.hilitedTag&&CSS.hasClass($(this.hilitedTag),'tagBoxPending')),d=((!this.hilitedTag&&b)||(!c&&b));if(d){this.switchHilitedTags(b.id);return;}if(b&&(b.id==this.hilitedTag))return;var e=250,f=Vector2.getEventPosition(event),g=Vector2.getElementPosition(this.image),h=Vector2.getElementDimensions(this.image),i=this.stream.getCurrentImageData().dimensions,j=h.x/i.x,k=PhotosUtils.getNearestBox(f,g,i,j,PhotoSnowlift.MIN_TAG_DISTANCE*j,this.stream.getCurrentExtraData().tagRects);if(!k){if(!c){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var l=null;if(c){var m={};m[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];l=PhotosUtils.getNearestBox(f,g,i,j,PhotoSnowlift.MIN_TAG_DISTANCE*j,m);}if(l!==null&&c)return;if(this.hilitedTag!=k)if(c){this.switchTimer=this.switchHilitedTags.bind(this,k).defer(e);}else this.switchHilitedTags(k);},getVideoOnStage:function(){var a=this.stream&&this.stream.getCurrentImageData();return a&&a.video;},shouldPageOnAction:function(a,b){var c=DOM.isNode(b)&&(Parent.byClass(b,'snowliftPager')||Parent.byClass(b,'stagePagers')),d=DOM.isNode(b)&&Parent.byClass(b,'stage'),e=((d&&CSS.hasClass(this.root,'taggingMode'))||Parent.byClass(b,'tagBoxPending')||Parent.byClass(b,'tagBoxPendingResponse')||Parent.byClass(b,'fbPhotoTagApprovalBox'));if(e)return false;return a==KEYS.LEFT||a==KEYS.RIGHT||c||d;},pageListener:function(event){var a=Event.getKeyCode(event),b=event.getTarget();if(!this.shouldPageOnAction(a,b))return;var c=0;if(a==KEYS.RIGHT){c=1;PhotoSessionLog.setPagingAction('key_right');}else if(a==KEYS.LEFT){c=-1;PhotoSessionLog.setPagingAction('key_left');}else if(Parent.byClass(b,'next')){c=1;PhotoSessionLog.setPagingAction('click_next');}else if(Parent.byClass(b,'prev')){c=-1;PhotoSessionLog.setPagingAction('click_prev');}else if(!this.stagePagerPrev){c=1;PhotoSessionLog.setPagingAction('click_stage');}else{c=-1;PhotoSessionLog.setPagingAction('click_stage_back');}this.page(c);user_action('a',b,event);},page:function(a,b){if(!this.stream.isValidMovement(a)){this.showPagers(PhotoSnowlift.PAGER_FADE);return;}this.lastPage=Date.now();this.unhiliteAllTags();var c=this.getVideoOnStage();if(c)this.switchVideo(c,false);Arbiter.inform(PhotoSnowlift.PAGE);this.recacheData();this.stream.moveCursor(a);CSS.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(PhotoSnowlift.STATE_HTML,true);CSS.show(this.errorBox);return;}var d=this.stream.getCurrentImageData();if(d){if(d.url){this.switchImage(d.url,null,true);}else if(d.video)this.switchVideo(d.video,true);if(!b){this.replaceUrl=true;goURI(d.info.permalink);}}else{this.setLoadingState(PhotoSnowlift.STATE_IMAGE_PIXELS,true);this.setLoadingState(PhotoSnowlift.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(PhotoSnowlift.STATE_HTML,true);this.disableAds=!this.isLoggedInViewer;this.loadAds();if(this.preventRHCClick)this.delayRHCClick();},logImpressionDetailsForPhoto:function(){var a=[].concat(DOM.scry($('fbPhotoSnowliftTagList'),'input.photoImpressionDetails'),DOM.scry($('fbPhotoSnowliftFeedback'),'input.photoImpressionDetails'));if(a.length===0)return;var b={};for(var c=0;c<a.length;c++)b[a[c].name]=a[c].value;if(this.getVideoOnStage()){b.width=0;b.height=0;}else{b.width=this.stream.getCurrentImageData().dimensions.x;b.height=this.stream.getCurrentImageData().dimensions.y;}PhotoSessionLog.addDetailData(this.stream.getCursor(),b);PhotoSnowliftAds.setIsLogAdData(true);},loadAds:function(){if(this.disableAds)return;PhotoSnowliftAds.loadAdsFromUserActivity();},delayRHCClick:function(){var a=$('snowliftCoverRhc');clearTimeout(this.coverRhcTimer);CSS.show(a);this.coverRhcTimer=CSS.hide.bind(null,a).defer(PhotoSnowlift.COVER_RHC);},transitionHandler:function(a){if(a.getQueryData().closeTheater||a.getQueryData().permPage||a.getQueryData().makeprofile||this.returningToStart){if(this.isOpen)this.close();this.transitionHandlerRegistered=false;return false;}if(this.replaceUrl){this.replaceUrl=false;this._uriStack.push(a.getQualifiedURI().toString());PageTransitions.transitionComplete();return true;}var b=this._uriStack.length;if(b>=2&&this._uriStack[b-2]==a.getQualifiedURI().toString())this._uriStack.pop();var c=this.stream.getCursorForURI(a.getUnqualifiedURI().toString());if(c){var d=this.stream.getRelativeMovement(c);this.page(d,true);PageTransitions.transitionComplete();return true;}if(this.isOpen){this.close();PageTransitions.transitionComplete();return true;}this.transitionHandlerRegistered=false;return false;},recacheData:function(){if(!this.loadingStates.html){var a=this.stream.getCurrentHtml();for(var b in a){a[b]=$A($(b).childNodes);DOM.empty($(b));}}},reloadIfTimeout:function(){if(!image_has_loaded(this.image)){var a=this.makeNewImage(this.image.src,true);Event.listen(a,'load',this.useImage.bind(this,a,null,true));}},useImage:function(a,b,c){if(c&&image_has_loaded(this.image))return;DOM.replace(this.image,a);this.image=a;this.adjustStageSize(b);},makeNewImage:function(a,b){if(this.imageLoadingTimer){clearTimeout(this.imageLoadingTimer);this.imageLoadingTimer=null;}else if(!b)this.imageRefreshTimer=setTimeout(this.reloadIfTimeout.bind(this),PhotoSnowlift.LOADING_TIMEOUT);var c=$N('img',{className:'spotlight',alt:''});c.setAttribute('aria-describedby','fbPhotosSnowliftCaption');c.setAttribute('aria-busy','true');Event.listen(c,'load',async_callback(function(){clearTimeout(this.imageRefreshTimer);this.image.setAttribute('aria-busy','false');this.setLoadingState(this.STATE_IMAGE_PIXELS,false);(function(){if(this.isOpen){this.adjustStageSize();this.adjustForNewData();}}).bind(this).defer();}.bind(this),'photo_theater'));c.src=a;return c;},switchImage:function(a,b,c){CSS.hide(this.image);CSS.hide(this.errorBox);this.setLoadingState(this.STATE_IMAGE_PIXELS,true);var d=this.stream&&this.stream.getCurrentImageData();if(d)PhotoSessionLog.addPhotoView(d.info);this.useImage(this.makeNewImage(a,false),b,false);if(c)this.stream.preloadImages();},switchVideo:function(a,b){var c='swf_'+a;if(b){CSS.addClass(this.stageWrapper,'showVideo');this.videoStage.id=a;if(window[c]&&!ge(c))window[c].write(a);this.adjustStageSizeForVideo.bind(this,c).defer();}else{this.videoStage.id='fbVideoStage';window[c]&&window[c].addVariable('video_autoplay',0);this.videoLoadTimer&&clearTimeout(this.videoLoadTimer);DOM.empty(this.videoStage);CSS.removeClass(this.stageWrapper,'showVideo');}},checkVideoStatus:function(a){if(this.videoLoadTimer)clearTimeout(this.videoLoadTimer);video=this.getVideoOnStage();if(!video){return;}else{currentSwfID='swf_'+video;if(a!==currentSwfID)return;this.adjustStageSizeForVideo(a);}},adjustStageSizeForVideo:function(a){var b=ge(a);if(!b){this.videoLoadTimer=setTimeout(this.checkVideoStatus.bind(this,a),200);}else this.adjustStageSize(new Vector2(b.width,b.height));},setErrorBoxContent:function(a){DOM.setContent(this.errorBox,a);},swapData:function(){var a,b=this.stream.getCurrentHtml();if(b){this.setLoadingState(PhotoSnowlift.STATE_HTML,false);for(var c in b){a=ge(c);a&&DOM.setContent(a,b[c]);}var d=DOM.scry($('fbPhotoSnowliftCaption'),'div.fbPhotoInlineCaptionEditor');if(d.length)new PhotoInlineCaptionEditor('snowlift').init(d[0]);Arbiter.inform(PhotoSnowlift.DATA_CHANGE,this.stream.getCurrentImageData().info,Arbiter.BEHAVIOR_STATE);this.position=this.stream.getCursor();}this.showPagers(PhotoSnowlift.PAGER_FADE);this.adjustScroller();this.scrollableArea.showScrollbar(false);this.adjustForNewData();this.logImpressionDetailsForPhoto();},updateTotalCount:function(a,b,c){var d=$('fbPhotoSnowliftPositionAndCount'),e=HTML(c).getRootNode();DOM.replace(d,e);d=e;var f=this.stream.getCurrentHtml();if(f){f.fbPhotoSnowliftPositionAndCount=$A(d.childNodes);this.stream.setTotalCount(a);this.stream.setFirstCursorIndex(b);}},addPhotoFbids:function(a,b,c){var d=this.stream.getCursor()===null;this.stream.attachToFbidsList(a,b,c);if(c&&d)this.page(0,true);if(!this.pagersShown&&this.stream.canPage())this.setStagePagersState('ready');},storeFromResponse:function(a){window.ArbiterMonitor&&ArbiterMonitor.stopTtiMeasurement();this.storeFromData(a.getPayload());},storeFromData:function(a){if(!this.isOpen)return;var b=this.stream.storeToCache(a);if('error' in b){this.checkState(PhotoSnowlift.STATE_ERROR);return;}if('init' in b){this.initDataFetched(b.init);if(this.openExplicitly){this.replaceUrl=true;goURI(this.stream.getCurrentImageData().info.permalink);}if(this.stream.canPage())this.setStagePagersState('ready');this.ua&&this.ua.add_event('ufi');}if('image' in b)this.checkState(PhotoSnowlift.STATE_IMAGE_DATA);if('data' in b)this.checkState(PhotoSnowlift.STATE_HTML);},setStagePagersState:function(a){switch(a){case 'ready':CSS.addClass(this.root,'pagingReady');this.pagersShown=true;this.ua&&this.ua.add_event('arrows');return;case 'active':CSS.addClass(this.root,'pagingActivated');return;case 'inactive':CSS.removeClass(this.root,'pagingActivated');return;case 'disabled':case 'reset':CSS.removeClass(this.root,'pagingReady');return;}},deletePhoto:function(a){this.closeRefresh();},closeRefresh:function(){this.refreshOnClose=true;this.closeHandler();},onHiliteTag:function(a,b){if(b.version!=PhotosConst.VIEWER_SNOWLIFT)return;id=b.tag;if(id){this.switchHilitedTags(id,true);}else this.unhiliteAllTags();},onUpdateTagBox:function(a,b){if(b.version==PhotosConst.VIEWER_SNOWLIFT)this.updateTagBox(b.id,b.approve);}};
function UIIntentionalStream(a,b,c,d,e,f,g,h,i,j,k,l,m,n){if(!a)throw new Error('UIIntentionalStream instantiated with no root.');copy_properties(this,{id:a.id,root:a,instanceName:b,newest:c,oldest:d,oldestMR:d,firstLoadIDs:h,shouldShowHidden:false,defaultFilter:e,currentFilterKey:j,sourceType:f,lastSeenTime:k,hasPendingRefresh:false,pauseAutoInsert:false,error:DOM.scry(a,'div.UIIntentionalStream_Error')[0],pager:DOM.scry(a,'div.uiMorePager')[0],filterNullState:DOM.scry(a,'div.friendListFilterNullState')[0],streamContent:DOM.find(a,'.UIIntentionalStream_Content'),requestNum:0,scrollLoadCount:1,maxScrollLoadCount:1,lastViewStateID:0,shouldRenderCount:n,scrollListener:null,conowingoCount:0,conowingoNewest:0});onleaveRegister(this.unload.bind(this));if(!UIIntentionalStream.instances)UIIntentionalStream.instances={};UIIntentionalStream.instances[b]=this;UIIntentionalStream.instance=this;this.setupAutoInsert();this.setupSubscriptions();}UIIntentionalStream.isHighlightsFilter=function(a){if(!a)return false;var b=a.startsWith(UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS);return b;};UIIntentionalStream.prototype.subscribeToComposerPublish=function(){this.subscriptions.push(Arbiter.subscribe('composer/publish',function(event,a){if(a.streamStory)this.addComposerContent(a.streamStory,500);}.bind(this)));};UIIntentionalStream.prototype.setupSubscriptions=function(){this.subscriptions=[];this.subscribeToComposerPublish();this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,this.updateStream.bind(this)));this.subscriptions.push(Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,this.refreshStream.bind(this)));this.scrollListener=Event.listen(window,'scroll',this.checkScroll.bind(this));this.checkScroll();};UIIntentionalStream.prototype.tearDownSubscriptions=function(){if(!this.subscriptions)return;this.subscriptions.forEach(Arbiter.unsubscribe);this.subscriptions=null;if(this.scrollListener){this.scrollListener.remove();this.scrollListener=null;}};UIIntentionalStream.prototype.unload=function(){this.tearDownSubscriptions();UIIntentionalStream.instance=null;UIIntentionalStream.instances[this.instanceName]=null;this.clearScrollLoader(true);window.disableScrollLoad=null;UIIntentionalStreamRefresh.instance&&UIIntentionalStreamRefresh.instance.unload();};UIIntentionalStream.getInstance=function(a){return UIIntentionalStream.instances[a];};UIIntentionalStream.prototype._getUpdateInsertType=function(){if(this.isOnNewHighlights()&&(!this.boulderFeed||this.shouldRenderCount))return UIIntentionalStream.REFRESH_COUNT;return UIIntentionalStream.REFRESH_PREPEND;};UIIntentionalStream.prototype.updateStream=function(a){if(a!=UIIntentionalStreamMessage.UPDATE_STREAM||this.hasPendingRefresh||this.isAutoRefreshPaused())return;this.loadNewer({showLoader:false,ignoreSelf:true,insertType:this._getUpdateInsertType()});};UIIntentionalStream.prototype.clearScrollLoader=function(a){if(this.currentScrollListener){this.currentScrollListener.remove();this.currentScrollListener=null;}if(a||this.scrollLoadCount>=this.maxScrollLoadCount)window.disableScrollLoad=true;};UIIntentionalStream.prototype.loadOlderPosts=function(a){var b={filter:this.getCurrentFilterKey(),oldest:this.oldest,oldestMR:this.oldestMR,last_seen_time:this.lastSeenTime,scroll_count:this.scrollLoadCount,scroll_position:this.scrollPosition,last_viewstate_id:this.lastViewStateID};b=merge(b,a);this.loadWithParams(b);};UIIntentionalStream.prototype.loadWithParams=function(a){var b=DOM.scry(this.root,'div.fbStreamPager.hasMorePosts')[0];if(b){if(CSS.hasClass(b,'async_saving'))return;CSS.addClass(b,'async_saving');}UIPagelet.loadFromEndpoint('MoreStoriesPagelet','home_stream',a,{usePipe:true,append:true});};UIIntentionalStream.prototype.setScrollLoadCount=function(a){this.maxScrollLoadCount=a;};UIIntentionalStream.prototype.loadMoreOnScroll=function(a,b,c){if(window.disableScrollLoad)return;var d=function(){if(window.disableScrollLoad)return;if(window.ArbiterMonitor){var g=user_action('scroll',null,null,'FORCE',{gt:{ua_id:'stream:scroll:auto'}});g.set_namespace('stream');ArbiterMonitor.initUA(g);}var h={delay_load_count:b};this.loadOlderPosts(h);}.bind(this),e=DOM.scry(this.root,'ul.uiStream li.genericStreamStory');if(!e.length)return;var f=e[e.length-a-1];if(f){this.currentScrollListener=new OnVisible(f,d,null,0,{detect_speed:this.scrollLoadCount>1});}else d();};UIIntentionalStream.prototype.updateTimeRange=function(a,b){if(!this.newest||this.newest<a)this.newest=a;if(!this.oldest||(b&&(b<this.oldest)))this.oldest=b;};UIIntentionalStream.prototype.updateOldestMR=function(a){if(!this.oldestMR||a<this.oldestMR)this.oldestMR=a;};UIIntentionalStream.prototype.updateScrollPosition=function(a){this.scrollPosition=a;};UIIntentionalStream.prototype.updateLastViewStateID=function(a){this.lastViewStateID=a;};UIIntentionalStream.prototype.getID=function(){return this.id;};UIIntentionalStream.prototype.getCurrentFilterKey=function(){if(this.currentFilterKey)return this.currentFilterKey;var a=URI.getMostRecentURI().getQueryData();if(a&&a.sk){this.currentFilterKey=a.sk;}else if(a&&a.filter){this.currentFilterKey=a.filter;}else if(this.defaultFilter)this.currentFilterKey=this.defaultFilter;return this.currentFilterKey;};UIIntentionalStream.prototype.resetFilterKey=function(a){this.currentFilterKey=a;};UIIntentionalStream.prototype.loadOlder=function(a){a=a||{};if(!this.oldest)return;var b=this.getCurrentParams();b.oldest=this.oldest;this.refresh(UIIntentionalStream.REFRESH_APPEND,b,a);return this;};UIIntentionalStream.prototype.loadNewer=function(a){if(!this.newest)return;a=a||{};var b=this.getCurrentParams();b.newest=this.newest;if(a.ignoreSelf)b.ignore_self=true;b.load_newer=true;var c=coalesce(a.insertType,UIIntentionalStream.REFRESH_PREPEND);this.refresh(c,b,a);return this;};UIIntentionalStream.prototype.expandRecentStories=function(){if(!this.shouldRenderCount)return;this.shouldRenderCount=false;var a=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer'),b=this.getCurrentParams();b.newest=this.newest;b.active_mode=true;b.pager_count=this.conowingoCount;if(this.conowingoNewest>this.newest)this.newest=this.conowingoNewest;var c=bagofholding,d=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');CSS.addClass(d,'async_saving');var e=a.childNodes.length;if(this.conowingoCount==e){c=function(){CSS.hide(d);this.shiftPrefetchStories();}.bind(this);}else if(this.conowingoCount>20){b.replace_pager=true;b.delay_load_count=20-e;}this.slideIn(a,d,c);this.refresh(UIIntentionalStream.REFRESH_BUBBLE,b,{});};UIIntentionalStream.prototype.showRecentStoriesPager=function(a){if(!a)return;this.verifyPagerStyling();animation(a).from('opacity',0).to('opacity',1).show().ondone(function(){Arbiter.inform('reflow');}).go();new AsyncSignal('ajax/feed/show_pager.php',{count:this.conowingoCount}).send();};UIIntentionalStream.prototype.verifyPagerStyling=function(){if(!this.shouldRenderCount)return;DOM.prependContent(this.streamContent,$N('li'));};UIIntentionalStream.prototype.slideIn=function(a,b,c){var d=a.parentNode,e=$N('div',{style:{marginTop:'-10000px'}},a),f=$N('div',{style:{overflow:'hidden'}},e);CSS.setStyle(e,'opacity',0);CSS.show(a);DOM.prependContent(d,f);var g=Vector2.getElementDimensions(e).y;CSS.setStyle(e,'marginTop','-'+g+'px');animation(b).from('opacity',1).to('opacity',0).ondone(function(){var h=b.offsetHeight;CSS.setStyle(e,'paddingBottom',h+'px');CSS.hide(b);animation(e).duration(1000).to('marginTop',0).to('paddingBottom',0).to('opacity',1).ease(animation.ease.both).ondone(function(){DOM.replace(f,a);c();}).go();}).go();};UIIntentionalStream.prototype.shiftPrefetchStories=function(){var a=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');if(!a.childNodes.length)return;DOM.prependContent(this.streamContent,$A(a.childNodes));CSS.hide(a);var b=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');CSS.removeClass(b,'async_saving');Arbiter.inform('reflow');};UIIntentionalStream.prototype.checkScroll=function(){if(this.scrollListener&&Vector2.getScrollPosition().y>0){new AsyncSignal('ajax/feed/scroll_detect.php').send();this.scrollListener.remove();this.scrollListener=null;}};UIIntentionalStream.prototype.getCurrentParams=function(){var a={},b=URI.getMostRecentURI().getQueryData();b.filter=this.getCurrentFilterKey();var c=this.getValidParams();if(c){c.forEach(function(d){a[d]=b[d];});}else a=b;return a;};UIIntentionalStream.prototype.setHomeFilter=function(a){this._homeFilter=a;};UIIntentionalStream.prototype.setHomeFilterLoading=function(a){if(this._homeFilter)this._homeFilter.setLoading(a);};UIIntentionalStream.prototype.setConowingoCount=function(a){this.conowingoCount=a;this.shouldRenderCount=!!this.conowingoCount;};UIIntentionalStream.prototype.setConowingoNewest=function(a){if(a>this.conowingoNewest)this.conowingoNewest=a;};UIIntentionalStream.prototype.updateRecentStoryCount=function(a){this.setConowingoCount(a);var b=DOM.find($('pagelet_home_stream'),'div.fbStreamRecentStoriesPager');if(this.shouldRenderCount){var c=DOM.find(b,'span.fbStreamRecentStoriesText'),d;if(this.conowingoCount==1){d=tx._("{count} \u6761\u65b0\u52a8\u6001",{count:a});}else if(a<=100){d=tx._("{count}\u4e2a\u65b0\u52a8\u6001",{count:a});}else d="\u8d85\u8fc7100\u518c\u65b0\u52a8\u6001";DOM.setContent(c,d);if(CSS.hasClass(b,'hidden_elem'))this.showRecentStoriesPager(b);}else CSS.hide(b);};UIIntentionalStream.prototype.updateRenderedStories=function(a){if(this.shouldRenderCount){var b=DOM.find($('pagelet_home_stream'),'ul.fbStreamRecentStoriesContainer');DOM.setContent(b,HTML(a));}};UIIntentionalStream.prototype.incrementTransitionalNux=function(a){if(this.incrementedTransitionalNux)return;this.incrementedTransitionalNux=true;var b='ajax/feed/nux/transitional_increment',c={location:a};new AsyncSignal(b,c).send();};UIIntentionalStream.prototype.refresh=function(a,b,c){Arbiter.inform(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME);this.currentFilterKey=b.filter;if(b.filter==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED){this.currentFilterKey=this.defaultFilter;}else if(UIIntentionalStream.isHighlightsFilter(b.filter)||b.filter===UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED)this.defaultFilter=this.currentFilterKey;c=c||{};var d=++this.requestNum,e=coalesce(c.showLoader,true),f=this.instanceName,g=function(k){UIIntentionalStream.getInstance(f).handleResponse(d,a,k,c);},h=function(k){UIIntentionalStream.getInstance(f).handleError(d,a,k,c);},i=function(k){UIIntentionalStream.getInstance(f).handleFinally(a,b.filter,k);};if(!(b.request_type=a))b.request_type='none';if(b.filter){c.show_hidden=b.show_hidden?b.show_hidden:false;}else c.show_hidden=this.shouldShowHidden;b=copy_properties(this.getCurrentParams(),b);this.hasPendingRefresh=true;var j;if(a==UIIntentionalStream.REFRESH_APPEND&&e)j=this.pager;new AsyncRequest().setURI(this.getEndpoint()).setReadOnly(true).setOption('retries',0).setMethod(this.getRefreshMethod()).setData(b).setHandler(g).setStatusElement(j).setErrorHandler(h).setFinallyHandler(i).send();if(a==UIIntentionalStream.REFRESH_TRANSITION){hide(this.pager);this.clearScrollLoader(true);this.oldest=this.newest=null;}if(e)this.setHomeFilterLoading(true);};UIIntentionalStream.prototype.addComposerContent=function(a,b){if(this.isOnNewsFeedFilter())CSS.addClass(a,'uiStreamBoulderHighlight');this.addContentPrepend(a,b);};UIIntentionalStream.prototype.addContentPrepend=function(a,b){if(a.length){$A(a).reverse().forEach(function(h){this.addContentPrepend(h,b);}.bind(this));return;}var c,d=Vector2.getScrollPosition().y,e=Vector2.getElementPosition(this.streamContent).y,f=this.scrollOnPrepend&&d>=e;if(f){var g=function(h){var i=DOM.find(h,'^li.uiStreamStory');if(!i)return;DataStore.set(i,'origHeight',i.offsetHeight);Event.listen(h,'load',function(){var j=DataStore.get(i,'origHeight');if(i.offsetHeight!=j){window.scrollBy(0,i.offsetHeight-j);DataStore.set(i,'origHeight',i.offsetHeight);}});};c=animation.insert.curry(this.streamContent,a,(function(h,i){DOM.prependContent(this.streamContent,i);Arbiter.inform('reflow');window.scrollBy(0,i.offsetHeight);DOM.scry(i,'img').forEach(g);}).bind(this));}else c=(function(){CSS.setStyle(a,'opacity',0);DOM.prependContent(this.streamContent,a);Arbiter.inform('reflow');animation(a).from('opacity',0).to('opacity',1).duration(400).go();}).bind(this);if(b){setTimeout(c,b);}else c();};UIIntentionalStream.prototype.addContentAppend=function(a){DOM.appendContent(this.streamContent,a);};UIIntentionalStream.getStoriesByAssoc=function(a){return DOM.scry(UIIntentionalStream.instance.root,'div.aid_'+a);};UIIntentionalStream.prototype.handleResponse=function(a,b,c,d){d=d||{};var e=c.getPayload();this.filterNullState&&DOM.remove(this.filterNullState);if(is_empty(e))return;if(e.autoRefreshConfig)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,e.autoRefreshConfig);this.setHomeFilterLoading(false);if(b==UIIntentionalStream.REFRESH_EXPAND){var f=DOM.find($(d.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.hide(f);CSS.removeClass(f,'UIIntentionalStory_CollapsedStoriesLoading');}if(this.error)hide(this.error);if(a!=this.requestNum)return;if('show_hidden' in d)this.shouldShowHidden=d.show_hidden;if('newestStoryTime' in e&&e.newestStoryTime>this.newest)this.newest=e.newestStoryTime;if('oldestStoryTime' in e&&(!this.oldest||e.oldestStoryTime<this.oldest))this.oldest=e.oldestStoryTime;if('conowingoCount' in e){this.updateRecentStoryCount(e.conowingoCount);if('conowingoHTML' in e)this.updateRenderedStories(e.conowingoHTML);if('conowingoNewest' in e)this.setConowingoNewest(e.conowingoNewest);}if(!e.html){if(b==UIIntentionalStream.REFRESH_BUBBLE){this.shiftPrefetchStories();Arbiter.inform(UIIntentionalStreamMessage.UPDATE_HTML_CONTENT);}}else{var g=HTML(e.html).getNodes();switch(b){case UIIntentionalStream.REFRESH_BUBBLE:if(e.replaceCurrentStories){DOM.empty(this.streamContent);this.scrollPosition=e.scrollPosition;this.lastViewStateID=e.lastViewStateID;this.oldest=e.oldestStoryTime;}this.addContentPrepend(g);this.shiftPrefetchStories();break;case UIIntentionalStream.REFRESH_COUNT:case UIIntentionalStream.REFRESH_PREPEND:this.addContentPrepend(g);break;case UIIntentionalStream.REFRESH_APPEND:this.addContentAppend(g);this.clearScrollLoader(true);break;case UIIntentionalStream.REFRESH_TRANSITION:DOM.setContent(this.streamContent,g);var h=this.streamContent.firstChild;if(!d.noScroll)DOMScroll.scrollTo(new Vector2(0,0,"document"),false);break;case UIIntentionalStream.REFRESH_EXPAND:DOM.insertAfter($(d.expandStoryID),g);break;case UIIntentionalStream.DELAYED_STREAM:this.addContentAppend(g);break;}this.verifyPagerStyling();Arbiter.inform(UIIntentionalStreamMessage.UPDATE_HTML_CONTENT);}};UIIntentionalStream.prototype.handleError=function(a,b,c,d){if(a!=this.requestNum)return;this.setHomeFilterLoading(false);var e=c.getError();if(e==1357001)AsyncResponse.defaultErrorHandler(c);if(b==UIIntentionalStream.REFRESH_EXPAND){var f=DOM.find($(d.expandStoryID),'div.UIIntentionalStory_CollapsedStories');CSS.removeClass(f,'UIIntentionalStory_CollapsedStoriesLoading');}if(!d.delayLoadCount&&b!=UIIntentionalStream.REFRESH_PREPEND&&this.error)CSS.setStyle(this.error,'display','block');};UIIntentionalStream.prototype.handleFinally=function(a,b){if(a==UIIntentionalStream.REFRESH_TRANSITION){PageTransitions.transitionComplete();Arbiter.inform(NavigationMessage.NAVIGATION_COMPLETED);}this.hasPendingRefresh=false;};UIIntentionalStream.prototype.getValidParams=function(){return UIIntentionalStream.VALID_PARAMS;};UIIntentionalStream.prototype.getEndpoint=function(){return UIIntentionalStream.ENDPOINT;};UIIntentionalStream.prototype.getRefreshMethod=function(){return UIIntentionalStream.REFRESH_METHOD;};UIIntentionalStream.prototype.isOnNewHighlights=function(){var a=this.getCurrentFilterKey();return (UIIntentionalStream.isHighlightsFilter(a)||(a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED&&UIIntentionalStream.isHighlightsFilter(this.defaultFilter)));};UIIntentionalStream.prototype.isLiveStreamBox=function(){var a=this.getCurrentFilterKey();return a&&a.indexOf(UIIntentionalStream.FEED_FILTER_KEY_LIVE_STREAM_BOX)==0;};UIIntentionalStream.prototype.isOnNewsFeedFilter=function(){var a=this.getCurrentFilterKey();return (a==UIIntentionalStream.FEED_FILTER_KEY_NEWS_FEED||UIIntentionalStream.isHighlightsFilter(a)||a==UIIntentionalStream.FEED_FILTER_KEY_DUAL_NEWS_FEED);};UIIntentionalStream.prototype.setupAutoInsert=function(){Arbiter.subscribe(UIIntentionalStreamMessage.SET_AUTO_INSERT,UIIntentionalStream.setAutoInsert);};UIIntentionalStream.setAutoInsert=function(a,b){if(a!=UIIntentionalStreamMessage.SET_AUTO_INSERT)return;var c=UIIntentionalStream.instance;if(c)c.pauseAutoInsert=b.pause;};UIIntentionalStream.prototype.isAutoRefreshPaused=function(){if(this.isOnNewHighlights()||this.isLiveStreamBox())return false;return this.pauseAutoInsert;};UIIntentionalStream.prototype.refreshStream=function(a,b){if(a!=UIIntentionalStreamMessage.REFRESH_STREAM)return;var c=this.getCurrentFilterKey();if(this.isOnNewsFeedFilter()&&b.shouldOverride)c=UIIntentionalStream.FEED_FILTER_KEY_NEW_HIGHLIGHTS;var d=UIIntentionalStream.isHighlightsFilter(c),e={filter:c};if(d)e.pending=d;var f={filter:c};b.noScroll&&(f.noScroll=1);this.refresh(UIIntentionalStream.REFRESH_TRANSITION,e,f);};copy_properties(UIIntentionalStream,{ANIMATION_DURATION:300,REFRESH_METHOD:'GET',REFRESH_TRANSITION:1,REFRESH_PREPEND:2,REFRESH_APPEND:3,REFRESH_COUNT:4,REFRESH_EXPAND:5,DELAYED_STREAM:6,REFRESH_BUBBLE:7,FEED_FILTER_KEY_NEW_HIGHLIGHTS:'h',FEED_FILTER_KEY_NEWS_FEED:'lf',FEED_FILTER_KEY_DUAL_NEWS_FEED:'nf',FEED_FILTER_KEY_LIVE_STREAM_BOX:'pub',VALID_PARAMS:['filter','show_hidden'],ENDPOINT:'ajax/intent.php'});
function UIIntentionalStreamRefresh(a,b){copy_properties(this,{isAutoRefreshing:false,lastRefresh:Date.now()});UIIntentionalStreamRefresh.instance=this;this.setAutoRefreshConfig(a);this.updateConfigHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG,this.updateAutoRefreshConfig.bind(this));this.updateRefreshTimeHandler=Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME,this.updateLastRefreshTime.bind(this));onleaveRegister(this.unload.bind(this));this.userActivity();this.uaToken=UserActivity.subscribe(this.userActivity.bind(this));this.autoRefreshInterval=setInterval(this.checkAutoPageRefresh.bind(this),this.checkAutoRefreshTimeInterval);this.activeRefreshInterval=setInterval(this.checkActiveRefresh.bind(this),this.checkActiveRefreshTimeInterval);this.enableAutoRefresh(b);Arbiter.subscribe(UIIntentionalStreamMessage.UPDATE_STREAM,LiveTimer.loop.bind(LiveTimer,true));Arbiter.subscribe(UIIntentionalStreamMessage.REFRESH_STREAM,LiveTimer.loop.bind(LiveTimer,true));if(this.usePresence)UIIntentionalStreamRefresh.presenceRegister();}copy_properties(UIIntentionalStreamRefresh,{_presenceInit:false,DISABLE_AUTOREFRESH_TIME:4*60*1000,CHECK_AUTOREFRESH_INTERVAL:5*60*1000,AUTOREFRESH_INACTIVE_TIME:30*60*1000,HIGHLIGHTS_OVERRIDE_TIME:360*60*1000,CHECK_ACTIVE_REFRESH_TIME:5*60*1000,ACTIVE_REFRESH_TIME:30*1000});UIIntentionalStreamRefresh.presenceRegister=function(){if(UIIntentionalStreamRefresh._presenceInit)return true;Arbiter.subscribe(PresenceMessage.getArbiterMessageType('feedpub'),UIIntentionalStreamRefresh.handleNewStoryMessage);UIIntentionalStreamRefresh._presenceInit=true;};UIIntentionalStreamRefresh.prototype.updateAutoRefreshConfig=function(a,b){if(a==UIIntentionalStreamMessage.UPDATE_AUTOREFRESH_CONFIG)this.setAutoRefreshConfig(b);};UIIntentionalStreamRefresh.prototype.updateLastRefreshTime=function(a){if(a==UIIntentionalStreamMessage.UPDATE_LAST_REFRESH_TIME)this.lastRefresh=Date.now();};UIIntentionalStreamRefresh.prototype.setAutoRefreshConfig=function(a){a=a||{};var b=24*60*60*1000;if(!this.storyInterval)this.storyInterval=coalesce(a.story_interval,null);this.allowAutoRefresh=coalesce(a.allow_auto_refresh,false);this.inactiveThreshold=coalesce(a.inactive_threshold,0);this.activeRefreshTime=coalesce(a.fast_refresh_rate,b);this.inactiveRefreshTime=coalesce(a.slow_refresh_rate,b);this.allowPolling=coalesce(a.allow_polling,false);this.refreshFactor=coalesce(a.refresh_factor,10);this.minRefreshInterval=coalesce(a.min_refresh_interval,60*1000);this.usePresence=coalesce(a.use_presence,false);this.activeRefresh=coalesce(a.active_refresh,false);this.checkActiveRefreshTimeInterval=coalesce(a.check_active_refresh_interval,UIIntentionalStreamRefresh.CHECK_ACTIVE_REFRESH_TIME);this.activeRefreshTimeInterval=coalesce(a.active_refresh_interval,UIIntentionalStreamRefresh.ACTIVE_REFRESH_TIME);this.disableAutoRefreshTime=coalesce(a.disable_autorefresh_time,UIIntentionalStreamRefresh.DISABLE_AUTOREFRESH_TIME);this.checkAutoRefreshTimeInterval=coalesce(a.check_autorefresh_time_interval,UIIntentionalStreamRefresh.CHECK_AUTOREFRESH_INTERVAL);this.autoRefreshInactiveTime=coalesce(a.autorefresh_inactive_time,UIIntentionalStreamRefresh.AUTOREFRESH_INACTIVE_TIME);this.highlightsOverrideTime=coalesce(a.highlights_override_time,UIIntentionalStreamRefresh.HIGHLIGHTS_OVERRIDE_TIME);return this;};UIIntentionalStreamRefresh.prototype.unload=function(){this.enableAutoRefresh(false);this.cleanupRefreshInterval();UserActivity.unsubscribe(this.uaToken);this.updateConfigHandler&&Arbiter.unsubscribe(this.updateConfigHandler);this.updateRefreshTimeHandler&&Arbiter.unsubscribe(this.updateRefreshTimeHandler);};UIIntentionalStreamRefresh.prototype.userActivity=function(){var a=this.isInactive();this.lastActivity=Date.now();this.isAutoRefreshing=true;if(a&&this.canAutoRefresh())this.runAutoRefresh();return true;};UIIntentionalStreamRefresh.prototype.isInactive=function(){return this.getMSSinceLastActivity()>this.inactiveThreshold;};UIIntentionalStreamRefresh.prototype.getMSSinceLastActivity=function(){return Date.now()-this.lastActivity;};UIIntentionalStreamRefresh.prototype.getMSSinceLastRefresh=function(){return Date.now()-this.lastRefresh;};UIIntentionalStreamRefresh.prototype.getRefreshInterval=function(){if(this.isInactive()){return this.inactiveRefreshTime;}else if(this.storyInterval!=null){var a=this.storyInterval*this.refreshFactor;return Math.max(a,this.activeRefreshTime);}else return this.activeRefreshTime;};UIIntentionalStreamRefresh.prototype.canAutoRefresh=function(){return this.isAutoRefreshing&&this.allowAutoRefresh;};UIIntentionalStreamRefresh.handleNewStoryMessage=function(a,b){if(a!=PresenceMessage.getArbiterMessageType('feedpub'))return;Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cancelUpdate=function(){if(this.updateTask){clearTimeout(this.updateTask);this.updateTask=null;}};UIIntentionalStreamRefresh.prototype.runUpdatePoll=function(){this.updateTask=null;if(this.canAutoRefresh())this.runAutoRefresh();};UIIntentionalStreamRefresh.prototype.runAutoRefresh=function(){var a=50;if(this.getMSSinceLastRefresh()>=this.minRefreshInterval-a)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);this.schedulePoll(this.getRefreshInterval());};UIIntentionalStreamRefresh.prototype.schedulePoll=function(a){this.cancelUpdate();if(this.allowPolling)this.updateTask=setTimeout(this.runUpdatePoll.bind(this),a);};UIIntentionalStreamRefresh.prototype.enableAutoRefresh=function(a,b){this.isAutoRefreshing=a;if(a){var c=b?0:this.getRefreshInterval();this.schedulePoll(c);}else this.cancelUpdate();};UIIntentionalStreamRefresh.prototype.checkAutoPageRefresh=function(){if(!this.allowAutoRefresh)return;if(this.isAutoRefreshing&&(this.getMSSinceLastActivity()>this.disableAutoRefreshTime))this.isAutoRefreshing=false;if(this.getMSSinceLastRefresh()<this.autoRefreshInactiveTime)return;var a=this.getMSSinceLastActivity();if(a>this.autoRefreshInactiveTime){var b=(a>this.highlightsOverrideTime);Arbiter.inform(UIIntentionalStreamMessage.REFRESH_STREAM,{shouldOverride:b});}};UIIntentionalStreamRefresh.prototype.checkActiveRefresh=function(){if(!this.allowAutoRefresh)return;if(this.getMSSinceLastRefresh()<this.activeRefreshTimeInterval)return;if(this.getMSSinceLastActivity()<this.activeRefreshTimeInterval)Arbiter.inform(UIIntentionalStreamMessage.UPDATE_STREAM);};UIIntentionalStreamRefresh.prototype.cleanupRefreshInterval=function(){if(this.autoRefreshInterval){clearInterval(this.autoRefreshInterval);this.autoRefreshInterval=null;}};