/*1328632323,169776065*/

if (window.CavalryLogger) { CavalryLogger.start_js(["R48il"]); }

function PhotoTagApproval(a){this.units=[];this.currentUnit=0;this._version=a;var b;if(a==PhotosConst.VIEWER_SNOWBOX){b=PhotoSnowbox.DATA_CHANGE;this._root=ge('fbPhotoSnowboxTagApproval');}else if(a==PhotosConst.VIEWER_SNOWLIFT){b=PhotoSnowlift.DATA_CHANGE;this._root=ge('fbPhotoSnowliftTagApproval');}else{b=PhotoPermalink.DATA_CHANGE;this._root=ge('fbPhotoPageTagApproval');}Arbiter.subscribe(b,this.restartTagApproval.bind(this));Event.listen(this._root,'click',this.handleClick.bind(this));Event.listen(this._root,'mousemove',function(c){this.hiliteCurrentPendingTag();Event.kill(c);}.bind(this));this.restartTagApproval();}PhotoTagApproval.prototype={handleClick:function(event){var a=event.getTarget();if(CSS.hasClass(a,'nextPager')&&CSS.hasClass(a,'enabled')){this.showNextUnit();}else if(CSS.hasClass(a,'prevPager')&&CSS.hasClass(a,'enabled')){this.showPrevUnit();}else if(Parent.byClass(a,'fbPhotoApprovalPendingButtons')){unit=this.units[this.currentUnit];var b=this.getTagNameID(unit);if(b){var c=Parent.byClass(a,'approve');Arbiter.inform('PhotoTagApproval.UPDATE_TAG_BOX',{id:b,approve:c,version:this._version});}this.removeSelectedUnit();}return true;},loadUnits:function(a){this.units=DOM.scry(this._root,'div.fbPhotoApprovalUnit');if(this.units.length){CSS.show(this._root);this.showUnit(a);CSS.conditionClass(this._root,'hidePagers',this.units.length==1);}else{CSS.hide(this._root);Arbiter.inform('PhotoTagApproval.HILITE_TAG',{tag:null,version:this._version});}},restartTagApproval:function(){this.loadUnits(0);},removeSelectedUnit:function(){var a=this.units[this.currentUnit];DOM.remove(a);this.loadUnits(this.currentUnit);},showNextUnit:function(){this.showUnit(this.currentUnit+1);},showPrevUnit:function(){this.showUnit(this.currentUnit-1);},getTagNameID:function(a){var b=a.id.indexOf(':');return a.id.slice(b+1);},showUnit:function(a){this.units.each(CSS.hide);this.currentUnit=(a+this.units.length)%this.units.length;var b=this.units[this.currentUnit];CSS.show(b);this.hiliteCurrentPendingTag();CSS.conditionClass(DOM.find(this._root,'a.prevPager'),'enabled',this.currentUnit>0);CSS.conditionClass(DOM.find(this._root,'a.nextPager'),'enabled',this.currentUnit<this.units.length-1);},hiliteCurrentPendingTag:function(){var a=this.units[this.currentUnit],b=this.getTagNameID(a);Arbiter.inform('PhotoTagApproval.HILITE_TAG',{tag:b,version:this._version});}};
var PhotoPermalink={PAGE:'PhotoPermalink.PAGE',DATA_CHANGE:'PhotoPermalink.DATA_CHANGE',STATE_ERROR:'error',STATE_HTML:'html',STATE_IMAGE_DATA:'image',MIN_TAG_DISTANCE:80,init:function(){this.stream=new PhotoStreamCache();this.stream.init(PhotosConst.VIEWER_PERMALINK);this.reset();this.root=$('fbPhotoPageContainer');this.header=$('fbPhotoPageHeader');this.stageWrapper=ge('photoborder');this.videoStage=DOM.find(this.stageWrapper,'div.videoStage');this.buttonActions=DOM.find(this.root,'div.stageButtons');this.feedback=ge('fbPhotoPageFeedback');this.image=ge('fbPhotoImage');this.errorBox=ge('fbPhotoPageError');this.actionList=ge('fbPhotoPageActions');this.loadingStates={image:false,html:false};this.unhiliteTimer=null;var a={mouseout:this.mouseOutListener.bind(this),mousemove:this.mouseMoveListener.bind(this)};this.pageHandlers=values(Event.listen(this.root,a));this.pageHandlers.push(Event.listen(this.stageWrapper,'click',this.stageClickListener.bind(this)),Event.listen(this.stageWrapper,'dragstart',this.killDrag.bind(this)),Event.listen(this.stageWrapper,'selectstart',this.killDrag.bind(this)),Event.listen(this.buttonActions,'click',this.buttonListener.bind(this)),Event.listen(this.actionList,'click',this.rotateListener.bind(this)),Event.listen(this.feedback,'click',function(event){if(Parent.byClass(event.getTarget(),'like_link'))CSS.toggleClass(DOM.find(this.buttonActions,'div.likeCommentGroup'),'viewerLikesThis');}.bind(this)));PageTransitions.registerHandler(this.transitionHandler.bind(this));KeyEventController.registerKey('LEFT',this.goNav.bind(this,'prev'));KeyEventController.registerKey('RIGHT',this.goNav.bind(this,'next'));PhotoSessionLog.initLogging(PhotoSessionLog.PERMALINK);Arbiter.subscribe('PhotoTagApproval.HILITE_TAG',this.onHiliteTag.bind(this));Arbiter.subscribe('PhotoTagApproval.UPDATE_TAG_BOX',this.onUpdateTagBox.bind(this));},getRoot:function(){return this.root;},updateTags:function(a){this.saveTagsFromPayload(a.getPayload());},saveTagsFromPayload:function(a){this.storeFromData(a);if('data' in a&&this.stream.getCursor() in a.data)this.swapData();},goNav:function(a,event){var b=Event.getKeyCode(event)||event.getTarget();if(this.theaterModeOn())return true;var c=Parent.byClass(b,'stageWrapper')&&!Parent.byClass(b,'tagBoxPending')&&!Parent.byClass(b,'tagBoxPendingResponse');if(c&&CSS.hasClass(this.root,'taggingMode'))return false;if(b==KEYS.LEFT||(c&&a=='prev')){this.page(-1);}else if(b==KEYS.RIGHT||(c&&a=='next'))this.page(1);return false;},theaterModeOn:function(){return CSS.hasClass(document.documentElement,'theaterMode');},pagerClick:function(a){if(this.theaterModeOn())return true;if(a=='prev'){this.page(-1);}else if(a=='next')this.page(1);return false;},setLoadingState:function(a,b){switch(a){case PhotoPermalink.STATE_IMAGE_DATA:this.loadingStates[a]=b;CSS.conditionClass(this.root,'imageLoading',b);break;case PhotoPermalink.STATE_HTML:this.loadingStates[a]=b;CSS.conditionClass(this.root,'dataLoading',b);break;}},checkState:function(a){if(a!=PhotoPermalink.STATE_ERROR&&!this.loadingStates[a])return;switch(a){case PhotoPermalink.STATE_IMAGE_DATA:var b=this.stream.getCurrentImageData();if(b){if(b.url){this.switchImage(b.url,true);}else if(b.video)this.switchVideo(b.video,true);this.setLoadingState(a,false);}break;case PhotoPermalink.STATE_HTML:if(this.stream.getCurrentHtml()){this.swapData();this.setLoadingState(a,false);}break;default:if(this.stream.errorInCurrent()){CSS.hide(this.image);CSS.show(this.errorBox);}break;}},reHilitePendingTag:function(){var a=ge(this.hilitedTag);if(a&&CSS.hasClass(a,'showPendingTagName'))return;var b=DOM.scry(this.root,'div.tagsWrapper div.showPendingTagName')[0];if(b)this.switchHilitedTags(b.id);},page:function(a){if(!this.stream.isValidMovement(a))return;this.unhiliteAllTags();var b=this.getVideoOnStage();if(b)this.switchVideo(b,false);Arbiter.inform(PhotoPermalink.PAGE);this.recacheData();this.stream.moveCursor(a);CSS.hide(this.image);if(this.stream.errorInCurrent()){this.setLoadingState(PhotoPermalink.STATE_HTML,true);CSS.show(this.errorBox);}else{var c=this.stream.getCurrentImageData();if(c){if(c.url){this.switchImage(c.url,true);}else if(c.video)this.switchVideo(c.video,true);goURI(c.info.permalink);}else{this.waitForLoadCount++;this.setLoadingState(PhotoPermalink.STATE_IMAGE_DATA,true);}if(this.stream.getCurrentHtml()){this.swapData();}else this.setLoadingState(PhotoPermalink.STATE_HTML,true);}},transitionHandler:function(a){if(a.getPath()=='photo.php')if(a.getQueryData().permPage){PageTransitions.transitionComplete();return true;}else if(!this.theaterModeOn()&&a.getQueryData().makeprofile&&a.getQueryData().fbid==this.stream.getCursor()&&!this.getVideoOnStage()){Bootloader.loadComponents(['photocrop2'],PhotoCropper.start.bind(PhotoCropper));PageTransitions.transitionComplete();return true;}},recacheData:function(a){if(!this.loadingStates.html){var b=this.stream.getCurrentHtml();for(var c in b){b[c]=$A($(c).childNodes);if(a!==true&&c!=='fbPhotoPageHeader')DOM.empty($(c));}}},getCurrentPhotoInfo:function(){var a=this.stream.getCurrentImageData();return a&&a.info;},getVideoOnStage:function(){var a=this.stream.getCurrentImageData();return a&&a.video;},switchImage:function(a,b){CSS.hide(this.image);CSS.hide(this.errorBox);var c=this.stream&&this.stream.getCurrentImageData();if(c)PhotoSessionLog.addPhotoView(c.info);var d=$N('img',{id:'fbPhotoImage',className:'fbPhotoImage',alt:'',src:a});DOM.replace(this.image,d);this.image=d;if(b)this.stream.preloadImages();},switchVideo:function(a,b){var c='swf_'+a;if(b){CSS.addClass(this.stageWrapper,'showVideo');this.videoStage.id=a;if(window[c]&&!ge(c))window[c].write(a);}else{this.videoStage.id='fbPageVideoStage';window[c].addVariable('video_autoplay',0);DOM.empty(this.videoStage);CSS.removeClass(this.stageWrapper,'showVideo');}},swapData:function(){if(this.dataLoadTimer){this.setLoadingState(PhotoPermalink.STATE_HTML,true);clearTimeout(this.dataLoadTimer);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,true),100);return;}var a,b=this.stream.getCurrentHtml();if(b){for(var c in b){a=ge(c);a&&DOM.setContent(a,b[c]);}var d=DOM.scry($('fbPhotoPageCaption'),'div.fbPhotoInlineCaptionEditor');if(d.length)new PhotoInlineCaptionEditor('permalink').init(d[0]);Arbiter.inform(PhotoPermalink.DATA_CHANGE,this.stream.getCurrentImageData().info,Arbiter.BEHAVIOR_STATE);this.position=this.stream.getCursor();this.setLoadingState(PhotoPermalink.STATE_HTML,false);this.dataLoadTimer=setTimeout(this.clearTimer.bind(this,false),100);}this.adjustForNewData();},clearTimer:function(a){this.dataLoadTimer=false;a&&this.swapData();},adjustForNewData:function(){if(!this.image)return;var a=DOM.scry(this.stageWrapper,'div.tagsWrapper')[0],b=Vector2.getElementDimensions(this.image);if(a){CSS.setStyle(a,'width',b.x+'px');CSS.setStyle(a,'height',b.y+'px');if(ua.ie()<=7){var c=DOM.scry(this.root,'div.tagContainer')[0];if(c)CSS.conditionClass(a,'ie7VerticalFix',Vector2.getElementDimensions(c).y>b.y);}}},fetchInitBucket:function(a){if(!this.stream.isLoaded())return;this.stream.fetch(a,true);},addPhotoFbids:function(a,b,c){var d=this.stream.getCursor()===null;this.stream.attachToFbidsList(a,b,c);if(c&&d)this.page(0);},storeFromResponse:function(a){this.storeFromData(a.getPayload());},storeFromData:function(a){var b=this.stream.storeToCache(a);if('init' in a){PhotoSessionLog.setPhotoSet(this.stream.getPhotoSet());PhotoSessionLog.setLogFbids(true);PhotoSessionLog.addPhotoView(this.stream.getCurrentImageData().info);}if('error' in b){this.checkState(PhotoPermalink.STATE_ERROR);return;}if('image' in b)this.checkState(PhotoPermalink.STATE_IMAGE_DATA);if('data' in b)this.checkState(PhotoPermalink.STATE_HTML);},setErrorBoxContent:function(a){DOM.setContent(this.errorBox,a);},updateTotalCount:function(a,b,c){element=ge('fbPhotoPagePositionAndCount');element&&DOM.setContent(element,c);this.stream.setTotalCount(a);this.stream.setFirstCursorIndex(b);},buttonListener:function(event){var a=event.getTarget();if(Parent.byClass(a,'likeButton')){DOM.find($('fbPhotoPageFeedback'),'button.like_link').click();}else if(Parent.byClass(a,'commentButton')){DOM.find(this.root,'div.commentBox textarea').focus();this.root.scrollTop=this.root.scrollHeight;}},rotateListener:function(event){var a=event.getTarget();if(Parent.byClass(a,'rotateRight')){this.rotate('right');}else if(Parent.byClass(a,'rotateLeft'))this.rotate('left');},stageClickListener:function(event){var a=event.getTarget();if(Parent.byClass(a,'fbPhotoTagApprovalBox')){return true;}else if(Parent.byClass(a,'videoStage')){return true;}else this.goNav('next',event);},rotate:function(a){var b=this.stream.getCursor();if(this.getVideoOnStage()){var c=(a=='left')?270:90;Bootloader.loadComponents(['video-rotate-viewer'],new VideoRotate(b,this.actionList).motionRotate(c));return;}var d={fbid:b,cs_ver:PhotosConst.VIEWER_PERMALINK,set:this.stream.getPhotoSet()};d[a]=1;this.setLoadingState(PhotoPermalink.STATE_IMAGE_DATA,true);CSS.hide(this.image);new AsyncRequest('ajax/photos/photo/rotate/default.htm').setMethod('POST').setAllowCrossPageTransition(true).setReadOnly(false).setData(d).setHandler(this.storeResponseForRotate.bind(this,b)).send();},storeResponseForRotate:function(a,b){this.storeFromResponse(b);var c=this.stream.getImageData(a);c.url=b.getPayload().new_urls[PhotosConst.SIZE_NORMAL];c.dimensions=Vector2.deserialize(b.getPayload().dimensions);if(a==this.stream.getCursor()){this.setLoadingState(PhotoPermalink.STATE_IMAGE_DATA,false);this.switchImage(this.stream.getCurrentImageData().url);this.swapData();}},mouseOutListener:function(event){var a=event.getTarget(),b=event.getRelatedTarget(),c=Parent.byClass(a,'stageActions'),d=Parent.byClass(a,'stageWrapper'),e=Parent.byClass(b,'stageActions'),f=Parent.byClass(b,'stageWrapper'),g=(!f&&(d&&!e)||(c&&!f));if(g)this.unhiliteAllTags(true);},mouseMoveListener:function(event){var a=event.getTarget();if(!Parent.byClass(a,'stageActions')&&!Parent.byClass(a,'stageWrapper'))return;this.hiliteTagsOnMouseMove(event);},unhiliteAllTags:function(a,event){DOM.scry(this.stageWrapper,'div.tagsWrapper div.hover').each(function(b){if(a&&CSS.hasClass(b,'tagBoxPending'))return;CSS.removeClass(b,'hover');});if(a)return;if(this.unhiliteTimer!==null){clearTimeout(this.unhiliteTimer);this.unhiliteTimer=null;}this.hilitedTag=null;},switchHilitedTags:function(a,b){this.unhiliteAllTags();var c=ge(a);if(c){this.hilitedTag=a;CSS.addClass(c,'hover');if(CSS.hasClass(c,'tagBoxPending')&&!CSS.hasClass(c,'showPendingTagName')&&b===true){DOM.scry(this.stageWrapper,'div.tagsWrapper div.showPendingTagName').each(function(d){CSS.removeClass(d,'showPendingTagName');});CSS.addClass(c,'showPendingTagName');}}},hiliteTagsOnMouseMove:function(event){if(!this.stream.getCurrentExtraData()||this.getVideoOnStage())return;if(this.unhiliteTimer!==null)return;var a=event.getTarget();if(Parent.byClass(a,'fbPhotoPageTagApproval'))return;var b=Parent.byClass(a,'tagBoxPending'),c=(this.hilitedTag&&CSS.hasClass($(this.hilitedTag),'tagBoxPending')),d=((!this.hilitedTag&&b)||(!c&&b));if(d){this.switchHilitedTags(b.id);return;}if(b&&(b.id==this.hilitedTag))return;var e=250,f=ge('fbPhotoImage'),g=Vector2.getEventPosition(event),h=Vector2.getElementPosition(f),i=Vector2.getElementDimensions(f),j=this.stream.getCurrentExtraData().tagRects,k=PhotosUtils.getNearestBox(g,h,i,1,PhotoPermalink.MIN_TAG_DISTANCE,j);if(!k){if(!c){this.unhiliteAllTags();this.reHilitePendingTag();}return;}var l=null;if(c){var m={};m[this.hilitedTag]=this.stream.getCurrentExtraData().tagRects[this.hilitedTag];l=PhotosUtils.getNearestBox(g,h,i,1,PhotoPermalink.MIN_TAG_DISTANCE,m);}if(l!==null&&c)return;if(this.hilitedTag!=k)if(c){this.unhiliteTimer=this.unhiliteAllTags.bind(this,false,event).defer(e);}else this.switchHilitedTags(k);},updateTagBox:function(a,b){this.unhiliteAllTags();var c=ge(a);if(!c)return;CSS.addClass(c,'tagBox');CSS.addClass(c,'tagBoxPendingResponse');CSS.removeClass(c,'tagBoxPending');CSS.hide(DOM.find(c,'span.tagForm'));if(b){CSS.show(DOM.find(c,'span.tagApproved'));}else CSS.show(DOM.find(c,'span.tagIgnored'));},killDrag:function(){if(CSS.hasClass(this.root,'taggingMode'))return false;},reset:function(){if(this.pageHandlers){this.pageHandlers.each(function(a){a.remove();});this.pageHandlers=null;}KeyEventController.getInstance().resetHandlers();},onHiliteTag:function(a,b){if(b.version!=PhotosConst.VIEWER_PERMALINK)return;id=b.tag;if(id){this.switchHilitedTags(id,true);}else this.unhiliteAllTags();},onUpdateTagBox:function(a,b){if(b.version==PhotosConst.VIEWER_PERMALINK)this.updateTagBox(b.id,b.approve);}};
var PhotoCropper={init:function(a,b){if(this.photocrop)this.destroy();this.root=a;this.options=b||{};this.actionLinks=DOM.find(this.root,'div.fbPhotosPhotoActions');var c=DOM.scry(this.actionLinks,'a.fbPhotoActionsCrop');if(c.length===0)return;var d=this.start.bind(this),e=DOM.find(c[0],'.startCropping');Event.listen(e,'click',function(){Bootloader.loadComponents('photocrop2',d);return false;});Arbiter.subscribe(PhotoPermalink.PAGE,this.destroy.bind(this),Arbiter.SUBSCRIBE_NEW);},start:function(){if(this.photocrop)return;this.cropLink=DOM.find(this.actionLinks,'a.fbPhotoActionsCrop');CSS.addClass(this.cropLink,'croppingModeOn');if(CSS.hasClass(this.cropLink,'profileAlbum')){this.reuseProfilePic.bind(this).defer();return false;}CSS.addClass(this.root,'croppingMode');var a=DOM.find(this.root,'img.fbPhotoImage'),b=DOM.find(this.root,'a.doneCroppingLink'),c=DOM.find(this.root,'a.cancelCroppingLink'),d=DOM.find(this.cropLink,'.doneCropping');this.wrapper=$N('div');CSS.addClass(this.wrapper,'stageCropper');DOM.find(this.root,'.stageWrapper').appendChild(this.wrapper);this.wrapper.style.marginTop=a.parentNode.style.marginTop;Event.listen(this.wrapper,'click',this.cancelAndStopEvent.bind(this));Event.listen(b,'click',this.done.bind(this));Event.listen(c,'click',this.cancelAndStopEvent.bind(this));Event.listen(d,'click',this.done.bind(this));var e={target:this.wrapper,min_width:this.options.min_width},f=(function(){this.photocrop=new Photocrop(a,e);}).bind(this);if(a.complete){f();}else Event.listen(a,'load',f);return false;},done:function(){var a=PhotoPermalink.getCurrentPhotoInfo(),b=this.getProfilePicTarget(a).id,c=this.destroy(),d=copy_properties({pid:a.pid,owner:a.owner,id:b,'return':'profile.php@id='+b,error_return:'photo.php@pid='+a.pid+'&id='+a.owner},c);Form.post('crop_profile_pic.php',d);return false;},cancelAndStopEvent:function(){this.destroy();return false;},destroy:function(){if(this.photocrop){CSS.removeClass(this.cropLink,'croppingModeOn');CSS.removeClass(this.root,'croppingMode');DOM.remove(this.wrapper);var a=this.photocrop.done();this.photocrop=null;return a;}},reuseProfilePic:function(){var a=PhotoPermalink.getCurrentPhotoInfo(),b=this.getProfilePicTarget(a),c=copy_properties({pid:a.pid,owner:a.owner,id:b.id,type:b.type,profile_pic_id:b.id});Form.post('pic_upload.php',c);return false;},getProfilePicTarget:function(a){if(CSS.hasClass(this.cropLink,'makePageProfile'))return {id:a.owner,type:'object'};return {id:this.options.uid,type:'profile'};}};
function PhotoPermalinkTagger(a,b){this.parent.construct(this,a);this.photoData=b;}Class.extend(PhotoPermalinkTagger,'PhotoTagger');copy_properties(PhotoPermalinkTagger.prototype,{elemNames:{0:{addTagLink:'div.fbPhotosPhotoActions',overlayActions:'div.fbPhotosPhotoButtons',tagboxContainer:'fbPhotoPageTagBoxes',tagAction:'fbPhotosPhotoActionsTag',image:'img#fbPhotoImage'}},userActionData:{action:'tagging',namespace:'photo_permalink'},setupHandlers:function(){var a=$('imagestage'),b=$('fbPhotoPageTagBoxes');this.handlers=[Event.listen(this.clickState,'click',this.addTag.bind(this)),Event.listen(a,'click',this.addTag.bind(this)),Event.listen(b,'click',this.addTag.bind(this)),Event.listen(this.addTagLink,'click',this.checkActions.bind(this)),Event.listen(this.overlayActions,'click',this.checkActions.bind(this))];this.subscriptions=[Arbiter.subscribe(PhotoPermalink.PAGE,this.restartTagging.bind(this)),Arbiter.subscribe(PhotoPermalink.DATA_CHANGE,this.setPhotoData.bind(this))];this.tokenizer.subscribe('addToken',this.saveTag.bind(this));this.tokenizer.subscribe('removeToken',this.removeTag.bind(this));this.tokenizer.subscribe('markTagAsSpam',this.markTagAsSpam.bind(this));},getTaggingSource:function(){return 'permalink';},getPosition:function(){return this.photoData.fbid;},getPhotoViewerObj:function(){return window.PhotoPermalink;},tagsChangeHandler:function(a){var b=this.getPhotoViewerObj();b&&b.updateTags(a);},setDataForTokenizer:function(){this.tokenizer.setup(null,this.photoData);return this;}});
function Photocrop(a,b){this.photo=a;copy_properties(this,copy_properties({target:this.photo.parentNode,width:200,height:200,min_width:100,min_height:100,center_x:(this.photo.offsetWidth||200)/2,center_y:(this.photo.offsetHeight||200)/2},b));var c=this.center_x-this.width/2,d=this.center_y-this.height/2;this.box=[d,c+this.width,d+this.height,c];CSS.addClass(this.target,'photocrop');['bg','wrapper','viewport'].each(function(e){this[e]=$N('div');CSS.addClass(this[e],e);}.bind(this));this.highlight=$N('img',{src:a.src});CSS.addClass(this.highlight,'highlight');this.target.appendChild(this.bg);this.target.appendChild(this.wrapper);this.wrapper.appendChild(this.highlight);this.wrapper.appendChild(this.viewport);['ne','nw','sw','se'].each(function(e){var f=$N('div');CSS.addClass(f,e);this.viewport.appendChild(f);}.bind(this));Event.listen(this.viewport,{mousedown:this.mousedown.bind(this),dragstart:Event.kill,selectstart:Event.kill,click:Event.stop});Event.listen(document,{mousemove:this.mousemove.bind(this),mouseup:this.mouseup.bind(this)});[this.bg,this.wrapper].each(function(e){e.style.width=a.offsetWidth+'px';e.style.height=a.offsetHeight+'px';e.style.top=a.offsetTop+'px';e.style.left=a.offsetLeft+'px';});this.redraw();}Photocrop.prototype.redraw=function(){this.highlight.style.clip="rect("+this.box.join("px ")+"px)";this.viewport.style.top=this.box[0]+"px";this.viewport.style.left=this.box[3]+"px";this.viewport.style.height=(this.box[2]-this.box[0])+"px";this.viewport.style.width=(this.box[1]-this.box[3])+"px";};Photocrop.prototype.done=function(){[this.bg,this.wrapper].each(DOM.remove);CSS.removeClass(this.target,'photocrop');var a=this.box.map(Math.round);return {x:Math.max(a[3],0),y:Math.max(a[0],0),width:a[1]-Math.max(a[3],0),height:a[2]-Math.max(a[0],0)};};Photocrop.prototype.mousedown=function(a){this.mouseTarget=a.getTarget();this.pos=Vector2.getEventPosition(a);CSS.addClass(document.body,'draggingMode');return false;};Photocrop.prototype.mousemove=function(a){if(!this.mouseTarget)return;var b=Vector2.getEventPosition(a).sub(this.pos);function c(i,j,k){return Math.max(i,Math.min(k,j));}var d=this.box,e=this.min_width,f=this.min_height,g=this.wrapper.offsetWidth,h=this.wrapper.offsetHeight;if(this.mouseTarget==this.viewport){b.x=c(-d[3],b.x,g-d[1]);b.y=c(-d[0],b.y,h-d[2]);d[0]+=b.y;d[1]+=b.x;d[2]+=b.y;d[3]+=b.x;}else if(CSS.hasClass(this.mouseTarget,'ne')){d[1]+=b.x=c(d[3]+e-d[1],b.x,g-d[1]);d[0]+=b.y=c(-d[0],b.y,d[2]-f-d[0]);}else if(CSS.hasClass(this.mouseTarget,'nw')){d[3]+=b.x=c(-d[3],b.x,d[1]-e-d[3]);d[0]+=b.y=c(-d[0],b.y,d[2]-f-d[0]);}else if(CSS.hasClass(this.mouseTarget,'se')){d[1]+=b.x=c(d[3]+e-d[1],b.x,g-d[1]);d[2]+=b.y=c(d[0]+f-d[2],b.y,h-d[2]);}else if(CSS.hasClass(this.mouseTarget,'sw')){d[3]+=b.x=c(-d[3],b.x,d[1]-e-d[3]);d[2]+=b.y=c(d[0]+f-d[2],b.y,h-d[2]);}this.redraw();this.pos=this.pos.add(b);return false;};Photocrop.prototype.mouseup=function(a){this.mouseTarget=null;CSS.removeClass(document.body,'draggingMode');};
function PhotoTags(a,b,c){this.tagTargets=a;this.tagBox=b;this.version=c||PhotosConst.VIEWER_PERMALINK;this.handlers=[];this.tagTargets.each(function(d){this.handlers.push(Event.listen(d,{mouseover:this.showTag.bind(this),mouseout:this.hideTags.bind(this)}));}.bind(this));this.subscriptions=[];if(this.version==PhotosConst.VIEWER_SNOWBOX)this.subscriptions.push(Arbiter.subscribe(PhotoSnowbox.PAGE,this.hideTags.bind(this)));}PhotoTags.prototype={showTag:function(event){var a=event.getTarget(),b=CSS.hasClass(a,'taggee'),c=CSS.hasClass(a,'uiProfilePhotoMedium'),d=null;if(b){d=a.getAttribute('data-tag');}else if(c){var e=Parent.byTag(a,'a');d=e&&e.getAttribute('data-tag');}var f=this.version==PhotosConst.VIEWER_PERMALINK?'perm:tag:'+d:'tag:'+d,g=f&&ge(f);if(g){CSS.addClass(g,'showTag');CSS.addClass(this.tagBox,'showingTag');}},hideTags:function(){CSS.removeClass(this.tagBox,'showingTag');DOM.scry(this.tagBox,'div.showTag').each(function(a){CSS.removeClass(a,'showTag');});},destroy:function(){for(var a in this.handlers)this.handlers[a].remove();this.subscriptions.each(Arbiter.unsubscribe.bind(Arbiter));}};
function TagToken(a){this.parent.construct(this,a,'tag');}Class.extend(TagToken,'Token');TagToken.prototype={createElement:function(){var a=this.isFreeform(),b=$N('span',{className:'separator'},', '),c=$N(a?'span':'a',{className:'taggee','data-tag':this.getValue()},this.getText());if(!a)c.href=this.getInfo().path;return $N('span',{className:'tagItem'},[b,c]);}};
function TagTokenizer(a,b,c,d){this.parent.construct(this,c,d);this.version=a;this.appphoto=b;var e;switch(this.version){case PhotosConst.VIEWER_PERMALINK:e="PhotoPermalink.DATA_CHANGE";break;case PhotosConst.VIEWER_SNOWBOX:e="PhotoSnowbox.DATA_CHANGE";break;case PhotosConst.VIEWER_SNOWLIFT:e="PhotoSnowlift.DATA_CHANGE";break;}Arbiter.subscribe(e,this.setup.bind(this),Arbiter.SUBSCRIBE_NEW);Arbiter.subscribe("CANCEL_INLINE_EDITING",this.updateTokenareaVisibility.bind(this),Arbiter.SUBSCRIBE_NEW);}Class.extend(TagTokenizer,'Tokenizer');TagTokenizer.prototype={setup:function(a,b){this.appphoto=b.byapp;this.byowner=b.isowner;return this.reset();},reset:function(){var a=this.getTokenElements().map(this.getTokenDataFromTag.bind(this));this.withTagKeys={};var b=this.getWithTagTokenElements().map(function(c){return this._tokenKey(this.getTokenDataFromTag(c));}.bind(this));this.withTagKeys=Object.from(b);Input.reset(this.input);return this.parent.reset(a);},processEvents:function(event,a,b){if(Parent.byClass(a,'remove')){var c=this.getTokenFromElement(b);c=this.addTokenData(c,a);this.removeToken(c);event.kill();}},insertToken:function(a){return null;},removeToken:function(a){if(this.appphoto){return this.replaceToken(a);}else{this.inform('removeToken',a);Arbiter.inform('Form/change',{node:this.element});}},addTokenData:function(a,b){if(Parent.byClass(b,'blockuser'))a.blockUser=true;return a;},getTokenDataFromTag:function(a){return {uid:DOM.find(a,'input').value,text:DOM.getText(DOM.find(a,'.taggee'))};},getTokenElementFromTarget:function(a){return Parent.byClass(a,'tagItem');},getTokenElements:function(){return DOM.scry(this.tokenarea,'span.tagItem').filter(this.filterNonTokenElements.bind(this));},getWithTagTokenElements:function(){return DOM.scry(this.tokenarea,'span.withTagItem');},filterNonTokenElements:function(a){return !CSS.hasClass(a,'markasspam')&&!CSS.hasClass(a,'reported')&&!CSS.hasClass(a,'withTagItem');},createToken:function(a,b){var c=this.getToken(this._tokenKey(a));c=c||new TagToken(a);b&&c.setElement(b);return c;},updateTokenareaVisibility:function(){visibleTokens=this.getTokenElements().filter(function(a){return CSS.shown(a);});withTagTokens=this.getWithTagTokenElements();CSS.conditionShow(this.tokenarea,visibleTokens.length!==0||withTagTokens.length!==0);},replaceToken:function(a){if(!a)return;var b=this.tokens.indexOf(a);if(b<0)return;this.tokens.splice(this.tokens.indexOf(a),1);delete this.unique[this._tokenKey(a.getInfo())];var c=ge('tagspam'+a.getValue());c&&DOM.remove(c);var d=[' [',"\u6807\u7b7e\u5df2\u5220\u9664\u3002",' '];d.push($N('a',{onclick:this.markAsSpam.bind(this,a.getValue())},"\u5c06\u6807\u7b7e\u6807\u8bb0\u4e3a\u5783\u573e\u90ae\u4ef6"));d.push('] ');var e=$N('span',{className:'fbPhotosTaglistTag tagItem markasspam',id:'tagspam'+a.getValue()},d);DOM.replace(a.getElement(),e);this.updateTokenarea();this.inform('removeToken',a);Arbiter.inform('Form/change',{node:this.element});},markAsSpam:function(a){var b=ge('tagspam'+a),c=[' [',"\u88ab\u4e3e\u62a5\u7684\u6807\u7b7e",'] '],d=$N('span',{className:'fbPhotosTaglistTag tagItem reported',id:'tagspam'+a},c);DOM.replace(b,d);this.inform('markTagAsSpam',a);}};
var share_last_comment={p:null,t:null};function share_internal_config(a){if(share_last_comment.p==a){a+='&c='+encodeURIComponent(share_last_comment.t?share_last_comment.t:'');}else share_last_comment.p=a;Bootloader.loadComponents(['async','dialog'],function(){var b=new AsyncRequest().setURI('/ajax/sharer/?'+a).setMethod('GET').setReadOnly(true),c=new Dialog().setAsync(b).setStackable(true).show();});return false;}
var StickyPlaceholderInput=(function(){var a=function(d){return Parent.byClass(d,'uiStickyPlaceholderInput');},b=function(d){return DOM.scry(d,'.placeholder')[0];},c=function(d){d=d||window.event;var e=d.target||d.srcElement;if(DOM.isNodeOfType(e,['input','textarea'])){var f=a(e);if(f){var g=d.type;(function(){if(g=='keydown'&&e.value.length)CSS.removeClass(f,'uiStickyPlaceholderEmptyInput');if((g=='blur'||g=='focusout')&&!e.value.length)CSS.addClass(f,'uiStickyPlaceholderEmptyInput');}).defer();}}};return {init:function(){StickyPlaceholderInput.init=bagofholding;Event.listen(document.documentElement,'keydown',c);if(document.documentElement.addEventListener){document.documentElement.addEventListener('blur',c,true);}else Event.listen(document.documentElement,'focusout',c);},registerInput:function(d){StickyPlaceholderInput.init();var e=d.getAttribute('placeholder')||'';if(e.length)if(document.activeElement===d){var f=Event.listen(d,'blur',function(){StickyPlaceholderInput.manipulateInput(d,e);f.remove();});}else StickyPlaceholderInput.manipulateInput(d,e);},manipulateInput:function(d,e){var f=$N('div',{className:'placeholder',ariaHidden:true},e),g=$N('div',{className:'uiStickyPlaceholderInput'},f);if(DOM.isNodeOfType(d,'textarea'))CSS.addClass(g,'uiStickyPlaceholderTextarea');Event.listen(f,'click',function(){d.focus();});if(d.value===e)d.value='';CSS.removeClass(d,'DOMControl_placeholder');d.setAttribute('placeholder','');DOM.replace(d,g);DOM.appendContent(g,d);CSS.conditionClass(g,'uiStickyPlaceholderEmptyInput',!d.value.length);},setPlaceholderText:function(d,e){var f=a(d),g=b(f);g&&DOM.setContent(g,e);},getPlaceholderText:function(d){var e=a(d),f=b(e);return f&&DOM.getText(f);},update:function(d){var e=a(d);if(e)CSS.conditionClass(e,'uiStickyPlaceholderEmptyInput',!d.value.length);},getVisibleText:function(d){var e=a(d);if(CSS.hasClass(e,'uiStickyPlaceholderEmptyInput')){var f=b(e);return f&&DOM.getText(f);}else return d.value;}};})();
add_properties('TokenizerBehaviors',{freeform:function(a,b){var c=b.tokenize_on_blur!==false,d=b.tokenize_on_paste!==false,e=b.matcher&&new RegExp(b.matcher,'i');function f(event){var g=Input.getValue(a.getInput()).trim();if(g&&(!e||e.test(g))){var h={uid:g,text:g,freeform:true};a.addToken(a.createToken(h));if(event){a.getTypeahead().getCore().afterSelect();event.kill();}}}a.subscribe('keydown',function(g,h){var event=h.event,i=Event.getKeyCode(event);if(i==KEYS.COMMA||i==KEYS.RETURN){var j=a.getTypeahead().getView();if(j.getSelection()){j.select();event.kill();}else f(event);}});a.subscribe('paste',function(g,h){if(d)f.bind(null,h.event).defer(20);});a.subscribe('blur',function(g,h){if(c)f();a.getTypeahead().getCore().reset();});}});
add_properties('TypeaheadBehaviors',{hintText:function(a){a.getCore().resetOnKeyup=false;}});
function VideoHistogram(){this.videos={};this.video_payloads={};this.listening=false;this.checking=false;}VideoHistogram.prototype.start=function(a){var b=document[a]||window[a];this.videos[a]=b;this.listening=true;};VideoHistogram.prototype.videoFinished=function(a,b){this.videos[a]=null;this.setPayload(a,b);this.updateServer();if(Dialog){var c=Dialog.getCurrent();if(c){var d=c.getButtonElement('collect-credits');d&&Button.setEnabled(d,true);}}};VideoHistogram.prototype.setPayload=function(a,b){this.video_payloads[a]=b;};VideoHistogram.prototype.updateServer=function(){var a=[];for(var b in this.video_payloads){var c=this.video_payloads[b];this.video_payloads[b]=null;if(c)a.push(c);}var d=JSON.stringify(a);new AsyncSignal('video/motion_log.php',{h:d}).send();this.listening=false;this.checking=false;};VideoHistogram.prototype.checkStatus=function(){if(this.listening){this.checking=true;for(var a in this.videos)if(this.videos[a].reportTime)this.videos[a].reportTime();this.updateServer();}};copy_properties(VideoHistogram,{init:function(){if(!window.video_histogram)window.video_histogram=new VideoHistogram();onbeforeunloadRegister(function(){if(!window.video_histogram.checking)window.video_histogram.checkStatus();});}});
var VideoPermalinkTagger={show:function(){CSS.removeClass($('tagger'),'tagger_inactive');$('tagger_input').focus();},hide:function(){CSS.addClass($('tagger'),'tagger_inactive');},setDataSource:function(a){VideoPermalinkTagger._datasource=a;},setExcluded:function(a,b){var c=VideoPermalinkTagger._datasource,d=c.getExclusions();a=parseInt(a,10);if(b===false){d.remove(a);}else if(!d.contains(a))d.push(a);c.setExclusions(d);}};function motion_rotate_video(a,b){new AsyncRequest().setURI('ajax/motion.php').setData({v:a,rotate:b}).setFinallyHandler(function(c){$('rotate_wait').style.display='none';$('rotate_links').style.display='';}).send();$('rotate_links').style.display='none';$('rotate_wait').style.display='';}